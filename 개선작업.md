# 🔧 AI 트레이딩봇 프로세스 개선 작업

**작업 시작**: 2025-10-24
**목표**: AI자동편입 → CIO → Process2 프로세스 연계 개선

---

## 📋 발견된 문제점 요약

### 🔴 문제 1: AI자동편입이 불필요한 코인 재검증
- **현상**: 이미 CIO가 관리 중인 "활성", "재평가" 코인도 매번 검증
- **영향**: API 비용 낭비, 검증 시간 증가, 역할 혼란
- **원인**: AI자동편입이 holding_status 조회 안 함

### 🔴 문제 2: AI자동편입 결과가 CIO에 전달 안 됨
- **현상**: AI가 MNT 1순위 선정했는데 CIO가 인지 못 함
- **영향**: VERIFIED 코인 부당 제외, 시스템 신뢰도 하락
- **원인**: AI 결과가 CIO 프롬프트에 포함 안 됨

### 🔴 문제 3: CIO가 VERIFIED 코인 존중 원칙 위반
- **현상**: MNT (VERIFIED, Sharpe 6.47, 120일선 +41%)를 0% 배정
- **영향**: 기회비용 발생, 명세서 규칙 위반
- **원인**: CIO 프롬프트에 예외 조건 체크리스트 없음

### 🔴 문제 4: CIO ↔ Process2 데이터 동기화 실패
- **현상**: CIO가 MNT 0% 결정 → Process2는 10% 수신
- **영향**: 전략 일관성 파괴, 잘못된 매매 판단
- **원인**: DB 업데이트 대기 시간 없음

---

## 💡 해결 방안 (우선순위 순)

### ✅ Fix 1: AI자동편입에서 활성+재평가 코인 제외 **(유저 아이디어)**

**목표**: AI는 신규 발굴에만 집중, CIO 관리 중인 코인 제외

**수정 파일**:
- `supabase_adapter.py`: `get_managed_coin_symbols()` 함수 추가
- `ai_strategy/auto_entry.py`: 제외 로직 추가

**핵심 로직**:
```python
# holding_status에서 "활성" + "재평가" 조회
managed = WHERE 관리상태 IN ('활성', '재평가')
candidates = all_coins - managed
```

**체크리스트**:
- [x] `supabase_adapter.py`에 `get_managed_coin_symbols()` 함수 추가 ✅ (Line 714-742)
- [x] `data_manager/universe.py`의 `get_dynamic_universe()`에서 함수 호출 ✅ (Line 356-367)
- [x] 로그에 "CIO 관리 중 X개 제외" 메시지 출력 ✅
- [ ] 테스트: AI자동편입 실행 시 제외 로직 동작 확인

**예상 효과**:
- API 비용 2.5% 절감
- 검증 시간 10초 단축
- 역할 명확화

---

### ✅ Fix 2: CIO ↔ Process2 동기화 보장

**목표**: CIO 결과가 Process2에 정확히 전달됨을 보장

**수정 파일**:
- `main.py` 또는 `trading_cycle.py`
- `supabase_adapter.py`: `verify_cio_db_sync()` 함수 추가

**핵심 로직**:
```python
cio_result = run_cio()
verify_cio_db_sync()  # DB 업데이트 확인
time.sleep(2)  # Supabase 커밋 대기
process2_result = run_process2()
```

**체크리스트**:
- [ ] `verify_cio_db_sync()` 함수 구현
- [ ] CIO 실행 후 `time.sleep(2)` 추가
- [ ] CIO timestamp 검증 로직 추가
- [ ] 로그에 "CIO 결과 최신성 확인" 메시지 출력
- [ ] 테스트: CIO 0% → Process2 0% 수신 확인

**예상 효과**:
- 데이터 불일치 100% 해소
- 전략 일관성 보장

---

### ✅ Fix 3: CIO 프롬프트에 VERIFIED 체크리스트 추가

**목표**: VERIFIED 코인 0% 배정 전 예외 조건 강제 검증

**수정 파일**:
- `ai_strategy/prompts.py`: `get_cio_prompt()` 함수

**추가 내용**:
```markdown
## ⚠️ VERIFIED 코인 0% 배정 전 필수 체크리스트

- [ ] 조건1: MA120 -5% 이상 이탈
- [ ] 조건2: 추세 붕괴 (MACD 데드크로스 + RSI ≤30)
- [ ] 조건3: 현금 부족 (< 100,000원)

→ 3개 중 1개 이상 충족 시에만 0% 가능
```

**체크리스트**:
- [ ] `ai_strategy/prompts.py`에 체크리스트 섹션 추가
- [ ] rationale 필수 형식 명시
- [ ] 테스트: VERIFIED 코인 0% 시 예외 조건 검증 확인

**예상 효과**:
- VERIFIED 부당 제외 90% 감소
- 명세서 규칙 준수

---

### ✅ Fix 4: AI→CIO 데이터 파이프라인 구축

**목표**: AI 선정 결과를 holding_status + CIO 프롬프트에 반영

**수정 파일**:
- `supabase_adapter.py`: `update_holding_status_from_ai_selection()` 함수
- `ai_strategy/prompts.py`: CIO 프롬프트에 AI 정보 섹션 추가
- `main.py`: AI 실행 후 즉시 호출

**핵심 로직**:
```python
# 1. AI 실행
ai_result = run_ai_auto_entry()

# 2. holding_status 자동 업데이트
for coin in ai_result['final_selection']:
    UPDATE holding_status SET 관리상태='활성', AI선정순위=rank

# 3. CIO에 AI 정보 전달
cio_result = run_cio(ai_selection_info=ai_result)
```

**체크리스트**:
- [ ] `update_holding_status_from_ai_selection()` 함수 구현
- [ ] CIO 프롬프트에 "AI자동편입 최신 결과" 섹션 추가
- [ ] `main.py`에서 함수 호출
- [ ] 테스트: AI 3개 선정 → CIO 프롬프트에 반영 확인

**예상 효과**:
- AI-CIO 연계 완성
- CIO가 AI 판단 존중

---

## 🗺️ 작업 진행 순서

### Phase 1: Critical Fixes (오늘 완료)
1. ✅ Fix 1: AI 제외 로직 (30분)
2. ✅ Fix 2: CIO-Process2 동기화 (30분)
3. ⏸️ 중간 테스트 (15분)

### Phase 2: System Integration (내일 완료)
4. ✅ Fix 3: VERIFIED 체크리스트 (1시간)
5. ✅ Fix 4: AI-CIO 파이프라인 (2시간)
6. ⏸️ 통합 테스트 (30분)

### Phase 3: Finalization (모레 완료)
7. ✅ README 업데이트
8. ✅ 트레이딩봇_수정이력.md 업데이트
9. ✅ 개선작업.md 삭제

---

## 📝 작업 상태 추적

### ✅ 완료된 작업
- [x] 종합검증보고서.md 작성
- [x] 개선작업.md 작성 (현재 파일)

### 🔄 진행 중
- [ ] Fix 1 구현 중...

### ⏳ 대기 중
- [ ] Fix 2
- [ ] Fix 3
- [ ] Fix 4
- [ ] 테스트
- [ ] 문서화

---

## 🧪 테스트 시나리오

### Test 1: AI 제외 로직
```python
# Given
holding_status:
  - SOL: 활성
  - PUNDIX: 재평가
  - MNT: 제외

# When
ai_result = run_ai_auto_entry()

# Then
검증 대상에 MNT 포함 ✅
검증 대상에 SOL, PUNDIX 미포함 ✅
로그: "CIO 관리 중 2개 제외" ✅
```

### Test 2: CIO-Process2 동기화
```python
# Given
AI가 MNT 1순위 선정

# When
cio_result = run_cio()
# CIO가 MNT 목표 8% 결정

# Then
holding_status.GPT보유비중 = 8% ✅
Process2가 받은 목표 = 8% ✅
로그: "CIO 결과 최신성 확인: 2초 전" ✅
```

### Test 3: VERIFIED 체크리스트
```python
# Given
MNT: VERIFIED, Sharpe 6.47, 120일선 +41%

# When
cio_result = run_cio()

# Then
rationale에 예외 조건 검증 포함 ✅
  - 조건1: 미충족 (120일선 +41%)
  - 조건2: 미충족 (RSI 49.1)
  - 조건3: 미충족 (잔고 2,692,332원)
목표 비중 ≥ 5% ✅
```

### Test 4: AI-CIO 파이프라인
```python
# Given
AI가 MNT, ENA, LA 선정

# When
update_holding_status_from_ai_selection(ai_result)

# Then
holding_status:
  - MNT: 활성, AI선정순위=1
  - ENA: 활성, AI선정순위=2
  - LA: 활성, AI선정순위=3

CIO 프롬프트에 포함:
  "1순위: MNT - VERIFIED, Sharpe 6.47" ✅
```

---

## ⚠️ 주의사항

### 백업 필수
```bash
# 수정 전 필수 백업
cp ai_strategy/auto_entry.py ai_strategy/auto_entry.py.backup
cp ai_strategy/prompts.py ai_strategy/prompts.py.backup
cp supabase_adapter.py supabase_adapter.py.backup
cp main.py main.py.backup
```

### 롤백 방법
```bash
# 문제 발생 시
mv ai_strategy/auto_entry.py.backup ai_strategy/auto_entry.py
mv ai_strategy/prompts.py.backup ai_strategy/prompts.py
mv supabase_adapter.py.backup supabase_adapter.py
mv main.py.backup main.py
```

### Git 커밋 전략
```bash
# 각 Fix마다 별도 커밋
git add supabase_adapter.py ai_strategy/auto_entry.py
git commit -m "fix: AI자동편입에서 활성+재평가 코인 제외 (유저 아이디어)"

git add main.py supabase_adapter.py
git commit -m "fix: CIO-Process2 동기화 보장 (time.sleep + 검증)"

git add ai_strategy/prompts.py
git commit -m "fix: CIO 프롬프트에 VERIFIED 체크리스트 추가"

git add supabase_adapter.py ai_strategy/prompts.py main.py
git commit -m "feat: AI-CIO 데이터 파이프라인 구축"
```

---

## 📊 예상 개선 효과

| 지표 | Before | After | 개선율 |
|------|--------|-------|--------|
| API 비용 | 100% | 97.5% | -2.5% |
| 검증 시간 | 40초 | 30초 | -25% |
| 데이터 불일치 | 10% | 0% | -100% |
| VERIFIED 부당 제외 | 30% | 3% | -90% |
| 월 예상 손실 | 200,000원 | 40,000원 | -80% |

**총 예상 효과**: 월 160,000원 손실 방지 + 운영 안정성 향상

---

## 🔗 관련 문서

- [종합검증보고서.md](docs/종합검증보고서.md)
- [AI자동편입_명세서.md](docs/dev_guide/AI자동편입_명세서.md)
- [CIO비중_명세서.md](docs/dev_guide/CIO비중_명세서.md)
- [매매판단_명세서.md](docs/dev_guide/매매판단_명세서.md)

---

## ✅ 완료 조건

### Fix 1 완료
- [x] 코드 수정 완료 ✅
  - supabase_adapter.py: get_managed_coin_symbols() 함수 추가 (Line 714-742)
  - data_manager/universe.py: 제외 로직 추가 (Line 356-367)
- [ ] 로그 확인 (AI자동편입 실행 시 확인 필요)
- [ ] Test 1 통과
- [ ] Git 커밋

### Fix 2 완료
- [ ] 코드 수정 완료
- [ ] 로그 확인
- [ ] Test 2 통과
- [ ] Git 커밋

### Fix 3 완료
- [ ] 코드 수정 완료
- [ ] 프롬프트 확인
- [ ] Test 3 통과
- [ ] Git 커밋

### Fix 4 완료
- [ ] 코드 수정 완료
- [ ] 로그 확인
- [ ] Test 4 통과
- [ ] Git 커밋

### 전체 완료
- [ ] 모든 Fix 완료
- [ ] 통합 테스트 통과
- [ ] README 업데이트
- [ ] 트레이딩봇_수정이력.md 업데이트
- [ ] 개선작업.md 삭제
- [ ] 최종 Git 푸시

---

**다음 단계**: Fix 1 구현 시작
**현재 상태**: ✅ 준비 완료, 작업 대기 중
