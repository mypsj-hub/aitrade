/**
 * CIO ì „ëµì‹¤ í…Œì´ë¸” ì»´í¬ë„ŒíŠ¸
 *
 * ëª©ì : cio_portfolio_decisions í…Œì´ë¸”ì˜ ëª¨ë“  í•„ë“œë¥¼ í‘œì‹œí•˜ëŠ” ì¢…í•© í…Œì´ë¸”
 *
 * ì£¼ìš” ê¸°ëŠ¥:
 * - íƒ­ UI (í™œì„±, ì¬í‰ê°€, ì œì™¸, ì „ì²´)
 * - ì •ë ¬ ê¸°ëŠ¥ (ëª¨ë“  ì»¬ëŸ¼)
 * - ì½”ì¸ í´ë¦­ ì‹œ ìƒì„¸ íŒ¨ë„ í‘œì‹œ
 * - ëª¨ë°”ì¼ ë°˜ì‘í˜• (ì¹´ë“œí˜• ë ˆì´ì•„ì›ƒ)
 *
 * Props:
 * - selectedDate: Date - ì¡°íšŒí•  ë‚ ì§œ
 * - onCoinClick: (decision: CIODecision) => void - ì½”ì¸ í´ë¦­ ì½œë°±
 *
 * ë°ì´í„° ì†ŒìŠ¤: cio_portfolio_decisions í…Œì´ë¸”
 */

'use client';

import { useCIODecisions, type CIODecision } from '@/lib/hooks/useCIODecisions';
import { useState, useMemo } from 'react';
import { format } from 'date-fns';
import { ko } from 'date-fns/locale';

interface Props {
  selectedDate?: Date;
  onCoinClick?: (decision: CIODecision) => void;
}

type TabType = 'ì „ì²´' | 'í™œì„±' | 'ì¬í‰ê°€' | 'ì œì™¸';
type SortKey = keyof CIODecision;
type SortDirection = 'asc' | 'desc';

export function CIODecisionsTable({ selectedDate, onCoinClick }: Props) {
  const { decisions, isLoading, error } = useCIODecisions(selectedDate);
  const [sortKey, setSortKey] = useState<SortKey>('ê²°ì •ì‹œê°');
  const [sortDirection, setSortDirection] = useState<SortDirection>('desc');

  // ì½”ì¸ë³„ ìµœì‹  ê²°ì •ë§Œ ì¶”ì¶œ + í™œì„± ìƒíƒœë§Œ í•„í„°ë§
  const latestDecisions = useMemo(() => {
    const decisionsMap = new Map<string, CIODecision>();

    for (const decision of decisions) {
      const existing = decisionsMap.get(decision.ì½”ì¸ì´ë¦„);

      if (!existing || decision.ê²°ì •ì‹œê° > existing.ê²°ì •ì‹œê°) {
        decisionsMap.set(decision.ì½”ì¸ì´ë¦„, decision);
      }
    }

    // í™œì„± ìƒíƒœë§Œ í•„í„°ë§
    return Array.from(decisionsMap.values()).filter((d) => {
      const status = d.ê´€ë¦¬ìƒíƒœ?.toUpperCase();
      return status === 'ACTIVE' || status === 'í™œì„±';
    });
  }, [decisions]);

  // íƒ­ë³„ í•„í„°ë§ ì œê±° (í™œì„±ë§Œ í‘œì‹œí•˜ë¯€ë¡œ ë¶ˆí•„ìš”)
  const filteredDecisions = latestDecisions;

  // ì •ë ¬
  const sortedDecisions = useMemo(() => {
    const sorted = [...filteredDecisions];

    sorted.sort((a, b) => {
      const aVal = a[sortKey];
      const bVal = b[sortKey];

      // null/undefined ì²˜ë¦¬
      if (aVal == null && bVal == null) return 0;
      if (aVal == null) return 1;
      if (bVal == null) return -1;

      // ìˆ«ì ë¹„êµ
      if (typeof aVal === 'number' && typeof bVal === 'number') {
        return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
      }

      // ë¬¸ìì—´ ë¹„êµ
      const aStr = String(aVal);
      const bStr = String(bVal);
      const comparison = aStr.localeCompare(bStr, 'ko');
      return sortDirection === 'asc' ? comparison : -comparison;
    });

    return sorted;
  }, [filteredDecisions, sortKey, sortDirection]);

  // ì •ë ¬ í•¸ë“¤ëŸ¬
  const handleSort = (key: SortKey) => {
    if (sortKey === key) {
      setSortDirection((prev) => (prev === 'asc' ? 'desc' : 'asc'));
    } else {
      setSortKey(key);
      setSortDirection('desc');
    }
  };

  // ë¡œë”©/ì—ëŸ¬ ìƒíƒœ
  if (isLoading) {
    return (
      <div className="bg-white rounded-lg shadow-lg p-6">
        <div className="flex items-center justify-center py-12">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          <span className="ml-3 text-slate-600">ë¡œë”© ì¤‘...</span>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="bg-white rounded-lg shadow-lg p-6">
        <div className="text-red-600 text-center py-12">
          âš ï¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: {error.message}
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white rounded-lg shadow-lg p-6">
      {/* í—¤ë” */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
        <h2 className="text-xl font-bold text-slate-800 mb-4 sm:mb-0">
          ğŸ“Š CIO ì˜ì‚¬ê²°ì • í˜„í™© (í™œì„± ì½”ì¸)
        </h2>
        <div className="text-sm text-slate-500">
          ì´ {sortedDecisions.length}ê°œ ì½”ì¸
        </div>
      </div>

      {/* ë°ìŠ¤í¬í†±: í…Œì´ë¸” ë·° */}
      <div className="hidden lg:block overflow-x-auto">
        <table className="w-full text-sm">
          <thead className="bg-slate-50 border-b-2 border-slate-200">
            <tr>
              {/* ì£¼ìš” ì»¬ëŸ¼ */}
              <SortableHeader title="ì½”ì¸" sortKey="ì½”ì¸ì´ë¦„" currentKey={sortKey} direction={sortDirection} onSort={handleSort} />
              <SortableHeader title="ê²°ì •ì‹œê°" sortKey="ê²°ì •ì‹œê°" currentKey={sortKey} direction={sortDirection} onSort={handleSort} />
              <SortableHeader title="ê´€ë¦¬ìƒíƒœ" sortKey="ê´€ë¦¬ìƒíƒœ" currentKey={sortKey} direction={sortDirection} onSort={handleSort} />
              <SortableHeader title="ëª©í‘œë¹„ì¤‘" sortKey="ëª©í‘œë¹„ì¤‘" currentKey={sortKey} direction={sortDirection} onSort={handleSort} />
              <SortableHeader title="í˜„ì¬ë¹„ì¤‘" sortKey="í˜„ì¬ë³´ìœ ë¹„ì¤‘" currentKey={sortKey} direction={sortDirection} onSort={handleSort} />
              <SortableHeader title="ë¹„ì¤‘ë³€í™”" sortKey="ë¹„ì¤‘ë³€í™”ëŸ‰" currentKey={sortKey} direction={sortDirection} onSort={handleSort} />
            </tr>
          </thead>
          <tbody>
            {sortedDecisions.map((decision, index) => (
              <tr
                key={`${decision.ì½”ì¸ì´ë¦„}-${decision.ê²°ì •ì‹œê°}-${index}`}
                className="border-b border-slate-100 hover:bg-slate-50 cursor-pointer transition-colors"
                onClick={() => onCoinClick?.(decision)}
              >
                <td className="px-4 py-3 font-bold text-slate-900">{decision.ì½”ì¸ì´ë¦„}</td>
                <td className="px-4 py-3 text-slate-600">
                  {format(new Date(decision.ê²°ì •ì‹œê°), 'HH:mm:ss', { locale: ko })}
                </td>
                <td className="px-4 py-3">
                  <StatusBadge status={decision.ê´€ë¦¬ìƒíƒœ} />
                </td>
                <td className="px-4 py-3 font-semibold text-blue-600">
                  {decision.ëª©í‘œë¹„ì¤‘?.toFixed(1)}%
                </td>
                <td className="px-4 py-3 text-slate-600">
                  {decision.í˜„ì¬ë³´ìœ ë¹„ì¤‘?.toFixed(1)}%
                </td>
                <td className="px-4 py-3">
                  <WeightChange value={decision.ë¹„ì¤‘ë³€í™”ëŸ‰} />
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* ëª¨ë°”ì¼: ì¹´ë“œ ë·° */}
      <div className="lg:hidden space-y-4">
        {sortedDecisions.map((decision, index) => (
          <div
            key={`${decision.ì½”ì¸ì´ë¦„}-${decision.ê²°ì •ì‹œê°}-${index}`}
            className="border border-slate-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer"
            onClick={() => onCoinClick?.(decision)}
          >
            {/* ì¹´ë“œ í—¤ë” */}
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-lg font-bold text-slate-900">{decision.ì½”ì¸ì´ë¦„}</h3>
              <StatusBadge status={decision.ê´€ë¦¬ìƒíƒœ} />
            </div>

            {/* ì‹œê°„ */}
            <div className="text-xs text-slate-500 mb-3">
              {format(new Date(decision.ê²°ì •ì‹œê°), 'PPP HH:mm:ss', { locale: ko })}
            </div>

            {/* ë¹„ì¤‘ ì •ë³´ */}
            <div className="grid grid-cols-2 gap-3 mb-3">
              <div>
                <div className="text-xs text-slate-500">ëª©í‘œ ë¹„ì¤‘</div>
                <div className="text-lg font-bold text-blue-600">
                  {decision.ëª©í‘œë¹„ì¤‘?.toFixed(1)}%
                </div>
              </div>
              <div>
                <div className="text-xs text-slate-500">í˜„ì¬ ë¹„ì¤‘</div>
                <div className="text-lg font-semibold text-slate-700">
                  {decision.í˜„ì¬ë³´ìœ ë¹„ì¤‘?.toFixed(1)}%
                </div>
              </div>
            </div>

            {/* ì¶”ê°€ ì •ë³´ */}
            {decision.ë¹„ì¤‘ë³€í™”ëŸ‰ != null && (
              <div className="flex items-center space-x-1 text-xs">
                <span className="text-slate-500">ë¹„ì¤‘ ë³€í™”:</span>
                <WeightChange value={decision.ë¹„ì¤‘ë³€í™”ëŸ‰} />
              </div>
            )}
          </div>
        ))}
      </div>

      {/* ë¹ˆ ìƒíƒœ */}
      {sortedDecisions.length === 0 && (
        <div className="text-center py-12 text-slate-500">
          í•´ë‹¹ í•„í„°ì— ë§ëŠ” ê²°ì •ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
      )}
    </div>
  );
}

/**
 * ì •ë ¬ ê°€ëŠ¥í•œ í…Œì´ë¸” í—¤ë”
 */
interface SortableHeaderProps {
  title: string;
  sortKey: SortKey;
  currentKey: SortKey;
  direction: SortDirection;
  onSort: (key: SortKey) => void;
}

function SortableHeader({ title, sortKey, currentKey, direction, onSort }: SortableHeaderProps) {
  const isActive = sortKey === currentKey;

  return (
    <th
      className="px-4 py-3 text-left font-semibold text-slate-700 cursor-pointer hover:bg-slate-100 transition-colors"
      onClick={() => onSort(sortKey)}
    >
      <div className="flex items-center space-x-1">
        <span>{title}</span>
        {isActive && (
          <span className="text-blue-600">
            {direction === 'asc' ? 'â–²' : 'â–¼'}
          </span>
        )}
      </div>
    </th>
  );
}

/**
 * ê´€ë¦¬ ìƒíƒœ ë°°ì§€
 */
function StatusBadge({ status }: { status: string }) {
  const normalized = status?.toUpperCase();

  let bgColor = 'bg-slate-100';
  let textColor = 'text-slate-700';

  if (normalized === 'ACTIVE' || normalized === 'í™œì„±') {
    bgColor = 'bg-green-100';
    textColor = 'text-green-700';
  } else if (normalized === 'REVIEW' || normalized === 'ì¬í‰ê°€') {
    bgColor = 'bg-yellow-100';
    textColor = 'text-yellow-700';
  } else if (normalized === 'EXCLUDED' || normalized === 'ì œì™¸') {
    bgColor = 'bg-red-100';
    textColor = 'text-red-700';
  }

  return (
    <span className={`px-2 py-1 rounded-full text-xs font-semibold ${bgColor} ${textColor}`}>
      {status}
    </span>
  );
}

/**
 * ë¹„ì¤‘ ë³€í™”ëŸ‰ í‘œì‹œ
 */
function WeightChange({ value }: { value?: number | null }) {
  if (value == null) return <span className="text-slate-400">-</span>;

  const color = value >= 0 ? 'text-green-600' : 'text-red-600';
  const prefix = value > 0 ? '+' : '';

  return (
    <span className={`font-semibold ${color}`}>
      {prefix}
      {value.toFixed(1)}%p
    </span>
  );
}
