# CIO 구현 중 발생한 버그 수정 완료 보고서

> **📅 작성일**: 2025-10-27
> **🎯 목적**: CIO 포트폴리오 결정 이력 추적 시스템 구현 중 발견된 버그 수정 내역
> **📦 관련 작업**: CIO_DECISION_TABLE_IMPLEMENTATION.md Phase 4-6

---

## 📋 목차

1. [수정 완료된 버그 요약](#1-수정-완료된-버그-요약)
2. [Bug #1: KRW-KRW-SOL 중복 접두사](#2-bug-1-krw-krw-sol-중복-접두사)
3. [Bug #5: 3-4순위 코인 미등록](#3-bug-5-3-4순위-코인-미등록)
4. [기타 수정된 버그들](#4-기타-수정된-버그들)
5. [검증 체크리스트](#5-검증-체크리스트)

---

## 1. 수정 완료된 버그 요약

| 번호 | 버그명 | 심각도 | 상태 | 수정 파일 |
|------|--------|--------|------|-----------|
| #1 | KRW-KRW-SOL 중복 접두사 | 🔴 HIGH | ✅ 수정완료 | ai_strategy/cio.py:2663 |
| #2 | market_cache 속성 접근 오류 | 🟡 MEDIUM | ✅ 수정완료 | ai_strategy/cio.py:2576-2581 |
| #3 | emergency_coins 스코프 오류 | 🟡 MEDIUM | ✅ 수정완료 | ai_strategy/cio.py:1351, 2433 |
| #4 | analysis_target_coins 변수명 | 🟢 LOW | ✅ 수정완료 | ai_strategy/cio.py:2611 |
| #5 | 3-4순위 코인 미등록 | 🔴 HIGH | ✅ 수정완료 | ai_strategy/market_analysis.py:1259-1275 |

---

## 2. Bug #1: KRW-KRW-SOL 중복 접두사

### 🔴 문제 현상

```
ERROR: [KRW-KRW-SOL-minute60] data retrieval failed
ERROR: [KRW-KRW-SOL-day] data retrieval failed
```

### 🔍 근본 원인 분석

**데이터 흐름 추적**:

1. **AI 응답** (정상):
   ```json
   {"asset": "SOL", "weight": 20.0}
   ```

2. **targets dict** (정상):
   ```python
   targets = {"SOL": {...}, "KAITO": {...}}
   ```

3. **cio.py Line 2617-2625** (정상):
   ```python
   for symbol, target_info in targets.items():  # symbol = "SOL"
       # 심볼 정규화
       ticker_symbol = symbol if symbol.startswith('KRW-') else f"KRW-{symbol}"
       clean_symbol = symbol.replace('KRW-', '') if symbol.startswith('KRW-') else symbol
   ```
   - `ticker_symbol = "KRW-SOL"` (정상)
   - `clean_symbol = "SOL"` (정상)

4. **cio.py Line 2662-2663** (❌ 문제 발생):
   ```python
   # BEFORE (잘못된 코드)
   ticker_symbol = symbol if symbol.startswith('KRW-') else f"KRW-{symbol}"
   indicators = get_technical_indicators(ticker_symbol)  # "KRW-SOL" 전달
   ```

5. **ohlcv.py Line 195** (중복 추가):
   ```python
   def get_technical_indicators(symbol: str, interval: str = "minute60"):
       ticker = f"KRW-{symbol}"  # "KRW-SOL" → "KRW-KRW-SOL" ❌
   ```

### ✅ 해결 방법

**파일**: [ai_strategy/cio.py:2661-2663](c:\gptbitcoin4\ai_strategy\cio.py#L2661-L2663)

```python
# AFTER (수정된 코드)
# get_technical_indicators는 내부에서 "KRW-" 접두사를 추가하므로
# clean_symbol (KRW- 제거된 심볼)을 전달해야 함
indicators = get_technical_indicators(clean_symbol)  # "SOL" 전달
```

### 📊 영향 범위

- ✅ **cio.py Line 1730**: 이미 정상 (coin.symbol은 clean symbol)
- ✅ **다른 모듈 호환성**: get_technical_indicators 시그니처 변경 없음
- ⏳ **검증 필요**: 다음 실행 시 KRW-KRW- 에러 발생 여부 확인

---

## 3. Bug #5: 3-4순위 코인 미등록 (추가 수정)

### 🔴 문제 현상 (2차 발견)

**실행 로그**:
```
💡 CIO 코멘트: VANA는 3순위로 선정되어...
✅ 퀀트 선택 수정: ['FLOCK', 'WLFI']
✅ 최종 검증 완료: 2개 선정
```

**DB 확인**: coin_watch_history에 VANA 없음 ❌

### 🔍 근본 원인 분석 (2차)

**1차 수정으로 해결된 부분**:
- AI의 `ranking` 필드에서 3-4순위 정보 추출 ✅
- `final_selection = ["FLOCK", "ENA", "VANA"]` (3개) 생성 ✅

**2차 문제 발견**:
- **"1-2순위 퀀트 검증" 로직**이 3-4순위를 삭제함!

**데이터 흐름 추적**:

1. **AI 선택** (Line 1259-1275):
   ```python
   final_selection = ["FLOCK", "ENA", "VANA"]  # 3개
   ```

2. **Sharpe 순위** (Line 1277-1281):
   - WLFI: 13.36 (1위)
   - TOSHI: 13.02 (2위)
   - ENA: 6.96 (3위)
   - FLOCK: 6.08 (4위)

3. **퀀트 검증 로직** (Line 1450-1473):
   ```python
   ai_pick = "FLOCK"  # final_selection[0]
   quant_pick = "ENA"  # final_selection[1]
   top_sharpe = "WLFI"

   # 경우 2 조건: quant_pick != top_sharpe and ai_pick != top_sharpe
   # "ENA" != "WLFI" and "FLOCK" != "WLFI" → True!

   # BEFORE (문제 코드)
   final_selection = [ai_pick, top_sharpe]  # ["FLOCK", "WLFI"]
   # ❌ VANA (3순위) 완전 소실!
   ```

4. **universe.py로 전달**: `["FLOCK", "WLFI"]` (2개만)
5. **3순위 등록 실패**: `top_4_coins[2:4]` → 빈 리스트

### ✅ 해결 방법 (2차 수정)

**파일**: [ai_strategy/market_analysis.py:1450-1515](c:\gptbitcoin4\ai_strategy\market_analysis.py#L1450-L1515)

#### 수정 1: 퀀트 검증 시 3-4순위 보존

```python
# [Fix] 3-4순위 보존을 위해 별도 저장
remaining_ranks = final_selection[2:] if len(final_selection) > 2 else []

# 경우 1: AI와 퀀트가 동일한 코인 선택 (중복)
if ai_pick == quant_pick:
    new_quant = second_sharpe if second_sharpe != ai_pick else (...)
    final_selection = [ai_pick, new_quant] + remaining_ranks  # ← 3-4순위 복원

# 경우 2: 퀀트 선택이 Sharpe 1위가 아님
elif quant_pick != top_sharpe and ai_pick != top_sharpe:
    final_selection = [ai_pick, top_sharpe] + remaining_ranks  # ← 3-4순위 복원

# 경우 3: AI가 Sharpe 1위를 선택 (중복)
elif ai_pick == top_sharpe and quant_pick == top_sharpe:
    final_selection = [ai_pick, second_sharpe] + remaining_ranks  # ← 3-4순위 복원
```

#### 수정 2: 중복 제거 로직 개선

```python
# [Fix] 순서 보존하면서 중복 제거
unique_selection = []
seen = set()
for symbol in final_selection:
    if symbol not in seen:
        unique_selection.append(symbol)
        seen.add(symbol)

if len(unique_selection) < len(final_selection):
    # 1-2순위만 체크하여 중복 제거 및 교체
    if len(unique_selection) == 1 and len(candidates) > 1:
        duplicated_coin = unique_selection[0]
        remaining_ranks_dup = unique_selection[1:]
        # 중복 교체 시에도 3-4순위 보존
        final_selection = [duplicated_coin, new_coin] + remaining_ranks_dup
```

### 📊 수정 후 예상 흐름

1. AI 선택: `["FLOCK", "ENA", "VANA"]` (3개)
2. `remaining_ranks = ["VANA"]` 별도 저장 ✅
3. 퀀트 검증: `["FLOCK", "WLFI"] + ["VANA"]` = `["FLOCK", "WLFI", "VANA"]` ✅
4. universe.py 전달: 3개 ✅
5. `top_4_coins[2:4]` = VANA ✅
6. coin_watch_history에 VANA(3순위) 등록 ✅

---

## 3-1. Bug #5: 3-4순위 코인 미등록 (1차 발견)

### 🔴 문제 현상 (1차)

**로그 분석**:
```
✅ 퀀트 선택 수정: ['VIRTUAL', 'WLFI']
✅ 최종 검증 완료: 2개 선정
💡 CIO 코멘트: 1-2순위 VIRTUAL/WLFI는 즉시 매수 활성,
               3순위 FLOCK은 관심 종목으로, 4순위 PROVE는 관심 종목으로
```

**DB 확인**:
- coin_watch_history 테이블: FLOCK, PROVE 없음 ❌
- holding_status 테이블: VIRTUAL, WLFI만 존재 ✅

### 🔍 근본 원인 분석

**데이터 흐름 추적**:

1. **AI 응답 JSON**:
   ```json
   {
     "ranking": [
       {"rank": 1, "symbol": "VIRTUAL", "reason": "..."},
       {"rank": 2, "symbol": "WLFI", "reason": "..."},
       {"rank": 3, "symbol": "FLOCK", "reason": "..."},
       {"rank": 4, "symbol": "PROVE", "reason": "..."}
     ],
     "final_selection": ["VIRTUAL", "WLFI"],
     "portfolio_comment": "1-2순위 VIRTUAL/WLFI는 즉시 매수 활성, 3순위 FLOCK은 관심 종목으로, 4순위 PROVE는 관심 종목으로"
   }
   ```

2. **market_analysis.py Line 1259** (❌ 문제):
   ```python
   # BEFORE
   final_selection = result.get("final_selection", [])  # ["VIRTUAL", "WLFI"] (2개만)
   # ranking 필드는 무시됨!
   ```

3. **market_analysis.py Line 1532**:
   ```python
   return final_selection  # ["VIRTUAL", "WLFI"] 반환
   ```

4. **universe.py Line 666**:
   ```python
   final_candidates = passed_phase3  # 2개만 받음
   ```

5. **universe.py Line 675**:
   ```python
   top_4_coins = final_candidates[:4]  # 2개만 존재
   ```

6. **universe.py Line 718** (❌ 3-4순위 등록 실패):
   ```python
   for i, candidate in enumerate(top_4_coins[2:4], start=3):  # 빈 리스트!
       # 이 루프가 실행되지 않음
   ```

### ✅ 해결 방법

**파일**: [ai_strategy/market_analysis.py:1259-1275](c:\gptbitcoin4\ai_strategy\market_analysis.py#L1259-L1275)

```python
# [Fix] ranking 필드에서 전체 순위 정보를 추출하여 3-4순위 보존
ranking = result.get("ranking", [])
final_selection = result.get("final_selection", [])

# ranking 필드가 있고 final_selection보다 많은 경우, ranking 순서를 우선 사용
if ranking and len(ranking) > len(final_selection):
    ranked_symbols = [r.get("symbol") for r in ranking if r.get("symbol")]
    logger.info(f"📊 AI ranking 필드 발견: {len(ranking)}개 순위 정보 (final_selection: {len(final_selection)}개)")
    logger.info(f"   ranking 순서: {ranked_symbols}")

    # ranking의 symbol들이 candidates에 모두 존재하는지 확인
    candidate_symbols = {c['symbol'] for c in candidates}
    valid_ranked = [s for s in ranked_symbols if s in candidate_symbols]

    if len(valid_ranked) > len(final_selection):
        logger.info(f"✅ ranking 필드 우선 사용: {valid_ranked} ({len(valid_ranked)}개)")
        final_selection = valid_ranked
    else:
        logger.warning(f"⚠️ ranking 검증 실패, final_selection 사용: {final_selection}")
```

### 📊 수정 후 예상 흐름

1. AI 응답에서 `ranking` 4개, `final_selection` 2개 감지
2. `ranked_symbols = ["VIRTUAL", "WLFI", "FLOCK", "PROVE"]` 추출
3. candidates 검증 통과
4. `final_selection = ["VIRTUAL", "WLFI", "FLOCK", "PROVE"]` (4개로 확장)
5. `top_4_coins = final_candidates[:4]` (4개 존재)
6. `top_4_coins[2:4]` = FLOCK, PROVE
7. coin_watch_history에 FLOCK(3순위), PROVE(4순위) 등록 ✅

### 📊 영향 범위

- ⏳ **ALTERNATIVE 티어 검증**: 4개 코인에 대해 정상 작동 확인 필요
- ⏳ **1-2순위 퀀트 검증**: Line 1435-1469의 로직 영향 없는지 확인
- ⏳ **중복 제거 로직**: Line 1471-1487 정상 작동 확인 필요

---

## 4. 기타 수정된 버그들

### Bug #2: market_cache 속성 접근 오류

**에러**:
```
'MarketDataCache' object has no attribute 'get_fear_greed_index'
```

**수정**: [cio.py:2576-2581](c:\gptbitcoin4\ai_strategy\cio.py#L2576-L2581)
```python
# BEFORE
fear_greed_index = market_cache.get_fear_greed_index()
btc_dominance = market_cache.get_btc_dominance()

# AFTER
fear_greed_data = market_cache.fear_greed_index or {}
fear_greed_index = fear_greed_data.get('data', {}).get('value') if fear_greed_data.get('status') == 'success' else None

btc_dom_data = market_cache.btc_dominance or {}
btc_dominance = btc_dom_data.get('data') if btc_dom_data.get('status') == 'success' else None
```

---

### Bug #3: emergency_coins 스코프 오류

**에러**:
```
name 'emergency_coins' is not defined
```

**수정**:
1. 함수 시그니처 [cio.py:2433](c:\gptbitcoin4\ai_strategy\cio.py#L2433)
2. 호출부 [cio.py:1351](c:\gptbitcoin4\ai_strategy\cio.py#L1351)

```python
def _finalize_and_log_weights(
    ai_result: Dict,
    analyzed_coins: List[CoinConfig],
    watchlist_coins: List[Dict] = None,
    emergency_coins: List[Dict] = None  # ← 추가
)

# 호출
return _finalize_and_log_weights(result, analysis_target_coins, watchlist_coins, emergency_coins)
```

---

### Bug #4: analysis_target_coins 변수명 오류

**에러**: Pylance warning
```
"analysis_target_coins" is not defined
```

**수정**: [cio.py:2611](c:\gptbitcoin4\ai_strategy\cio.py#L2611)
```python
# BEFORE
for coin in analysis_target_coins:

# AFTER
for coin in analyzed_coins:
```

---

## 5. 검증 체크리스트

### ✅ 즉시 검증 가능

- [x] 모든 코드 수정 완료
- [x] 구현 문서 업데이트 완료
- [x] 파일 경로 및 라인 번호 정확성 확인

### ⏳ 실행 후 검증 필요

#### Bug #1: KRW-KRW-SOL
- [ ] 로그에서 `[KRW-KRW-*]` 에러 사라짐
- [ ] `get_technical_indicators` 정상 호출 (debug 로그 확인)
- [ ] cio_portfolio_decisions 테이블에 기술지표 정상 저장

#### Bug #5: 3-4순위 코인
- [ ] 로그에서 "📊 AI ranking 필드 발견" 메시지 확인
- [ ] `final_selection` 4개로 확장 확인
- [ ] coin_watch_history에 3-4순위 등록 확인:
  ```sql
  SELECT symbol, rank, funnel_type, score, created_at
  FROM coin_watch_history
  WHERE created_at > NOW() - INTERVAL '1 hour'
  ORDER BY rank;
  ```

#### 통합 검증
- [ ] CIO 실행 시 에러 없이 완료
- [ ] cio_portfolio_decisions 테이블에 데이터 정상 저장
- [ ] holding_status에 1-2순위 정상 등록
- [ ] coin_watch_history에 3-4순위 정상 등록
- [ ] CIO 프롬프트에 이전 결정 이력 포함 확인

---

## 📌 관련 파일

### 수정된 파일
- `ai_strategy/cio.py` (Line 1351, 2433, 2576-2581, 2611, 2663)
- `ai_strategy/market_analysis.py` (Line 1259-1275)

### 참조 파일 (수정 없음)
- `data_manager/ohlcv.py` (Line 195 - 참조만)
- `data_manager/universe.py` (Line 666, 675, 718 - 참조만)

### 문서 파일
- `docs/CIO_DECISION_TABLE_IMPLEMENTATION.md` (Section 9 추가)
- `docs/BUG_FIXES_20251027.md` (신규 생성)

---

**END OF DOCUMENT**
