# CIO 포트폴리오 비중 프롬프트 명세서

> **📅 최초 작성**: 2025-10-24
> **📅 최종 업데이트**: 2025-10-27
> **📦 버전**: v1.6
> **🔗 실제 프롬프트 위치**:
> - `ai_strategy/prompts/cio_defensive.txt` (Fear & Greed < 45)
> - `ai_strategy/prompts/cio_neutral.txt` (45 ≤ F&G ≤ 55)
> - `ai_strategy/prompts/cio_aggressive.txt` (F&G > 55)
> - `ai_strategy/prompts/cio_base_rules.txt` (공통 규칙)
> - `ai_strategy/cio.py` (CIO 로직 및 프롬프트 생성)

---

## 📋 목차

1. [핵심 철학](#1-핵심-철학)
2. [판단 원칙 (우선순위)](#2-판단-원칙-우선순위)
3. [특수 규칙](#3-특수-규칙)
4. [시나리오 라이브러리](#4-시나리오-라이브러리)
5. [금지 사항](#5-금지-사항)
6. [검증 체크리스트](#6-검증-체크리스트)
7. [수정 이력](#7-수정-이력)

---

## 1. 핵심 철학

> **"CIO의 일관성 = 시스템의 신뢰성"**

### 1.1 근본 원칙

- ✅ **데이터 기반 자율 판단**: 맥락 전체를 종합하여 스스로 결정
- ✅ **명시적 규칙 최소화**: "X이면 무조건 Y" 같은 기계적 규칙 지양
- ✅ **일관성 유지**: 동일한 시장 상황에서 동일한 판단

### 1.2 CIO의 역할

**CIO (Chief Investment Officer)**는:
- 포트폴리오 **전체 관점**에서 목표 비중 설정
- 목표 수익률, 손절률 설정
- **실행은 하지 않음** (Process2의 역할)

### 1.3 README.md와의 일관성

이 명세서는 [README.md](../../README.md)의 "핵심 철학"을 구체화한 것입니다:
> AI 트레이딩 봇은 데이터 기반 자율 판단 시스템이며, 규칙 기반 결정 트리가 아닙니다.

---

## 2. 판단 원칙 (우선순위)

### 2.1 비중 설정 시 고려 요소 (우선순위)

CIO가 목표 비중을 설정할 때 다음 순서로 고려합니다:

#### **1순위: 120일 이동평균선 (MA120) 지지 여부**
- MA120 위 → 장기 상승 추세 유지
- MA120 아래 → 장기 하락 추세

**판단 기준**:
- MA120 위 +5% 이상 → 강력한 지지
- MA120 위 0~5% → 지지 확인
- MA120 -5% 이내 → 주의 관찰
- MA120 -5% 이하 → 손절 고려

#### **2순위: MACD, RSI 추세**
- MACD 상승 전환 → 모멘텀 증가
- RSI 과매수/과매도 확인

**판단 기준**:
- 일봉 MACD > 4시간 MACD > 1시간 MACD (장기 추세 우선)
- RSI 70+ → 과열 주의
- RSI 30- → 과매도 기회

#### **3순위: Fear & Greed Index 기반 페르소나**
- Fear (0-44) → Risk Guardian (방어적)
- Neutral (45-55) → Balanced Analyst (균형)
- Greed (56-100) → Alpha Predator (공격적)

#### **4순위: 시가총액 및 섹터**
- 메가캡 (Layer-1) → Core 포지션
- 미드캡 → Growth 포지션
- 스몰캡 → Satellite 포지션 (고위험)

#### **5순위: 유동성 등급**
- A등급 → 제약 없음
- B등급 → 15% 상한
- C/D등급 → **참고만** (강제 제외 금지)

**⚠️ 중요**: 유동성 등급은 **참고 사항**일 뿐, 절대적 기준이 아님

---

### 2.2 페르소나별 전략

| 페르소나 | Fear & Greed | 현금 비중 | 개별 코인 상한 | 전략 철학 |
|---------|--------------|---------|--------------|---------|
| **Risk Guardian** | 0-44 | 60-70% (변동성↑ → 80%+) | 15% (메가캡 예외 20%) | 손실 최소화, 질문 기반 신규 평가 ⭐ |
| **Balanced Analyst** | 45-55 | 40-50% (변동성↑ → 60%) | 20% (메가캡 예외 25%) | 균형 잡힌 접근, 동등 평가 |
| **Alpha Predator** | 56-100 | 20-30% (과열 70+ → 40%) | 30% (모든 자산) | 수익 극대화, 진입 기본 자세 |

**[개선 2025-10-25]**: 페르소나별 차별화 규칙 강화
- 변동성 연동 현금 비중 조정 (3단계 시스템)
- 신규 편입 평가 접근 차별화 (질문형/동등/적극)
- 상관관계 관리 기준 차별화 (0.7+/0.8+/0.9+)

---

## 3. 특수 규칙

### 3.1 AI 자동편입 코인 존중 원칙 ⭐ (최우선 규칙)

> **[신규 추가 2025-10-24]** | **[개선 2025-10-25]**: AI 모드 전용 분리
>
> AI 자동편입이 선정한 코인은 **듀얼 퍼널 + 백테스팅 + AI 면접**을 통과한 검증된 유망주입니다.

#### 3.1.1 적용 범위 (중요!)

**VERIFIED 체크리스트는 AI 자동편입 모드에서만 적용됩니다**:
- ✅ **AI 자동편입 모드**: main.py에서 `ai_selection_info` 파라미터가 전달될 때
- ❌ **긴급도 호출**: Process1에서 급등/급락 감지 시
- ❌ **정기 호출**: 하루 3회 정기 CIO 호출 시

**이유**: 긴급도 및 정기 호출 시에는 AI 자동편입 정보가 없으므로 체크리스트 불필요

#### 3.1.2 기본 원칙

**활성 상태 신규 편입 코인** (holding_status에서 관리상태='활성'):
- ✅ 3단계 검증 과정을 거친 유망주
- ✅ 단순히 "과거에 없던 코인"이라는 이유로 즉시 제외 금지

**신규 편입 코인 평가 시 고려 사항**:
1. **검증 티어**: VERIFIED > PARTIAL > ALTERNATIVE
2. **품질 점수**: 듀얼 퍼널 보너스 (+15점) 포함 여부
3. **백테스팅 성과**: Sharpe Ratio, Win Rate, MDD

#### 3.1.3 예외적 0% 설정 조건 (강화됨 ⭐)

**[개선 2025-10-25]**: 조건 강화로 VERIFIED 보호 강화

다음 조건 중 **하나 이상 충족 시**만 0% 가능:

1. **구조적 지지선 이탈**: MA120 **-10% 이상** 이탈 (기존 -5% → 강화)
   - 단순 눌림목이 아닌 추세 전환 확정

2. **추세 붕괴 + 리스크 집중**:
   - 일봉 MACD 데드크로스 **AND** RSI ≤ 30
   - **추가**: 기존 보유 코인과 상관관계 **≥ 0.8** (포트폴리오 동반 하락 리스크)

3. **물리적 제약**:
   - 원화 잔고 **< 50,000원** (기존 100,000원 → 강화)
   - **AND** 기존 코인 비중 조정으로도 여유 확보 불가능

#### 3.1.4 근거 명시 필수

신규 편입 코인을 0% 또는 낮은 비중으로 설정 시:
- ✅ Rationale에 **"AI 자동편입 코인이나, [구체적 사유]로 보수적 접근"** 명시
- ✅ 위 예외 조건 중 어떤 것에 해당하는지 명확히 기록

**철학 강조**: VERIFIED는 시스템이 **90일+ 검증한 신뢰 코인**입니다.
단순히 "다른 코인이 더 좋아 보여서"는 **절대 안 됩니다**.

---

### 3.2 시가총액별 비중 상한

| 시가총액 | 유동성 A등급 | 유동성 B등급 | 유동성 C/D등급 |
|---------|------------|------------|--------------|
| **메가캡** | 30% | 25% | 참고만 (강제 제한 없음) |
| **미드캡** | 25% | 20% | 참고만 (강제 제한 없음) |
| **스몰캡** | 20% | **15%** | 참고만 (강제 제한 없음) |

**⚠️ 중요**:
- 이 표는 **참고 기준**일 뿐, 절대적 규칙 아님
- 맥락에 따라 유연하게 조정 가능
- 유동성 C/D등급이라도 **AI 자동편입 코인이면 존중 원칙 적용**

---

### 3.3 손익비 기반 리스크 조정

**포트폴리오 누적 손익비에 따른 전략 조정**:

| 손익비 | 상태 | 전략 조정 |
|--------|------|---------|
| **> 1.2** | 우수 | 공격적 비중 가능 (상한 +5%) |
| **0.8 ~ 1.2** | 정상 | 표준 전략 유지 |
| **< 0.8** | 부진 | 보수적 접근 (현금 비중 +10%) |

---

### 3.4 재평가 상태 관리 원칙 ⭐ (추세 추적 시스템)

> **[신규 추가 2025-10-25]**: 전량 익절 후 추세 재진입 기회 포착
>
> 암호화폐 고변동성으로 인한 일시 조정 후 재상승 패턴 대응

#### 3.4.1 "재평가" 상태의 목적

**배경**:
```
문제: 트레일링 스탑으로 전량 익절 → 다음 날 추가 상승 → 추세 놓침
원인: 암호화폐 고변동성 (일시 조정 후 재상승 패턴)
해결: "재평가" 상태로 추세 감시 → 재진입 기회 포착
```

**"재평가" 상태의 본질**:
- ✅ **전량 익절 완료** (수익 실현)
- ✅ **추세 감시 지속** (포트폴리오에서 제외하지 않음)
- ✅ **재진입 기회 포착** (상승 시그널 시 '활성' 전환)
- ✅ **불필요한 재진입 방지** (하락 시그널 시 '제외' 전환)

**기존 방식 vs 재평가 방식**:
```
기존: 익절 → 제외 → 재상승 놓침 ❌
재평가: 익절 → 재평가 → 재상승 포착 ✅
```

#### 3.4.2 관리상태 3단계 시스템

| 상태 | 의미 | 보유수량 | GPT보유비중 | 다음 단계 |
|-----|------|---------|------------|----------|
| **활성** | 현재 포트폴리오 편입 | > 0 or 0 (매수 대기) | > 0% | 트레일링 스탑 익절 → 재평가 |
| **재평가** ⭐ | 전량 익절 후 추세 감시 | 0 (수익 실현 완료) | 0% | 상승 → 활성 <br> 하락 → 제외 |
| **제외** | 포트폴리오 완전 종료 | 0 | 0% | - |

#### 3.4.3 "재평가" 상태 진입 조건

**진입 시점**: 트레일링 스탑으로 전량 익절 실행 시

**코드 위치**: `trade_manager.py` Lines 914-925 (execute_sell 함수)

```python
# 트레일링 스탑에 의한 전량익절인 경우 '재평가' 상태로 전환
is_trailing_stop_profit = (
    decision_type in ['전량익절', '전량익절(전량 전환)'] and
    final_reason and '트레일링' in final_reason and
    profit_amount > 0
)

if is_trailing_stop_profit:
    logger.info(f"🔄 [{symbol}] 트레일링 스탑 익절 완료. 관리상태를 '재평가'로 변경합니다.")
    db_manager.update_holding_status(symbol, {'관리상태': '재평가'})
else:
    logger.info(f"📤 [{symbol}] 시스템 규칙 매도 완료. 관리상태를 '제외'로 변경합니다.")
    db_manager.update_holding_status(symbol, {'관리상태': '제외'})
```

**진입 조건**:
- ✅ 전량 익절 완료 (수익 실현)
- ✅ 트레일링 스탑에 의한 익절 (손절 아님)
- ✅ 과거 수익 종목 (검증된 코인)

**⚠️ 중요**:
- 트레일링 스탑 익절만 '재평가'로 전환
- 일반 전량 매도 / AI 판단 전량익절은 '제외'로 전환

#### 3.4.4 "재평가" 코인 평가 원칙

**CIO는 매 정기 호출 시 "재평가" 코인도 분석 대상에 포함합니다.**

**평가 우선순위**:
1. **상승 시그널 확인**: MA120 위 유지 + MACD 상승 전환
2. **과거 수익 검증**: 이미 트레일링 스탑으로 수익 실현한 종목
3. **현재 활성 코인과 비교**: 상대 매력도 평가 필수
4. **변동성 고려**: 일시 조정은 정상 (추세 유지 여부 확인)

**철학 강조**:
> **"재평가" 상태의 자산은 과거의 영광입니다.**
>
> 이 자산의 재진입 가능성을 평가하되, **현재 시장에서 새롭게 나타난 '활성' 상태의 유망주들과의 상대적 매력도를 반드시 비교하십시오.**
>
> 만약 새로운 기회가 더 크다고 판단되면, 과거의 승리에 얽매이지 말고 과감히 '재평가' 자산의 목표 비중을 0으로 유지하거나 '관리상태'를 '제외'하여 새로운 기회에 자본을 재배치하십시오.
>
> **당신의 임무는 최고의 포트폴리오를 만드는 것이지, 과거에 성공했던 종목을 다시 사는 것이 아닙니다.**

#### 3.4.5 "재평가" → "활성" 재진입 조건

**재진입 허용 조건** (다음 조건을 **모두** 충족):

1. **명확한 상승 시그널**:
   - MA120 위 유지 (장기 추세 지지)
   - MACD 상승 전환 (모멘텀 재확보)
   - RSI 40~70 (과열 아님)

2. **상대 매력도 우위**:
   - 현재 '활성' 코인과 비교하여 매력도 평가
   - 새로운 기회가 더 크면 재진입 보류

3. **CIO 명시적 판단**:
   - 자동 전환 금지 (CIO가 명시적으로 '활성' 설정 필요)
   - Rationale에 재진입 근거 명시

**코드 로직** (`ai_strategy/cio.py` Lines 2433-2443):
```python
if current_management_status == '재평가':
    if new_status_from_ai == '제외':
        # 하락 시그널 → 제외 확정 (허용)
        final_management_status = '제외'
    elif new_status_from_ai == '활성':
        # [재평가 로직 활성화] 상승 시그널 → 재진입 허용 ⭐
        final_management_status = '활성'
        logger.info(f"🔄 [{symbol}] CIO 재진입 판단: '재평가' → '활성' 전환")
    # else: '재평가' 유지 (CIO가 아직 판단 보류)
```

**⚠️ 중요**:
- CIO가 비중 > 0% 할당 시에만 '활성' 전환 가능 (ai_selected_symbols 조건)
- 비중 = 0% 상태로 '활성' 전환 불가 (재진입 보호)

#### 3.4.6 "재평가" → "제외" 전환 조건

**제외 확정 조건** (다음 조건 중 **하나 이상** 충족):

1. **하락 추세 확정**:
   - MA120 이탈 (장기 추세 붕괴)
   - MACD 데드크로스 (모멘텀 상실)
   - RSI < 30 (추가 하락 우려)

2. **상대 매력도 열위**:
   - 현재 '활성' 코인이 더 매력적
   - 새로운 기회가 명확히 존재

3. **CIO 명시적 제외 판단**:
   - Rationale에 제외 근거 명시
   - management_status = '제외' 설정

#### 3.4.7 "재평가" 관찰 기간

**최소 관찰 기간**: 제한 없음 (CIO가 자율 판단)

**권장 사항**:
- ✅ 전량 익절 직후: 최소 1-3일 관찰 (급등/급락 패턴 확인)
- ✅ 변동성 큰 스몰캡: 최소 3-7일 관찰
- ✅ 안정적 라지캡: 최소 1-2일 관찰

**⚠️ 중요**: 관찰 기간은 절대 규칙이 아님. CIO가 상승/하락 시그널을 종합 분석하여 자율 판단.

#### 3.4.8 시나리오 예시

**시나리오: SOPH (스몰캡) 전량 익절 후**

```
Day 1 (09:00): SOPH 보유 (관리상태='활성')
  ├─ 현재가: 100원 → 150원 (+50% 상승)
  ├─ 트레일링 스탑 발동: 145원에서 전량 익절
  └─ Process2 실행: "전량매도" 완료

Day 1 (09:05): 익절 직후
  ├─ holding_status.관리상태 = '재평가' ✅
  ├─ 보유수량 = 0 (수익 실현 완료)
  └─ GPT보유비중 = 0% (포트폴리오에서 제외)

Day 2 (09:00): CIO 정기 평가
  ├─ SOPH 분석: "어제 익절 후 재상승 중 (+10%, 현재가 160원)"
  │
  ├─ Case A: 상승 시그널 포착 ✅
  │   ├─ MA120 위 유지 (+5%)
  │   ├─ MACD 1일봉 상승 전환
  │   ├─ 현재 활성 코인과 비교: SOPH 매력도 우위
  │   ├─ CIO 판단: "추세 지속, 재진입 필요"
  │   ├─ management_status: '재평가' → '활성'
  │   ├─ GPT보유비중: 0% → 5% (재진입)
  │   └─ Rationale: "SOPH 전량 익절 후 재상승 확인. MA120 위 유지 + MACD 상승 전환. 추세 지속 판단하여 5% 재진입"
  │
  └─ Case B: 하락 시그널 포착 ❌
      ├─ MA120 이탈 (-3%)
      ├─ MACD 1일봉 데드크로스
      ├─ CIO 판단: "추세 종료, 제외 확정"
      ├─ management_status: '재평가' → '제외'
      ├─ GPT보유비중: 0% 유지
      └─ Rationale: "SOPH 전량 익절 후 하락 추세 전환. MA120 이탈 + MACD 데드크로스. 제외 확정"
```

---

## 4. 시나리오 라이브러리

### 시나리오 1: AI 자동편입 코인 + 스몰캡 + B등급

**상황**:
- 코인: SOPH
- AI 자동편입: 1순위 선정 (검증 티어: VERIFIED)
- 시가총액: 스몰캡
- 유동성: B등급
- MA120: 위 +5.0%
- MACD: 일봉 상승, 1시간 상승
- RSI: 65 (과매수 아님)
- Fear & Greed: 30 (Fear)

**올바른 판단**:
- ✅ 목표 비중: **5%** (신규 진입)
- ✅ Rationale: "AI 자동편입 1순위로 3단계 검증 통과. MA120 위 지지 확인. 스몰캡 + B등급으로 15% 상한 준수하여 5% 신규 진입."

**잘못된 판단**:
- ❌ 목표 비중: 0% (스몰캡 + B등급 + 공포 국면이라는 이유로 제외)
- ❌ 이유: **AI 자동편입 존중 원칙 위배**

---

### 시나리오 2: AI 자동편입 코인 + 120일선 이탈

**상황**:
- 코인: MNT
- AI 자동편입: 2순위 선정
- MA120: **아래 -7.0%** (120일선 이탈)
- MACD: 일봉 하락, 1시간 하락
- Fear & Greed: 30

**올바른 판단**:
- ✅ 목표 비중: **0%**
- ✅ Rationale: "AI 자동편입 코인이나, MA120 -7% 이탈로 장기 추세 붕괴 확인. 예외적으로 0% 설정."

---

### 시나리오 3: 긴급 트리거 (과열 신호)

**상황**:
- 코인: SOPH (이미 보유 중, 현재 5%)
- Process1 긴급 트리거: RSI 75 + 변동률 +4.7% 급등
- MA120: 위 +4%
- MACD: 일봉 상승, 1시간 상승
- Fear & Greed: 30

**올바른 판단**:
- ✅ 목표 비중: **5% 유지** (비중 확대 지양)
- ✅ Rationale: "단기 과열 신호 (RSI 75) 확인. 그러나 MA120 지지 유지. 스몰캡 특성상 비중 유지하되, 과열 시 추격 매수 지양."

**잘못된 판단**:
- ❌ 목표 비중: 0% (급등했으니 전량 익절)
- ❌ 이유: **CIO는 실행하지 않음** (비중만 설정, 실제 익절은 Process2 판단)

---

### 시나리오 4: 동일 상황 반복 호출 (일관성 테스트)

**상황**:
- 5분 전 CIO 호출: SOL 15%, MNT 10%, SOPH 5%
- 현재 CIO 호출: 시장 상황 거의 동일 (F&G 30, 가격 변동 ±1% 이내)

**올바른 판단**:
- ✅ 목표 비중: **SOL 15%, MNT 10%, SOPH 5%** (동일 유지)
- ✅ 또는: **SOL 14%, MNT 10%, SOPH 5%** (±1~2% 조정만)
- ✅ Rationale: "이전 판단 유지. 시장 상황 변화 미미."

**잘못된 판단**:
- ❌ 목표 비중: SOL 20%, MNT 5%, SOPH 10% (비중 크게 변경)
- ❌ 이유: **일관성 부재** (같은 상황에서 다른 판단)

---

### 시나리오 5: 현금 부족 + 신규 편입 코인

**상황**:
- AI 자동편입: SOPH 신규 선정
- 현재 포트폴리오: SOL 20%, MNT 15%, 현금 65%
- SOL, MNT 모두 MA120 위 지지, 매력도 높음
- Fear & Greed: 30 (공포 국면)

**올바른 판단**:
- ✅ 목표 비중: SOL 18%, MNT 12%, SOPH 5%, 현금 65%
- ✅ Rationale: "SOPH AI 자동편입 존중하여 5% 신규 진입. 기존 코인 비중 소폭 축소하여 균형 유지."

**잘못된 판단**:
- ❌ 목표 비중: SOL 20%, MNT 15%, SOPH 0%, 현금 65%
- ❌ 이유: "현금 부족"만으로 AI 자동편입 코인 제외 (기존 코인 소폭 축소 고려 안 함)

---

### 시나리오 6: 유동성 C등급 + AI 자동편입

**상황**:
- 코인: ABC (가상)
- AI 자동편입: 1순위 (VERIFIED)
- 유동성: **C등급**
- MA120: 위 +10%
- MACD: 상승
- Fear & Greed: 30

**올바른 판단**:
- ✅ 목표 비중: **5%** (신규 진입)
- ✅ Rationale: "AI 자동편입 1순위. MA120 위 강력한 지지. 유동성 C등급이나, 3단계 검증 통과 코인으로 5% 진입."

**잘못된 판단**:
- ❌ 목표 비중: 0% ("C등급 유동성"만으로 제외)
- ❌ 이유: **유동성 등급을 절대 기준으로 사용** (참고만 해야 함)

---

### 시나리오 7: 메가캡 + 일봉 하락 + 단기 상승

**상황**:
- 코인: SOL (메가캡)
- MA120: 위 +6.0%
- MACD: **일봉 하락**, 1시간 상승
- Fear & Greed: 30

**올바른 판단**:
- ✅ 목표 비중: **14~15%** (유지 또는 소폭 축소)
- ✅ Rationale: "메가캡 특성상 장기 추세 (일봉) 중시. 일봉 MACD 하락은 단기 조정 가능성. MA120 지지 유지하므로 비중 유지. 일봉 추세 전환 확인 시 확대 재검토."

**잘못된 판단**:
- ❌ 목표 비중: 25% (1시간 상승에 반응하여 비중 확대)
- ❌ 이유: **단기 변동성에 과민 반응** (메가캡은 장기 추세 우선)

---

### 시나리오 8: 스몰캡 + 일봉 하락 + 단기 상승

**상황**:
- 코인: MNT (스몰캡)
- MA120: 위 +40%
- MACD: **일봉 하락**, 1시간 상승
- Fear & Greed: 30

**올바른 판단**:
- ✅ 목표 비중: **10%** (유지)
- ✅ Rationale: "스몰캡 특성상 단기 모멘텀 (1시간 상승) 고려. 그러나 일봉 미전환 시 되돌림 리스크. MA120 위 강력한 지지 (+40%)로 10% 유지. 손절 라인 타이트하게 관리."

**잘못된 판단**:
- ❌ 목표 비중: 0% (일봉 하락만 보고 즉시 제외)
- ❌ 이유: **MA120 강력한 지지 무시** (스몰캡은 단기 변동성 크므로 지지선 중요)

---

### 시나리오 9: 과거 손익비 부진 + 공포 국면

**상황**:
- 포트폴리오 누적 손익비: **0.7** (부진)
- Fear & Greed: 30
- AI 자동편입: SOL, MNT 선정
- 현금: 95%

**올바른 판단**:
- ✅ 목표 비중: SOL 10%, MNT 5%, 현금 **85%**
- ✅ Rationale: "누적 손익비 0.7로 부진. '잃지 않는 것'을 최우선 목표로 현금 비중 85% 확보. AI 자동편입 코인은 존중하되, 소량 진입."

**잘못된 판단**:
- ❌ 목표 비중: SOL 15%, MNT 10%, 현금 75% (표준 전략 그대로)
- ❌ 이유: **과거 성과 무시** (부진 시 보수적 접근 필요)

---

### 시나리오 10: 시장 체제 변경 반복 (5분 간격)

**상황**:
- 11:34 CIO: SOL 15%, MNT 10%, SOPH 5%
- 11:45 Process1 긴급: "High_Volatility → Range_Bound 체제 변경"
- 11:46 CIO 재호출: 시장 데이터 거의 동일

**올바른 판단**:
- ✅ 목표 비중: **SOL 14%, MNT 10%, SOPH 5%** (SOL만 1% 조정 또는 동일 유지)
- ✅ Rationale: "시장 체제 변경 감지했으나, 실제 데이터 (MA120, MACD) 변화 미미. 이전 판단 유지."

**잘못된 판단**:
- ❌ 목표 비중: SOL 20%, MNT 5%, SOPH 10% (체제 변경에 과민 반응)
- ❌ 이유: **일관성 부재** (체제 변경 자체가 아니라 데이터 전체를 봐야 함)

---

## 5. 금지 사항

### 5.1 절대 해서는 안 되는 행동

#### ❌ **금지 1: 유동성 등급만으로 제외 결정**

**잘못된 예시**:
```
Rationale: "SOPH는 스몰캡 + B등급 유동성이므로 0% 제외"
```

**올바른 예시**:
```
Rationale: "SOPH는 AI 자동편입 1순위. MA120 위 지지 확인.
스몰캡 + B등급 유동성이나, 3단계 검증 통과로 5% 진입."
```

---

#### ❌ **금지 2: AI 자동편입 코인을 예외 조건 없이 즉시 제외**

**잘못된 예시**:
```
Rationale: "MNT는 과거에 없던 코인이므로 0% 제외"
```

**올바른 예시**:
```
Rationale: "MNT는 AI 자동편입 2순위이나, MA120 -7% 이탈로
장기 추세 붕괴 확인. 예외적으로 0% 설정."
```

---

#### ❌ **금지 3: 기계적 규칙 적용**

**잘못된 예시**:
```
- "스몰캡이므로 무조건 5%"
- "B등급이므로 15% 이하"
- "RSI 70 이상이므로 전량 익절"
```

**올바른 예시**:
```
- "스몰캡 특성 + MA120 지지 + MACD 상승을 종합하여 10% 설정"
- "B등급 유동성 참고하되, AI 자동편입 코인으로 5% 진입"
- "RSI 70+ 과열 신호 확인. 비중 유지하되 추격 매수 지양"
```

---

#### ❌ **금지 4: 일관성 부재**

**잘못된 예시**:
```
11:34 CIO: SOL 15%, MNT 10%
11:46 CIO: SOL 25%, MNT 5% (같은 상황에서 비중 크게 변경)
```

**올바른 예시**:
```
11:34 CIO: SOL 15%, MNT 10%
11:46 CIO: SOL 14%, MNT 10% (소폭 조정 또는 유지)
```

---

#### ❌ **금지 5: CIO가 실행까지 판단**

**잘못된 예시**:
```
Rationale: "SOPH가 급등했으므로 전량 익절"
```

**올바른 예시**:
```
Rationale: "SOPH 과열 신호 확인. 목표 비중 5% 유지.
실제 익절 여부는 Process2가 타이밍 판단."
```

---

### 5.2 철학 위배 사례

#### 사례 1: 2025-10-24 (초기 문제)
```
문제: AI 자동편입 코인(MNT, SOPH)을 CIO가 즉시 0% 제외
원인: "스몰캡 + B등급 유동성" 이유만으로 제외
위배: AI 자동편입 존중 원칙 위배
해결: cio_defensive.txt에 Section 6 추가 (AI 자동편입 존중 규칙)
```

---

## 6. 검증 체크리스트

### 6.1 프롬프트 수정 후 필수 확인

프롬프트를 수정한 후 다음 항목을 체크하세요:

#### ✅ **체크 1: 동일 상황 반복 테스트**

**방법**:
```python
# 동일한 시장 상황 5회 반복 입력
scenario = {
    "fear_greed": 30,
    "coins": {"SOL": {...}, "MNT": {...}},
    # ... 동일한 데이터
}

results = [run_cio(scenario) for _ in range(5)]
weights = {coin: [r[coin] for r in results] for coin in ["SOL", "MNT"]}

# 검증: 비중 변화 ±2% 이내
for coin, weight_list in weights.items():
    assert max(weight_list) - min(weight_list) <= 2
```

**통과 기준**: 비중 변화 ±2% 이내

---

#### ✅ **체크 2: AI 자동편입 존중 확인**

**방법**:
1. AI 자동편입 코인을 입력에 포함
2. CIO 결과 확인
3. 0% 설정 시 Rationale 확인

**검증**:
- [ ] AI 자동편입 코인을 0% 설정한 경우가 있는가?
- [ ] Yes → Rationale에 예외 조건 (120일선 이탈 등) 명시되었는가?
- [ ] No → 통과

**통과 기준**: 예외 조건 없이 0% 설정 시 실패

---

#### ✅ **체크 3: 철학 위배 여부 확인**

**방법**:
Rationale에서 다음 표현 검색:
```bash
grep -E "무조건|절대|반드시|이므로.*%" rationale.txt
```

**금지 표현**:
- "스몰캡이므로 5%"
- "B등급이므로 15% 이하"
- "무조건 제외"
- "절대 매수 금지"

**통과 기준**: 금지 표현 없음

---

#### ✅ **체크 4: 맥락 종합 판단 확인**

**방법**:
Rationale에서 다음 요소 포함 여부 확인:
- [ ] MA120 지지 여부 언급
- [ ] MACD/RSI 추세 언급
- [ ] 시가총액 특성 고려
- [ ] AI 자동편입 여부 언급 (해당 시)

**통과 기준**: 최소 3개 이상 요소 종합

---

#### ✅ **체크 5: 시나리오 라이브러리 일치 확인**

**방법**:
1. 시나리오 1~10을 CIO에 입력
2. 결과가 "올바른 판단"과 일치하는지 확인

**통과 기준**: 10개 중 8개 이상 일치

---

### 6.2 운영 중 모니터링

#### 일관성 지수 계산

**방법**:
```python
# 동일 시간대 (±10분) CIO 호출 결과 비교
calls = get_cio_calls_within(minutes=10)
if len(calls) >= 2:
    for coin in coins:
        weights = [call[coin] for call in calls]
        std_dev = np.std(weights)

        if std_dev > 2:
            log_warning(f"{coin} 비중 변화 과다: {std_dev}")
```

**기준**:
- 표준편차 ≤ 2 → 일관성 우수
- 표준편차 > 2 → 검토 필요

---

## 7. 수정 이력

### 2025-10-27 (v1.6) - 신규 편입 태그 명시성 강화 (Option 1 & 2)

**변경 내용**: AI 자동편입 1-2순위 코인의 투자 연혁 블록에 강화된 신규 편입 태그 적용

**배경**:
- **문제**: 신규 편입 코인(WLFI, TOSHI)이 AI 자동편입 1-2순위로 선정되었음에도 불구하고 CIO가 즉시 0% 배정하는 문제 발생
- **근본 원인**:
  1. 기존 태그 "미보유 상태 **또는** 신규 편입 후보" → OR 관계로 명확성 부족
  2. 시각적 강조 부재 (일반 텍스트만 사용)
  3. System Prompt Line 209 "신규 편입 원칙"이 User Prompt에 충분히 반영되지 않음
  4. 120일선 규칙이 신규 편입 원칙보다 우선시됨

**해결 방안**:

**Option 1: 개별 코인 섹션 태그 강화**
- 투자 연혁 블록에 🆕 이모지 + 굵은 글씨 적용
- 순위, 티어, 샤프 비율 명시
- System Prompt 신규 편입 원칙 직접 참조
- 최소 탐색 비중(3-5%) 가이드라인 제시

**Option 2: 신규 편입 체크리스트 동적 적용**
- `ai_selection_info` 파라미터가 있을 때만 강화 태그 생성
- 긴급도/정기 CIO 호출 시 불필요한 토큰 오버헤드 제거
- 조건부 적용으로 효율성 최대화

**구현 세부사항**:

**① Helper 함수 추가** (`ai_strategy/cio.py` Lines 1373-1434):
```python
def _generate_narrative_block(symbol: str, narrative_data: Dict, ai_selection_info: Dict = None) -> str:
    """
    투자 연혁 블록 생성 (신규 편입 태그 강화 포함)

    Args:
        symbol: 코인 심볼
        narrative_data: DB에서 조회한 투자 연혁 데이터
        ai_selection_info: AI 자동편입 선정 정보 {symbol: {'순위': int, '티어': str, '샤프': float}}

    Returns:
        투자 연혁 블록 문자열
    """
    base_block = "### 📜 투자 연혁 (Investment Narrative)\n- 미보유 상태 또는 신규 편입 후보"

    # AI 선정 정보가 있고, 1-2순위라면 신규 편입 태그 강화
    if ai_selection_info and symbol in ai_selection_info:
        rank = ai_selection_info[symbol]['순위']

        if rank <= 2:  # 1-2순위만 강화 태그 적용
            tier = ai_selection_info[symbol]['티어']
            sharpe = ai_selection_info[symbol]['샤프']
            tier_emoji = {'VERIFIED': '✅', 'PARTIAL': '⚠️', ...}.get(tier, '❓')

            # 신규 편입 강화 태그
            base_block = f"""### 📜 투자 연혁 (Investment Narrative)
🆕 **신규 편입 코인** (AI 자동편입 {rank}순위)
- **검증 티어**: {tier_emoji} {tier} (Sharpe: {sharpe:.2f})
- **편입일**: {today}
- **⚠️ 신규 편입 원칙 적용 필수**: System Prompt Part 3-6 참고
  → 120일선 부재/이탈에도 불구하고, **최소 탐색 비중(3-5%) 할당 우선 고려**
  → 즉시 제외 시, **"더 큰 수익 기회 포기가 합리적"**임을 rationale에 명확히 증명 필수"""

    # DB 연혁 데이터가 있으면 추가
    if narrative_data:
        # ... (기존 로직)

    return base_block
```

**② 헬퍼 함수 호출** (`ai_strategy/cio.py` Lines 1947-1950):
```python
narrative_data = db_manager.get_investment_narrative(symbol)
# 헬퍼 함수 호출: 신규 편입 태그 강화 + 조건부 적용
narrative_block = _generate_narrative_block(symbol, narrative_data, ai_selection_info)
```

**③ JSON 파싱 에러 수정** (`ai_strategy/utils.py` Lines 146-167):
- **문제**: `rfind("```")` 사용 시 여는 백틱을 찾는 오류
- **해결**: 여는 백틱 이후부터만 닫는 백틱 검색
```python
remaining_text = response_text[json_start:]
json_end_in_remaining = remaining_text.find("```")
json_end = json_start + json_end_in_remaining
```

**효과**:
- ✅ **시각적 강조**: 🆕 이모지 + 굵은 글씨로 CIO의 주의 유도
- ✅ **명확한 원칙 참조**: System Prompt Part 3-6 직접 참조로 일관성 강화
- ✅ **최소 비중 가이드**: 3-5% 탐색 비중 제시로 즉시 제외 방지
- ✅ **조건부 적용**: ai_selection_info 있을 때만 활성화 (토큰 효율성)
- ✅ **제로 토큰 오버헤드**: 긴급도/정기 호출 시 기존과 동일한 프롬프트

**검증 결과** (2025-10-27 17:06:43 CIO 프롬프트 로그):

**Before** (16:15:48):
```
### 📜 투자 연혁 (Investment Narrative)
- 미보유 상태 또는 신규 편입 후보
```
→ **Result**: WLFI 0%, TOSHI 0% (즉시 제외)

**After** (17:06:43):
```
### 📜 투자 연혁 (Investment Narrative)
🆕 **신규 편입 코인** (AI 자동편입 1순위)
- **검증 티어**: ⚠️ PARTIAL (Sharpe: 13.02)
- **편입일**: 2025-10-27
- **⚠️ 신규 편입 원칙 적용 필수**: System Prompt Part 3-6 참고
  → 120일선 부재/이탈에도 불구하고, **최소 탐색 비중(3-5%) 할당 우선 고려**
  → 즉시 제외 시, **"더 큰 수익 기회 포기가 합리적"**임을 rationale에 명확히 증명 필수
```
→ **Result**: TOSHI 5%, PUMP 5% (신규 편입 원칙 적용)

**CIO Rationale 예시**:
```json
{
  "TOSHI": {
    "weight": 5.0,
    "management_status": "활성",
    "rationale": "[최종 판단] 목표 비중 5% 유지. 120일선 데이터 부재로 보수적 접근 필요."
  }
}
```

**관련 파일**:
| 파일 | Line | 내용 |
|-----|------|------|
| `ai_strategy/cio.py` | 1373-1434 | `_generate_narrative_block` 헬퍼 함수 추가 |
| `ai_strategy/cio.py` | 1947-1950 | 헬퍼 함수 호출로 13줄 인라인 코드 대체 |
| `ai_strategy/cio.py` | 1953 | `recent` 변수 정의 추가 (스코프 수정) |
| `ai_strategy/utils.py` | 146-167 | JSON 파싱 백틱 처리 수정 |

**핵심 원칙 재확인**:
> **"신규 편입 코인은 시스템이 발굴한 새로운 알파(Alpha) 후보"** (System Prompt Line 209)
>
> 120일선 부재/이탈에도 불구하고, **최소 탐색 비중(3-5%) 할당을 우선 고려**하여 시장 반응을 떠보는 공격적 선택 필요

---

### 2025-10-25 (v1.5) - 재평가 시스템 구현 완료

**변경 내용**: 트레일링 스탑 익절 후 추세 재진입 시스템 완전 구현

**주요 구현사항**:

**① 재평가 자산관리 원칙 프롬프트 추가**:
- `ai_strategy/prompts/cio_aggressive.txt` (Lines 91-96): 공격 모드 재평가 원칙
- `ai_strategy/prompts/cio_neutral.txt` (Lines 79-84): 중립 모드 재평가 원칙
- `ai_strategy/prompts/cio_defensive.txt` (Lines 26-27): 방어 모드 재평가 원칙 (기존 존재)
- **철학**: "과거 영광 vs 현재 기회" 비교 → 최고의 포트폴리오 우선

**② 트레일링 스탑 → '재평가' 전환 로직**:
- `trade_manager.py` Lines 914-925: 트레일링 스탑 익절 시 '재평가' 상태 전환
- 조건: `decision_type='전량익절'` + `'트레일링' in reason` + `profit_amount > 0`
- 그 외 전량 매도는 '제외' 상태로 전환

**③ CIO 재진입 허용 로직**:
- `ai_strategy/cio.py` Lines 2437-2440: '재평가' → '활성' 재진입 허용
- 조건: CIO가 비중 > 0% 할당 + management_status = '활성' 판단
- 로그: "🔄 CIO 재진입 판단: '재평가' → '활성' 전환"

**④ 중복 로직 제거 (충돌 해결)**:
- `supabase_adapter.py` Lines 250-254: 모든 익절 → '재평가' 자동 전환 로직 제거
- 이유: trade_manager.py와 충돌 (트레일링 스탑만 '재평가'로 전환해야 함)
- 결과: 명확한 단일 책임 원칙 (trade_manager에서만 관리상태 제어)

**⑤ DB 통합 확인**:
- `supabase_adapter.py` Line 525: get_active_coin_list에 '재평가' 코인 포함
- `.in_('관리상태', ['활성', '재평가'])` → CIO 분석 대상에 자동 포함

**배경 및 효과**:
- **문제**: 트레일링 스탑 익절 → 다음날 추가 상승 → 추세 놓침
- **원인**: 암호화폐 고변동성 (일시 조정 후 재상승 패턴)
- **해결**: '재평가' 상태로 추세 감시 → 재진입 기회 포착
- **적용 대상**: 전체 (메가캡/미드캡/스몰캡 모두)

---

### 2025-10-25 (v1.4) - 재평가 상태 관리 원칙 명세 추가

**변경 내용**: Section 3.4 "재평가 상태 관리 원칙" 추가 (프로세스 설계)

**추가 내용**:
- 3.4.1: "재평가" 상태의 목적 및 배경
- 3.4.2: 관리상태 3단계 시스템 (활성/재평가/제외)
- 3.4.3~3.4.8: 진입/평가/재진입/제외 조건 및 시나리오

**배경**: 트레일링 스탑 익절 후 추세 재진입 기회 포착 시스템 설계

---

### 2025-10-25 (v1.3) - 페르소나 차별화 및 철학 정렬 개선

**변경 내용**: CIO 프롬프트 5개 파일 개선으로 페르소나별 차별화 및 AI 자율 판단 철학 정렬

**배경**:
- 사용자 피드백 3가지 핵심 요구사항:
  1. VERIFIED 체크리스트는 AI 자동편입 모드에서만 필요 (긴급/정기 호출 시 불필요)
  2. 페르소나별로 분리되어야 하는 규칙 확인 및 개선 필요
  3. "AI 스스로 분석 판단" 철학 준수 (명시적 규칙 최소화)
- 기존 문제:
  - cio_base_rules.txt에 VERIFIED 체크리스트 → 모든 모드에 영향
  - defensive만 완전한 규칙, neutral/aggressive는 차별화 부족
  - "제외가 기본" 같은 prescriptive 규칙이 철학 위배

**해결 방안**:

**① VERIFIED 체크리스트 모드 분리**:
- **제거**: `cio_base_rules.txt`에서 VERIFIED 체크리스트 삭제 (Lines 41-112)
- **추가**: `cio.py` User Prompt 생성 로직에 조건부 추가 (Lines 1668-1711)
  - `ai_selection_info` 파라미터 존재 시에만 체크리스트 포함
  - 조건 강화: MA120 -10% (기존 -5%), 현금 < 50,000원 (기존 100,000원)
  - 조건 2에 상관관계 ≥ 0.8 요구사항 추가
- **효과**: 긴급/정기 호출 시 불필요한 제약 제거, AI 모드에서만 강력한 보호

**② 시가총액 비중 상한 표 추가**:
- **추가**: `cio_base_rules.txt` Lines 40-66
- **내용**: 메가캡/미드캡/스몰캡 × 유동성 A/B/C 매트릭스
- **철학**: "참고 기준"으로 명시, 절대 규칙 아님
- **페르소나 우선**: 각 페르소나의 개별 상한이 더 엄격하면 페르소나 기준 우선

**③ Risk Guardian (defensive) 개선**:
- **수정**: `cio_defensive.txt` Lines 29-52
  - 기존: "신규 편입 태그가 붙은 자산은 '제외'를 기본 판단" (prescriptive)
  - 개선: 3가지 질문 기반 평가 (question-based)
    * 질문 1: 방어적 우위가 명확한가?
    * 질문 2: 신규 편입으로 인한 리스크는?
    * 질문 3: 현재 포트폴리오 대비 가치는?
- **추가**: `cio_defensive.txt` Lines 99-126 - Risk Guardian 자산 배분 원칙
  - 변동성 연동 현금 극대화 (3단계: 60-70% / 70-80% / 80%+)
  - 개별 자산 15% 상한 (메가캡 예외 20%)
  - 상관관계 0.7+ 합계 20% 이하
  - 손익비 < 0.8 시 현금 추가 확보 (70-80%+)

**④ Balanced Analyst (neutral) 개선**:
- **추가**: `cio_neutral.txt` Lines 42-77 - Balanced Analyst 자산 배분 원칙
  - 변동성 균형 대응 (3단계: 30-40% / 40-50% / 50-60%)
  - 개별 자산 20% 상한 (메가캡 예외 25%)
  - 신규 편입 중립 평가 (기존 코인과 동등 기준)
  - 상관관계 0.8+ 합계 30% 이하
  - 손익비 0.8-1.2 정상 구간 전략

**⑤ Alpha Predator (aggressive) 개선**:
- **추가**: `cio_aggressive.txt` Lines 49-89 - Alpha Predator 자산 배분 원칙
  - 변동성 활용 전략 (변동성 = 기회, 70+ 과열만 경계)
  - 개별 자산 30% 상한 (모든 자산 동일)
  - 신규 편입 적극 자세 ("편입이 기본", 명확한 약세만 제외)
  - 상관관계 0.9+ 만 주의 (0.8 허용)
  - 손익비 > 1.2 시 상한 +5%p 추가 (메가캡 35%)

**페르소나별 차별화 요약**:

| 구분 | Risk Guardian | Balanced Analyst | Alpha Predator |
|------|--------------|-----------------|----------------|
| **현금 비중** | 60-70% → 80%+ | 30-40% → 60% | 20-30% → 40% |
| **개별 상한** | 15% (메가캡 20%) | 20% (메가캡 25%) | 30% (모든 자산) |
| **신규 평가** | 질문 기반 검증 | 동등 평가 | 진입 기본 자세 |
| **상관관계** | 0.7+ 합 ≤ 20% | 0.8+ 합 ≤ 30% | 0.9+ 만 주의 |
| **손익비 대응** | < 0.8 → 현금↑↑ | 0.8-1.2 → 미세조정 | > 1.2 → 강화 |

**철학 정렬 개선**:
- ❌ 제거: "X이면 무조건 Y" 같은 기계적 규칙
- ✅ 추가: 질문 기반 가이드 (AI가 질문에 답하며 자율 판단)
- ✅ 명시: 표와 상한은 "참고 기준"이지 절대 규칙 아님
- ✅ 강조: 맥락 전체를 종합하여 스스로 결정

**검증 결과**:
- ✅ 3개 페르소나 모두 차별화된 5개 차원 규칙 보유
- ✅ System Prompt (base_rules + persona) 모드별 정확히 분리
- ✅ User Prompt에서 AI 모드 조건부 VERIFIED 체크리스트 적용
- ✅ 철학 위배 제거 (prescriptive → question-based)

**관련 파일**:
- `ai_strategy/prompts/cio_base_rules.txt`: VERIFIED 제거, 시가총액 표 추가
- `ai_strategy/prompts/cio_defensive.txt`: 질문 기반 신규 평가, Risk Guardian 원칙
- `ai_strategy/prompts/cio_neutral.txt`: Balanced Analyst 자산 배분 원칙 추가
- `ai_strategy/prompts/cio_aggressive.txt`: Alpha Predator 자산 배분 원칙 추가
- `ai_strategy/cio.py`: User Prompt AI 모드 VERIFIED 체크리스트 추가

---

### 2025-10-24 (v1.2) - Fix 4: AI→CIO 데이터 파이프라인 구축

**변경 내용**: AI 자동편입 선정 정보(순위, 티어, Sharpe)를 CIO 프롬프트에 전달하는 메모리 캐시 기반 파이프라인 구축

**배경**:
- AI 자동편입이 엄격한 듀얼 퍼널 3단계 검증을 통과한 VERIFIED 코인을 선정하지만, CIO가 이 정보를 모르고 0% 배정하는 문제 발생
- CIO와 AI 자동편입 간 정보 단절로 시스템 효율성 저하
- 초기 접근(DB 스키마 추가)은 "최초 편입 시에만 필요한 임시 정보를 영구 저장"하는 과도한 복잡도 문제
- 사용자 피드백: "최초 편입할때만 필요한데, 굳이 복잡하게 관리할필요가 없어보이는데, 우회할방법을 찾아줘"

**해결 방안**:

1. **메모리 캐시 기반 접근 (DB 저장 ❌)**
   ```python
   # main.py - 글로벌 캐시 변수 (Line 130)
   ai_selection_cache = {}  # {symbol: {'순위': int, '티어': str, '샤프': float}}
   ```

2. **데이터 흐름** (3단계 파이프라인)
   ```
   [AI 자동편입] data_manager/universe.py
         ↓ Tuple 반환
   (active_coins, ai_selection_info)
         ↓ 메모리 캐시 저장
   [main.py] ai_selection_cache = ai_selection_info
         ↓ 파라미터 전달
   [CIO] recalculate_portfolio_weights(ai_selection_info=cache)
   ```

3. **구현 세부사항**:

   **① AI 자동편입 수정** (`data_manager/universe.py` Line 677-747):
   ```python
   # AI 선정 정보를 메모리에만 저장 (DB 저장 X)
   ai_selection_info = {}

   for i, candidate in enumerate(top_4_coins[:2], start=1):
       symbol = candidate['symbol']
       sharpe_ratio = candidate.get('phase2_metrics', {}).get('sharpe_ratio', 0)
       validation_tier = candidate.get('validation_tier', 'UNKNOWN')

       ai_selection_info[symbol] = {
           '순위': i,
           '티어': validation_tier,
           '샤프': round(sharpe_ratio, 2)
       }

   # Tuple로 반환
   return active_coins, ai_selection_info
   ```

   **② main.py 수정** (Line 130, 691-708, 909-911):
   ```python
   # 글로벌 캐시 선언
   ai_selection_cache = {}

   # AI 자동편입 실행 후 캐시 저장
   latest_universe, ai_selection_info = get_dynamic_universe()
   ai_selection_cache = ai_selection_info
   logger.info(f"📋 [Fix 4] AI 선정 정보 {len(ai_selection_info)}개 코인을 캐시에 저장")

   # CIO 호출 시 캐시 전달
   run_portfolio_rebalance(ai_selection_info=ai_selection_cache)
   ```

   **③ CIO 프롬프트 생성** (`ai_strategy/cio.py` Line 1630-1678):
   ```python
   # 파라미터로 받은 AI 선정 정보를 프롬프트에 포함
   if ai_selection_info:
       ai_selected_coins = [
           {
               '코인': symbol,
               '순위': info['순위'],
               '티어': info['티어'],
               '샤프': info['샤프']
           }
           for symbol, info in ai_selection_info.items()
       ]

       ai_selection_section = f"""
   # 🤖 AI 자동편입 최신 결과
   - **시스템이 선정한 유망 코인**: AI가 듀얼 퍼널 3단계 검증을 통과한 코인들입니다.
   - **중요**: 이 코인들은 백테스팅을 통과한 검증된 종목이므로, 특별한 근거 없이 0% 배정을 금지합니다.

   {ai_coins_list}
   **⚠️ 필수 확인**: VERIFIED 코인을 0% 배정하려면 반드시 '계층 0.5: VERIFIED 체크리스트' 3가지 예외 조건 중 1개 이상을 충족해야 합니다.
       """
   ```

4. **효과**:
   - ✅ DB 복잡도 제거: 스키마 변경 없이 임시 데이터 전달
   - ✅ 정보 파이프라인 구축: AI 자동편입 → CIO 완전 연계
   - ✅ AI 자율성 유지: 정보 제공 후 CIO가 자율적으로 판단
   - ✅ 검증 가능성: 프롬프트 로그에서 전체 과정 추적 가능

5. **검증 결과**:
   - **AI 자동편입 로그**: "📋 [Fix 4] AI 선정 정보 2개 코인을 캐시에 저장 (CIO 전달용)"
   - **CIO 프롬프트 확인**:
     ```
     # 🤖 AI 자동편입 최신 결과
        1순위: **VIRTUAL** - ✅ VERIFIED (Sharpe: 5.75)
        2순위: **ENA** - ✅ VERIFIED (Sharpe: 1.77)
     ```
   - **CIO 자율 판단**: 정보를 받았지만 상관관계 리스크(SOL과 0.79, 0.80)를 우선하여 0% 배정 결정
   - **일관성 확인**: AI가 자율적으로 판단하여 포트폴리오 리스크 관리 원칙 준수

6. **핵심 원칙 재확인**:
   > **"개선방안은 반드시 명시적인 조건보다는 ai가 자율적판단을 우선으로 해야해"** (사용자 피드백)

   - ❌ 잘못된 접근: "VERIFIED는 무조건 5% 배정하라"
   - ✅ 올바른 접근: "VERIFIED 정보를 제공하되, 예외 조건(상관관계, 120일선) 제시 후 AI가 판단"

---

### 2025-10-24 (v1.1) - Fix 3: VERIFIED 체크리스트 추가

**변경 내용**: CIO가 VERIFIED 코인을 0% 배정할 때 명시적 근거를 요구하는 체크리스트 추가

**배경**:
- AI 자동편입이 선정한 VERIFIED 코인(90일+ 백테스팅 통과)을 CIO가 0% 배정하는 경우 발생
- VERIFIED 코인은 엄격한 검증을 통과했으므로, 제외 시 명확한 근거 필요
- "자율 판단"과 "검증된 정보 존중" 사이의 균형 필요

**해결 방안**:

1. **VERIFIED 체크리스트 추가** (`ai_strategy/prompts/cio_base_rules.txt` 추가):
   ```markdown
   ## 계층 0.5: VERIFIED 체크리스트 (AI 자동편입 존중)

   VERIFIED 코인을 0% 배정하려면 아래 3가지 예외 조건 중 **1개 이상**을 충족해야 합니다:

   1. **기술적 약세**: 120일선 아래 -10% 이상 위치 (명확한 하락 추세)
   2. **상관관계 리스크**: 기존 보유 코인과 상관계수 0.7 이상 (포트폴리오 분산 저해)
   3. **과거 실패 이력**: 동일 코인을 최근 7일 이내 손절한 경험
   ```

2. **관련 코드 수정**:
   - `ai_strategy/prompts/cio_base_rules.txt`: 74줄 추가 (체크리스트 섹션)
   - CIO 프롬프트에 자동 포함 (모든 페르소나 공통)

3. **효과**:
   - ✅ AI 자율성 유지: "무조건 배정"이 아닌 "예외 조건 제시"
   - ✅ 검증 정보 존중: VERIFIED 코인의 가치 인정
   - ✅ 추적 가능성: CIO rationale에 체크리스트 충족 여부 명시

4. **검증 결과**:
   - VIRTUAL (VERIFIED, Sharpe 5.75) → 0% 배정
     - 체크리스트 충족: ①120일선 아래 -22.70% (익절구간) ②SOL과 0.79 상관관계
   - ENA (VERIFIED, Sharpe 1.77) → 0% 배정
     - 체크리스트 충족: ②SOL과 0.80 상관관계 ③전량 매도 이력
   - CIO rationale에 명확한 근거 기록됨

---

### 2025-10-24 (v1.0)
- **변경 내용**: 최초 명세서 작성
- **변경 이유**: AI 프롬프트의 일관성 관리 시스템 구축
- **영향 범위**: 전체 CIO 프롬프트 관리 프로세스
- **주요 내용**:
  - AI 자동편입 존중 원칙 문서화
  - 시나리오 라이브러리 10개 작성
  - 검증 체크리스트 정의

---

**📅 최종 업데이트**: 2025-10-27
**📦 버전**: v1.6

---

## 🔧 수정 이력

### 2025-10-27 (v1.2)
- **변경 내용 1**: 관심종목 CIO 분석 대상 처리 개선 (ai_strategy/cio.py Line 102-127)
- **변경 이유**: 3-4순위 코인이 coin_watch_history 등록 직후 CIO가 즉시 0% 비중 부여하여 삭제하는 문제 해결
- **핵심 개선**:
  ```python
  # [수정] coin_watch_history에서 관심 종목 조회 - 긴급도 발생 시에만 CIO 분석 대상에 추가
  watchlist_coins = []

  if emergency_coins:
      # emergency_coins에 포함된 관심종목만 필터링
      emergency_symbols = {coin['symbol'] for coin in emergency_coins}
      all_watchlist = db_manager.get_watchlist_coins()
      watchlist_coins = [w for w in all_watchlist if w['코인이름'] in emergency_symbols]

      if watchlist_coins:
          logger.info(f"🚨 긴급도 발생 관심 종목 {len(watchlist_coins)}개를 CIO 분석 대상에 추가합니다.")
  else:
      # 긴급도가 없으면 관심 종목 확인만 하고 추가하지 않음
      all_watchlist = db_manager.get_watchlist_coins()
      if all_watchlist:
          logger.info(f"📋 관심 종목 {len(all_watchlist)}개 확인 (긴급도 없음 → CIO 평가 제외)")
  ```

- **변경 내용 2**: 현금 비중 불일치 문제 수정 (ai_strategy/cio.py Line 2015-2022)
- **변경 이유**: CIO 프롬프트에 "현재 현금 비중: 0.0%" 표시되던 문제 해결 (실제 45.0%)
- **근본 원인**: `holdings[0]['원화잔고']` 접근 방식이 잘못됨 (holdings는 코인 리스트)
- **핵심 개선**:
  ```python
  # [Fix] 원화잔고는 holding_status 테이블의 '원화잔고' 필드에서 조회 (공통 데이터)
  krw_balance = db_manager.get_portfolio_krw_balance()

  total_value = total_evaluation_coins + krw_balance
  cash_ratio = (krw_balance / total_value * 100) if total_value > 0 else 100
  ```

- **변경 내용 3**: 신규 편입 원칙 강화 (System Prompt Line 209)
- **변경 이유**: 신규 편입 코인(AI 자동편입 1-2순위)에 대한 CIO의 즉각 제외 방지
- **핵심 개선**:
  ```
  6. **신규 기회 검증 원칙**: '신규 편입' 태그가 붙은 자산은 시스템이 발굴한
     **'새로운 알파(Alpha) 후보'**입니다. '알파 사냥꾼'인 당신의 임무는 이 후보가
     포트폴리오의 수익률을 한 단계 더 끌어올릴 잠재력이 있는지 검증하는 것입니다.
     따라서 다른 기존 자산과의 '상대적 매력도'가 다소 낮더라도,
     **새로운 주도주가 될 가능성에 무게를 두고** 최소한의 탐색 비중을 할당하여
     시장의 반응을 떠보는 공격적인 선택을 우선 고려하십시오.
  ```

**검증 결과**:
- ✅ 관심 종목(PUMP)이 긴급도 없을 때 CIO 평가 제외됨
- ✅ 현금 비중 정확히 34.5% 표시
- ✅ 신규 편입 코인에 대한 특별 가이드라인 제공

**관련 파일**:
| 파일 | Line | 내용 |
|-----|------|------|
| `ai_strategy/cio.py` | 102-127 | 관심종목 처리 로직 개선 |
| `ai_strategy/cio.py` | 2015-2022 | 현금 비중 계산 수정 |
| System Prompt | 209 | 신규 편입 원칙 강화 |

---

### 2025-10-25 (v1.1)
- **변경 내용**: AI 자동편입 VERIFIED 티어 예외 제외 규칙 추가
- **변경 이유**: AI 자동편입의 VERIFIED 티어 코인을 CIO가 무분별하게 0% 배정하는 문제 해결
- **영향 범위**: CIO System Prompt 예외 제외 체크리스트
- **주요 내용**:
  1. **인지 강화**: "VERIFIED 티어는 두 개의 독립적인 퍼널을 모두 통과 + 백테스팅 검증 완료"
  2. **AI 자율성 유지**: "무조건 배정"이 아닌 "예외 조건 제시"
  3. **체크리스트 제공**:
     - ① 120일선 대비 -20% 이상 하락 (익절/손절 구간)
     - ② 기존 보유 코인과 상관계수 0.8 이상 (분산 효과 제로)
     - ③ 최근 7일 내 전량 매도 이력 (재진입 시점 아님)
     - ④ 명확한 하락 추세 전환 (1H/4H/1D MACD 모두 하락)

3. **효과**:
   - ✅ AI 자율성 유지: "무조건 배정"이 아닌 "예외 조건 제시"
   - ✅ 검증 정보 존중: VERIFIED 코인의 가치 인정
   - ✅ 추적 가능성: CIO rationale에 체크리스트 충족 여부 명시

4. **검증 결과**:
   - VIRTUAL (VERIFIED, Sharpe 5.75) → 0% 배정
     - 체크리스트 충족: ①120일선 아래 -22.70% (익절구간) ②SOL과 0.79 상관관계
   - ENA (VERIFIED, Sharpe 1.77) → 0% 배정
     - 체크리스트 충족: ②SOL과 0.80 상관관계 ③전량 매도 이력
   - CIO rationale에 명확한 근거 기록됨

---

### 2025-10-24 (v1.0)
- **변경 내용**: 최초 명세서 작성
- **변경 이유**: AI 프롬프트의 일관성 관리 시스템 구축
- **영향 범위**: 전체 CIO 프롬프트 관리 프로세스
- **주요 내용**:
  - AI 자동편입 존중 원칙 문서화
  - 시나리오 라이브러리 10개 작성
  - 검증 체크리스트 정의

---
