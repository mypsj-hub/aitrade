# 트레이딩봇 수정 이력

> **📅 최초 작성**: 2025-10-24
> **📅 최종 업데이트**: 2025-10-27
> **📦 버전**: v1.5
> **목적**: 트레이딩봇의 모든 개발 이력, 아키텍처 변경, 최적화 작업을 시간순으로 기록

---

## 📌 최신 업데이트 (2025-10-27)

### v1.5: 신규 편입 태그 명시성 강화 (Option 1 & 2)

**작성일**: 2025-10-27 17:00
**영향 범위**: CIO 포트폴리오 (User Prompt 생성)

#### 배경

AI 자동편입 1-2순위 코인(WLFI, TOSHI)이 선정되었음에도 불구하고 CIO가 즉시 0% 배정하는 문제 발견. System Prompt Line 209에 "신규 편입 원칙"이 명시되어 있었으나, User Prompt에서 충분히 강조되지 않아 120일선 규칙에 밀려 무시되는 현상 발생.

#### 근본 원인 분석

1. **태그 명확성 부족**: "미보유 상태 **또는** 신규 편입 후보" → OR 관계로 신규 편입 여부 불분명
2. **시각적 강조 부재**: 일반 텍스트만 사용, 이모지/굵은 글씨 없음
3. **원칙 참조 부재**: System Prompt의 신규 편입 원칙을 User Prompt에서 명시적으로 참조하지 않음
4. **가이드라인 부재**: 최소 탐색 비중(3-5%) 제시 없음

#### 주요 수정 사항

| 파일 | Line | 내용 | 효과 |
|------|------|------|------|
| `ai_strategy/cio.py` | 1373-1434 | `_generate_narrative_block` 헬퍼 함수 추가 | 신규 편입 태그 강화 로직 분리 |
| `ai_strategy/cio.py` | 1947-1950 | 헬퍼 함수 호출로 13줄 인라인 코드 대체 | 코드 가독성 향상 |
| `ai_strategy/cio.py` | 1953 | `recent` 변수 정의 추가 | 스코프 에러 수정 |
| `ai_strategy/utils.py` | 146-167 | JSON 파싱 백틱 처리 수정 | JSON 파싱 에러 해결 |

#### 1. 신규 편입 태그 강화 (Option 1 & 2)

**Option 1: 개별 코인 섹션 태그 명시성 강화**

투자 연혁 블록에 다음 요소 추가:
- 🆕 **이모지 + 굵은 글씨**: 시각적 주의 유도
- **순위 + 티어 + Sharpe**: AI 자동편입 검증 정보 명시
- **System Prompt 직접 참조**: "System Prompt Part 3-6 참고"
- **최소 비중 가이드**: "최소 탐색 비중(3-5%) 할당 우선 고려"
- **즉시 제외 방지**: "즉시 제외 시 rationale에 명확한 증명 필수"

**Option 2: 조건부 적용 (토큰 효율성)**

`ai_selection_info` 파라미터가 있을 때만 강화 태그 생성:
```python
if ai_selection_info and symbol in ai_selection_info:
    rank = ai_selection_info[symbol]['순위']
    if rank <= 2:  # 1-2순위만 강화 태그 적용
        # 강화 태그 생성
```

**효과**:
- ✅ 긴급도/정기 CIO 호출 시 기존 프롬프트와 동일 (제로 토큰 오버헤드)
- ✅ AI 자동편입 모드에서만 강화 태그 적용 (+150 토큰/코인)

#### 2. 헬퍼 함수 구조 (ai_strategy/cio.py Line 1373-1434)

```python
def _generate_narrative_block(symbol: str, narrative_data: Dict, ai_selection_info: Dict = None) -> str:
    """
    투자 연혁 블록 생성 (신규 편입 태그 강화 포함)

    Args:
        symbol: 코인 심볼
        narrative_data: DB에서 조회한 투자 연혁 데이터
        ai_selection_info: AI 자동편입 선정 정보 {symbol: {'순위': int, '티어': str, '샤프': float}}

    Returns:
        투자 연혁 블록 문자열
    """
    base_block = "### 📜 투자 연혁 (Investment Narrative)\n- 미보유 상태 또는 신규 편입 후보"

    # [Option 1 & 2] AI 선정 정보가 있고, 1-2순위라면 신규 편입 태그 강화
    if ai_selection_info and symbol in ai_selection_info:
        rank = ai_selection_info[symbol]['순위']

        if rank <= 2:  # 1-2순위만 강화 태그 적용 (3-4순위는 watchlist)
            tier = ai_selection_info[symbol]['티어']
            sharpe = ai_selection_info[symbol]['샤프']
            tier_emoji = {'VERIFIED': '✅', 'PARTIAL': '⚠️', ...}.get(tier, '❓')

            # 신규 편입 강화 태그
            base_block = f"""### 📜 투자 연혁 (Investment Narrative)
🆕 **신규 편입 코인** (AI 자동편입 {rank}순위)
- **검증 티어**: {tier_emoji} {tier} (Sharpe: {sharpe:.2f})
- **편입일**: {today}
- **⚠️ 신규 편입 원칙 적용 필수**: System Prompt Part 3-6 참고
  → 120일선 부재/이탈에도 불구하고, **최소 탐색 비중(3-5%) 할당 우선 고려**
  → 즉시 제외 시, **"더 큰 수익 기회 포기가 합리적"**임을 rationale에 명확히 증명 필수"""

    # DB 연혁 데이터가 있으면 추가
    if narrative_data:
        if ai_selection_info and symbol in ai_selection_info and ai_selection_info[symbol]['순위'] <= 2:
            base_block += "\n\n**📚 과거 투자 연혁** (참고용):"

        # initial, recent 연혁 추가 로직...

    return base_block
```

#### 3. JSON 파싱 에러 수정 (ai_strategy/utils.py Line 146-167)

**문제**: `rfind("```")` 사용 시 여는 백틱을 찾는 오류 발생

**해결**:
```python
# Before (잘못된 코드):
json_end = response_text.rfind("```")  # 여는 백틱을 찾을 수 있음

# After (수정된 코드):
remaining_text = response_text[json_start:]  # 여는 백틱 이후부터만 검색
json_end_in_remaining = remaining_text.find("```")  # 닫는 백틱 찾기
json_end = json_start + json_end_in_remaining  # 전체 텍스트 기준 위치 계산
```

#### 검증 결과 (2025-10-27 17:06:43)

**Before (16:15:48)**:
```
### 📜 투자 연혁 (Investment Narrative)
- 미보유 상태 또는 신규 편입 후보
```
→ **CIO 판단**: WLFI 0%, TOSHI 0% (즉시 제외)

**After (17:06:43)**:
```
### 📜 투자 연혁 (Investment Narrative)
🆕 **신규 편입 코인** (AI 자동편입 1순위)
- **검증 티어**: ⚠️ PARTIAL (Sharpe: 13.02)
- **편입일**: 2025-10-27
- **⚠️ 신규 편입 원칙 적용 필수**: System Prompt Part 3-6 참고
  → 120일선 부재/이탈에도 불구하고, **최소 탐색 비중(3-5%) 할당 우선 고려**
  → 즉시 제외 시, **"더 큰 수익 기회 포기가 합리적"**임을 rationale에 명확히 증명 필수
```
→ **CIO 판단**: TOSHI 5%, PUMP 5% (신규 편입 원칙 적용 ✅)

**CIO Rationale**:
```json
{
  "TOSHI": {
    "weight": 5.0,
    "management_status": "활성",
    "rationale": "[최종 판단] 목표 비중 5% 유지. 120일선 데이터 부재로 보수적 접근 필요."
  }
}
```

#### 핵심 원칙 재확인

> **"신규 편입 코인은 시스템이 발굴한 새로운 알파(Alpha) 후보"** (System Prompt Line 209)
>
> 120일선 부재/이탈에도 불구하고, **최소 탐색 비중(3-5%) 할당을 우선 고려**하여 시장 반응을 떠보는 공격적 선택 필요

---

### v1.4: 3-4순위 코인 보존 로직 개선 및 CIO 현금 비중 수정

**작성일**: 2025-10-27 14:00
**영향 범위**: AI 자동편입, CIO 포트폴리오, 매매판단

#### 배경

이전 세션에서 3-4순위 코인 이슈와 CIO 현금 비중 불일치 문제를 발견하여 근본적인 프로세스 개선 수행.

#### 주요 수정 사항

| 구분 | 문제 | 해결 방안 | 파일 | Line |
|------|------|----------|------|------|
| **AI 자동편입** | 퀀트 검증 시 3-4순위 손실 | 3-4순위 보존 로직 추가 | `market_analysis.py` | 1458-1497 |
| **AI 자동편입** | STEP 2 "기계적" 의미 불명확 | 프롬프트 명확성 강화 | `market_analysis.py` | 630-633, 985 |
| **AI 자동편입** | 시장 국면 출처 불명확 | Process1 출처 명시 | `market_analysis.py` | 1126-1131 |
| **CIO** | 관심종목 즉시 삭제 문제 | 긴급도 발생 시에만 평가 | `cio.py` | 102-127 |
| **CIO** | 현금 비중 0.0% 표시 오류 | holding_status 공유 필드 사용 | `cio.py` | 2015-2022 |
| **CIO** | 신규 편입 코인 즉시 제외 | 신규 편입 원칙 강화 | System Prompt | 209 |

#### 1. AI 자동편입: 3-4순위 보존 로직 (market_analysis.py)

**핵심 원칙**: "퀀트 검증은 1-2순위만 조정, 3-4순위는 항상 보존"

**구현 코드** (Line 1458-1497):
```python
# [Fix] 3-4순위 보존을 위해 별도 저장
remaining_ranks = final_selection[2:] if len(final_selection) > 2 else []

# 경우 1: AI와 퀀트가 동일한 코인 선택
if ai_pick == quant_pick:
    # ... 중복 처리 로직
    final_selection = [ai_pick, new_quant] + remaining_ranks  # ✅ 3-4순위 보존

# 경우 2: 퀀트 선택이 Sharpe 1위가 아님
elif quant_pick != top_sharpe and ai_pick != top_sharpe:
    final_selection = [ai_pick, top_sharpe] + remaining_ranks  # ✅ 3-4순위 보존

# 경우 3: AI가 Sharpe 1위 선택
elif ai_pick == top_sharpe and quant_pick == top_sharpe:
    final_selection = [ai_pick, second_sharpe] + remaining_ranks  # ✅ 3-4순위 보존
```

**검증 결과**:
- ✅ AI 선택 ['ENA', 'TOSHI', 'PUMP'] → 최종 ['ENA', 'WLFI', 'PUMP']
- ✅ 1-2순위 (ENA, WLFI) → holding_status '활성'
- ✅ 3순위 (PUMP) → coin_watch_history '관심'

#### 2. AI 자동편입: 프롬프트 명확성 개선

**STEP 2 "기계적" 의미 명확화** (Line 630-633, 985):
```
⚠️ **중요**: "기계적"이란 AI 판단 없이 Sharpe 수치만으로 결정한다는 의미입니다.
예: WLFI(Sharpe 13.36) vs TOSHI(Sharpe 13.02) → 무조건 WLFI 선택
```

**시장 국면 출처 명확화** (Line 1126-1131):
```python
- **시장 국면**: {market_phase} (Process1 추세 분석 결과)
- ⚠️ 주의: 시장 국면(Process1 분석)은 공포탐욕지수와 다른 독립적인 지표입니다
```

#### 3. CIO: 관심종목 처리 개선 (cio.py Line 102-127)

**문제**: 3-4순위 코인이 coin_watch_history 등록 직후 CIO가 즉시 0% 비중 부여하여 삭제

**해결**:
```python
# [수정] coin_watch_history에서 관심 종목 조회 - 긴급도 발생 시에만 CIO 분석 대상에 추가
watchlist_coins = []

if emergency_coins:
    # emergency_coins에 포함된 관심종목만 필터링
    emergency_symbols = {coin['symbol'] for coin in emergency_coins}
    all_watchlist = db_manager.get_watchlist_coins()
    watchlist_coins = [w for w in all_watchlist if w['코인이름'] in emergency_symbols]

    if watchlist_coins:
        logger.info(f"🚨 긴급도 발생 관심 종목 {len(watchlist_coins)}개를 CIO 분석 대상에 추가합니다.")
else:
    # 긴급도가 없으면 관심 종목 확인만 하고 추가하지 않음
    all_watchlist = db_manager.get_watchlist_coins()
    if all_watchlist:
        logger.info(f"📋 관심 종목 {len(all_watchlist)}개 확인 (긴급도 없음 → CIO 평가 제외)")
```

**검증 결과**:
- ✅ PUMP (관심종목, 긴급도 없음) → CIO 평가 제외
- ✅ 긴급도 발생 시에만 CIO가 관심종목 평가

#### 4. CIO: 현금 비중 불일치 수정 (cio.py Line 2015-2022)

**문제**: CIO 프롬프트에 "현재 현금 비중: 0.0%" 표시 (실제 45.0%)

**근본 원인**: `holdings[0]['원화잔고']` 접근 방식 오류 (holdings는 코인 리스트)

**해결**:
```python
# [Fix] 원화잔고는 holding_status 테이블의 '원화잔고' 필드에서 조회 (공통 데이터)
krw_balance = db_manager.get_portfolio_krw_balance()

total_value = total_evaluation_coins + krw_balance
cash_ratio = (krw_balance / total_value * 100) if total_value > 0 else 100
```

**검증 결과**:
- ✅ CIO 프롬프트에 "현재 현금 비중: 34.5%" 정확히 표시
- ✅ holding_status 공유 '원화잔고' 필드 사용 (5분마다 업데이트)

#### 5. CIO: 신규 편입 원칙 강화 (System Prompt Line 209)

**목적**: 신규 편입 코인(AI 자동편입 1-2순위)에 대한 CIO의 즉각 제외 방지

**추가된 원칙**:
```
6. **신규 기회 검증 원칙**: '신규 편입' 태그가 붙은 자산은 시스템이 발굴한
   **'새로운 알파(Alpha) 후보'**입니다. '알파 사냥꾼'인 당신의 임무는 이 후보가
   포트폴리오의 수익률을 한 단계 더 끌어올릴 잠재력이 있는지 검증하는 것입니다.
   따라서 다른 기존 자산과의 '상대적 매력도'가 다소 낮더라도,
   **새로운 주도주가 될 가능성에 무게를 두고** 최소한의 탐색 비중을 할당하여
   시장의 반응을 떠보는 공격적인 선택을 우선 고려하십시오.
```

#### 검증 완료

| 프로세스 | 검증 항목 | 결과 |
|---------|----------|------|
| **AI 자동편입** | 3-4순위 코인 등록 | ✅ PUMP 관심종목 등록 |
| **AI 자동편입** | 프롬프트 명확성 | ✅ STEP 2 "기계적" 명확화 |
| **CIO** | 관심종목 처리 | ✅ 긴급도 없으면 평가 제외 |
| **CIO** | 현금 비중 표시 | ✅ 34.5% 정확 표시 |
| **CIO** | 신규 편입 가이드 | ✅ 특별 원칙 제공 |
| **매매판단** | CIO 목표 비중 반영 | ✅ 모든 코인 목표 비중 표시 |

#### 관련 문서 업데이트

- ✅ [AI자동편입_명세서.md](AI자동편입_명세서.md) - Section 9 추가
- ✅ [CIO비중_명세서.md](CIO비중_명세서.md) - 수정 이력 v1.2 추가
- ✅ [트레이딩봇_수정이력.md](트레이딩봇_수정이력.md) - 이 항목 추가

---

---

## 📋 목차

1. [아키텍처 및 시스템 구조](#1-아키텍처-및-시스템-구조)
2. [최적화 및 성능 개선](#2-최적화-및-성능-개선)
3. [프로세스 개선 이력](#3-프로세스-개선-이력)
4. [AI 자동편입 개선 이력](#4-ai-자동편입-개선-이력)
5. [CIO 포트폴리오 개선 이력](#5-cio-포트폴리오-개선-이력)
6. [긴급도 시스템 개선](#6-긴급도-시스템-개선)
7. [주요 기능 설명](#7-주요-기능-설명)

---

## 1. 아키텍처 및 시스템 구조

### 1.1 CoinConfig 클래스 vs DB 테이블 책임 분리

**작성일**: 2025-10-16

#### 핵심 개념

| 항목 | CoinConfig 클래스 | holding_status 테이블 |
|------|------------------|----------------------|
| **목적** | 거래 설정 관리 | 실시간 포트폴리오 상태 관리 |
| **책임** | 코인별 투자 전략 파라미터 | 보유 현황, 평가, 관리 상태 |
| **생명주기** | 정적 설정 (초기화 시 생성) | 동적 데이터 (실시간 업데이트) |
| **저장 위치** | 메모리 (config.py) | 데이터베이스 (Supabase) |
| **수정 주체** | 개발자 (코드 수정) | AI/시스템 (런타임 업데이트) |

#### CoinConfig 올바른 사용법

```python
# ✅ 방법 1: 직접 초기화
coin = CoinConfig(
    symbol="XRP",
    initial_weight=0.20,
    target_profit=15.0,
    stop_loss=-7.0,
    strategy_notes="리플 - 국제송금"
)

# ✅ 방법 2: DEFAULT_COIN_CONFIG 사용 (동적 발굴 코인)
coin = CoinConfig(
    symbol="XYZ",
    **DEFAULT_COIN_CONFIG
)
```

#### 해결한 문제

**잘못된 구현 (과거)**:
```python
# ❌ TypeError 발생
temp_coin = CoinConfig(
    symbol="XYZ",
    management_status='재평가'  # CoinConfig에 이 필드 없음!
)
```

**올바른 구현 (현재)**:
```python
# ✅ 책임 분리
temp_coin = CoinConfig(symbol="XYZ", **DEFAULT_COIN_CONFIG)
db_manager.update_holding_status("XYZ", {'관리상태': '재평가'})
```

---

### 1.2 .gitignore 구조 정리

**작성일**: 2025-01-13

#### 문제점

원래 루트 `.gitignore`에 `lib/`가 글로벌로 설정되어 있어서 `dashboard/lib/`도 무시되었습니다.

#### 해결책

Python 관련 경로를 **루트 전용**으로 범위 제한:

```gitignore
# Before (잘못된 설정)
lib/          # 모든 하위 폴더의 lib도 무시

# After (올바른 설정)
/lib/         # 루트의 lib만 무시 (dashboard/lib는 제외)
```

#### 영향

- ✅ `dashboard/lib/` 정상 추적
- ✅ TypeScript 파일 Git에 포함
- ✅ Python 라이브러리만 무시

---

### 1.3 트레이딩봇 프로세스 전체 흐름도

**작성일**: 2025-01-19

#### 핵심 설계 철학

**단일 책임 원칙 (Single Responsibility Principle)**:

- **CIO (Chief Investment Officer)**
  - 역할: 전략가
  - 책임: 포트폴리오 목표 비중 설정, 목표 수익률/손절률 설정
  - 실행: 하루 3회 정기 + 긴급 시

- **Process2 (Trade Executor)**
  - 역할: 실행자
  - 책임: CIO가 설정한 목표를 읽어서 매매 실행
  - 실행: 하루 3회 정기 + 긴급 시

- **Process1 (Real-time Monitor)**
  - 역할: 감시자
  - 책임: 5분마다 시장 모니터링, 긴급 상황 감지
  - 실행: 5분마다 지속적으로

#### 시스템 구성 요소

| 컴포넌트 | 실행 주기 | 주요 역할 | AI 사용 |
|---------|----------|----------|---------|
| **Process1** | 5분마다 | 실시간 모니터링 | ❌ (간단한 지표 계산만) |
| **긴급도 감지** | Process1 내부 | 급등/급락 감지 | ✅ Gemini (빠른 판단) |
| **CIO** | 하루 3회 + 긴급 시 | 포트폴리오 전략 수립 | ✅ OpenAI (깊은 분석) |
| **Process2** | 하루 3회 + 긴급 시 | 매매 실행 판단 | ✅ Gemini/OpenAI (양방향) |
| **AI 자동 편입** | 하루 3회 | 신규 코인 스캔 | ✅ OpenAI (종합 평가) |

#### 핵심 데이터 소유권

| 데이터 필드 | 생성 주체 | 읽기 권한 | 업데이트 권한 |
|-----------|----------|----------|--------------|
| **GPT보유비중** | CIO | CIO, Process2 | **CIO만** ⭐ |
| **GPT목표수익률** | CIO | CIO, Process2 | **CIO만** ⭐ |
| **GPT목표손절률** | CIO | CIO, Process2 | **CIO만** ⭐ |
| **GPT매매비중** | Process2 | Process2 | Process2만 |
| **보유수량** | Process2 | CIO, Process2 | Process2만 |

#### 실행 스케줄

| 시간 | 프로세스 | 설명 |
|------|---------|------|
| **매 5분** | Process1 | 실시간 모니터링 |
| **08:50** | AI 자동편입 | 업비트 갱신 직전 스캔 |
| **09:00** | CIO (정기) | 업비트 일일 갱신 직후 재평가 |
| **09:00** | Process2 (정기) | 매매 실행 |
| **21:00** | AI 자동편입 | 미국 실적발표 직전 스캔 |
| **21:40** | Process2 (정기) | 미국 실적발표 후 매매 |
| **04:00** | AI 자동편입 | 아시아 시장 시작 직전 스캔 |
| **04:00** | Process2 (정기) | 야간 매매 |
| **비정기** | CIO (긴급) | Process1 긴급도 감지 시 |

---

## 2. 최적화 및 성능 개선

### 2.1 data_manager.py 모듈 분리

**작성일**: 2025-10-20

#### 분리 목적

3,006줄의 거대한 data_manager.py를 **책임별로 8개 모듈**로 분리하여 유지보수성 향상

#### 분리 결과

```
data_manager/
├── cache.py           (888줄) - RateLimiter, SmartDataCache, MarketDataCache
├── ohlcv.py          (~500줄) - OHLCV 데이터 + 기술지표 (RSI, MACD 등)
├── universe.py       (~400줄) - 동적 유니버스 생성 (AI 자동편입)
├── market.py         (~200줄) - 김치 프리미엄, 유동성 등급
├── orderbook.py      (~150줄) - 호가창 분석
├── timing.py         (~50줄)  - 최적 매매 타이밍
├── charts.py         (~350줄) - TradingView 차트 캡처 (Selenium)
└── __init__.py       (~80줄)  - 공개 API 노출
```

#### Import 순서 (순환 참조 방지)

1. cache.py: 외부 의존성 없음 (기본 모듈)
2. ohlcv.py: cache 의존
3. market.py: cache, ohlcv 의존
4. orderbook.py: cache 의존
5. timing.py: ohlcv, orderbook 의존
6. universe.py: cache, ohlcv, market 의존
7. charts.py: cache 의존
8. __init__.py: 모든 모듈 import 및 재export

#### 중요 사항

**기존 코드 변경 불필요** - `__init__.py`가 모든 API를 재export하므로:

```python
# Before & After 동일
from data_manager import get_ohlcv_with_retry, market_cache, db_manager
```

---

### 2.2 로그 시스템 개선 (v2.0)

**작성일**: 2025-10-19 (v2.0 - 한글/이모지 Display Width 정렬 개선 완료)

#### 개선 배경

**기존 로그의 문제점**:
```python
# ❌ 문제 1: 모듈 위치 혼동
2025-10-19 14:57:59 - config - INFO - ✅ 시스템 초기화 완료
# 실제로는 main.py의 initialize_system() 함수

# ❌ 문제 2: 긴 텍스트 잘림
2025-10-19 14:58:24 - ai_strategy - INFO - 💡 AI 전략 요약: 현재 시장은 극심한 공포(Fear)...  # 끝이 잘림
```

#### 개선 내용

**v2.0 핵심 개선**:
1. **컬럼 순서 수정**: `시간 | 모듈 | 함수 | 레벨 | 메시지`
2. **컬럼 너비 고정**:
   - 시간: 19자 (YYYY-MM-DD HH:MM:SS)
   - 모듈: 12자 고정
   - 함수/프로세스: 20자 Display Width 고정 (한글/이모지 정확 계산)
   - 레벨: 7자 고정

3. **Display Width 정렬 알고리즘**:
   ```python
   def get_display_width(self, text):
       """한글/이모지는 2칸, 영문은 1칸으로 정확 계산"""
       import unicodedata
       width = 0
       for char in text:
           ea = unicodedata.east_asian_width(char)
           if ea in ('F', 'W'):  # Fullwidth or Wide
               width += 2
           else:
               width += 1
       return width
   ```

4. **프로세스명 매핑 (8개 메인 프로세스만)**:
   ```python
   PROCESS_NAME_MAPPING = {
       'process1': ('5분실시간분석', '🔍'),
       'run_portfolio_rebalance': ('CIO포트폴리오', '🧠'),
       'run_ai_decision_analysis': ('AI매매판단', '🤖'),
       'process2_worker': ('AI매매워커', '⚙️'),
       'initialize_system': ('시스템초기화', '🚀'),
       'update_trading_universe': ('AI자동편입', '🌌'),
       'daily_report': ('일일리포트', '📊'),
       'run_daily_ai_briefing': ('AI일일브리핑', '📝'),
   }
   ```

5. **긴 텍스트 자동 줄바꿈**:
   ```python
   # Before: logger.info(f"근거: {rationale[:50]}...")
   # After:  log_long_text(logger, rationale, prefix="근거: ", max_width=120)
   ```

#### 개선 효과

| 항목 | Before | After (v2.0) | 개선율 |
|------|--------|-------|--------|
| **컬럼 정렬** | 불규칙 | Display Width 정확 계산으로 완벽 정렬 | ✅ 100% |
| **텍스트 잘림** | 50자/800자로 강제 잘림 | 전체 출력 (120자 자동 줄바꿈) | ✅ 100% |
| **프로세스 구분** | Process1, Process2 (비직관적) | 🔍 5분실시간분석, 🤖 AI매매판단 (직관적) | ✅ 100% |

#### 향상된 로그 포맷 예시

```
2025-10-19 17:58:11 | test_logging | 🚀 시스템초기화           | INFO    | 트레이딩 시스템 초기화 시작
2025-10-19 17:58:11 | test_logging | 🔍 5분실시간분석          | INFO    | 5분 실시간 모니터링 시작
2025-10-19 17:58:11 | test_logging | 🧠 CIO포트폴리오           | INFO    | 🎯 CIO 목표 설정을 DB에 저장합니다.
2025-10-19 17:58:11 | config       | [log_long_text]      | INFO    |      근거: [정체성] MNT는 스몰캡, Other 섹터...
2025-10-19 17:58:11 | config       | [log_long_text]      | INFO    |   있으나, G섹터에서 약한 매도세가 관찰됩니다.
```

---

### 2.3 모듈 Docstring 작업

**작성일**: 2025-10-20

#### 작업 원칙

- ✅ 코드 변경 절대 금지 (주석만 추가)
- ✅ 모듈의 역할, 핵심 기능, 사용 예시를 명확하게 설명
- ✅ 비개발자도 이해 가능한 명확한 한글 설명

#### 완료된 모듈

1. **main.py** (43줄) - 시스템 진입점 및 프로세스 관리
2. **config.py** (65줄) - 전역 설정 및 로깅 시스템 v2.0
3. **trade_manager.py** (80줄) - 거래 실행 및 포트폴리오 관리
4. **supabase_adapter.py** (106줄) - Supabase PostgreSQL CRUD
5. **ai_strategy/__init__.py** (91줄) - AI 매매전략 모듈
6. **data_manager/__init__.py** (99줄) - 시장 데이터 수집 모듈

#### 사용 방법

```python
# 모듈 도움말 확인
import main
help(main)

from ai_strategy import cio
help(cio)
```

---

### 2.4 복잡한 계산 로직 인라인 주석 작업

**작성일**: 2025-10-20

#### 작업 대상

**trade_manager.py**:
- Auto-escalation 계산 (3단계 배율: 20%p→3배, 10%p→2배, 5%p→1.5배)
- Smart Fractional 계산 (65% 보장)
- TWAP 분할 로직 (3회 split, 소액 통합, 최소 금액 보장)

**ai_strategy/cio.py**:
- DUMMY_SYMBOLS 필터링
- 비중 정규화 (총합 100%, 반올림 오차 보정)

**data_manager/universe.py**:
- 모멘텀 필터 (가격 변화율 × 거래량 비율)
- 퀄리티 필터 (거래대금, 변동성, 120일선)

#### 주석 예시

```python
# Auto-escalation: 목표 비중 달성 시간 10배 가속 (10일 → 1일)
# 목표 갭이 클수록 더 큰 배율을 적용하여 빠르게 목표 비중 달성
if gap_percent >= 20:
    effective_percent = min(100, gpt_trade_percent * 3.0)  # 20%p 이상 → 3배 가속

# Smart Fractional: 목표 갭의 65%를 1회 매수로 최소 보장
# 너무 작은 매수 금액으로 인한 목표 달성 지연을 방지
smart_fill_ratio = 0.65
min_smart_amount = gap_amount * smart_fill_ratio
```

---

## 3. 프로세스 개선 이력

### 3.1 Process2 프롬프트 아키텍처 분석 및 검증 (2025-10-25)

**버전**: v1.3 (Process2 명세서 동기화)

#### 분석 배경

Process2 (매매판단) 프롬프트 로그 분석 중 오해 발생:
- **초기 착각**: 프롬프트 로그 파일(매매판단_20251024_222420.txt)만 보고 Process2가 Risk Guardian 페르소나만 사용한다고 판단
- **사용자 지적**: "실제 로직에는 페르소나별로 구분되어있어. 코드를 확인해봐. cio도 마찬가지야!!!"
- **핵심 교훈**: 프롬프트 로그는 **특정 시점의 스냅샷**일 뿐, 실제 코드 구조를 확인해야 함

#### 중요한 개념 정리

**프롬프트 로그 vs 실제 코드의 차이**:

```
프롬프트 로그 (매매판단_20251024_222420.txt)
├── 시각: 2025-10-24 22:24:20
├── 시장 상황: Fear & Greed 30 (Fear)
├── 표시된 페르소나: Risk Guardian (방어적)
└── 의미: **현재 시장에 맞는 페르소나가 선택된 것**

실제 코드 (prompts.py, process2.py)
├── 페르소나 파일 3개 존재:
│   ├── cio_defensive.txt (Fear & Greed < 45)
│   ├── cio_neutral.txt (45 ≤ F&G ≤ 55)
│   └── cio_aggressive.txt (F&G > 55)
├── market_phase 기반 동적 선택:
│   └── cache.py의 점수 계산 시스템 (F&G + BTC/ETH 지표)
└── 의미: **시장 상황에 따라 3가지 페르소나 중 하나 선택**
```

**핵심 교훈**:
- ❌ **잘못된 분석**: 프롬프트 로그만 보고 "Process2는 Risk Guardian만 사용"
- ✅ **올바른 분석**: 코드 확인 결과 "Process2는 시장 상황에 따라 3가지 페르소나 동적 선택"
- **교훈**: 로그 = 특정 순간의 결과물, 코드 = 전체 시스템 구조

#### 주요 발견 사항

**1. CIO와 Process2는 프롬프트 파일을 100% 공유**

```
ai_strategy/prompts/
├── cio_aggressive.txt    → CIO & Process2 공통 사용
├── cio_defensive.txt     → CIO & Process2 공통 사용
├── cio_neutral.txt       → CIO & Process2 공통 사용
└── cio_base_rules.txt    → CIO & Process2 공통 사용
```

**의미**:
- ✅ CIO v1.3 개선사항이 Process2에 자동 반영됨
- ✅ 두 시스템 간 일관성 보장
- ✅ 유지보수 효율성 극대화 (프롬프트 1번만 수정하면 양쪽 모두 반영)

**검증 코드**:
```python
# ai_strategy/prompts.py (Lines 40-49)
CIO_AGGRESSIVE = _load_prompt_from_file('cio_aggressive.txt')
CIO_DEFENSIVE = _load_prompt_from_file('cio_defensive.txt')
CIO_NEUTRAL = _load_prompt_from_file('cio_neutral.txt')

# 하위 호환성을 위한 별칭 (Process2가 사용)
AGGRESSIVE_CHARTER = CIO_AGGRESSIVE
DEFENSIVE_PRINCIPLES = CIO_DEFENSIVE
BALANCED_PRINCIPLES = CIO_NEUTRAL
```

**2. 페르소나 선택 로직 동일**

CIO와 Process2 모두 `market_phase` 기반으로 동일한 페르소나 선택:

```python
# ai_strategy/prompts.py (Lines 52-85)
def _get_system_prompt(provider: str, market_phase: str) -> str:
    if market_phase in ['greed', 'extreme_greed']:
        persona_prompt = AGGRESSIVE_CHARTER  # Alpha Predator
    elif market_phase in ['fear', 'extreme_fear']:
        persona_prompt = DEFENSIVE_PRINCIPLES  # Risk Guardian
    else:  # 'neutral'
        persona_prompt = BALANCED_PRINCIPLES  # Balanced Analyst
```

**3. market_phase 계산 로직 일관성**

CIO와 Process2가 **동일한 market_phase를 읽음**:

```python
# data_manager/cache.py (Lines 470-569)
# Fear & Greed (가중치 30점) + BTC (35점) + ETH (20점) = 85점 만점

if market_score >= 75: market_phase = "extreme_greed"
elif market_score >= 55: market_phase = "greed"
elif market_score > 45: market_phase = "neutral"
elif market_score > 25: market_phase = "fear"
else: market_phase = "extreme_fear"
```

**4. CIO v1.3 개선사항 자동 반영 확인**

Process2가 사용하는 프롬프트 파일에 CIO v1.3 개선사항 모두 포함:

| 개선사항 | cio_defensive.txt | cio_neutral.txt | cio_aggressive.txt |
|---------|------------------|----------------|-------------------|
| **질문 기반 평가** | ✅ Lines 29-52 | ✅ Lines 42-78 | ✅ Lines 49-90 |
| **페르소나별 할당 원칙** | ✅ Lines 99-126 | ✅ Lines 42-77 | ✅ Lines 49-89 |
| **변동성 연동 현금 비중** | ✅ 60-80% | ✅ 30-60% | ✅ 20-40% |
| **개별 자산 상한** | ✅ 15% (메가캡 20%) | ✅ 20% (메가캡 25%) | ✅ 30% (모두) |
| **신규 편입 접근** | ✅ 질문 기반 검증 | ✅ 동등 평가 | ✅ 진입 기본 |

**5. VERIFIED 체크리스트는 CIO 전용**

Process2는 VERIFIED 체크리스트를 **받지 않음** (의도적 설계):

```python
# ai_strategy/cio.py (Lines 1668-1711)
# CIO User Prompt에서만 조건부 포함
if ai_selection_info:
    # VERIFIED 체크리스트를 User Prompt에 추가
    ai_selection_section = """
    ## 🔒 VERIFIED 체크리스트 (AI 자동편입 존중)
    조건 1: 구조적 지지선 이탈 (MA120 -10% 이상)
    조건 2: 추세 붕괴 + 리스크 집중
    조건 3: 물리적 제약 (원화 잔고 < 50,000원)
    """
```

**이유**:
- ✅ CIO: 전략가 역할 - VERIFIED 존중하여 목표 비중 설정
- ✅ Process2: 실행자 역할 - CIO 목표를 읽고 G섹터/C섹터 신호로 타이밍 판단
- ✅ Process2가 VERIFIED 정보를 받으면 CIO 전략과 충돌 가능

#### 아키텍처 비교표

| 구성 요소 | CIO | Process2 | 공유 여부 |
|---------|-----|----------|----------|
| **System Prompt** | ✅ | ✅ | 🟢 100% 공유 |
| - 페르소나 (persona) | cio_*.txt | cio_*.txt | 🟢 동일 파일 |
| - 공통 규칙 (base_rules) | cio_base_rules.txt | cio_base_rules.txt | 🟢 동일 파일 |
| - 페르소나 선택 로직 | market_phase 기반 | market_phase 기반 | 🟢 동일 로직 |
| **User Prompt** | ✅ | ✅ | 🔴 독립적 |
| - 보유 현황 | holdings | holdings | 🟢 동일 데이터 |
| - 시장 데이터 | market_trend | market_trend | 🟢 동일 데이터 |
| - **VERIFIED 체크리스트** | ✅ (AI 모드만) | ❌ | 🔴 CIO만 |
| - **CIO 전략 브리핑** | ❌ | ✅ | 🔴 Process2만 |

#### 순차 검증 결과

사용자 요청("순차적으로 모두 확인해줘")에 따라 다음 항목 검증 완료:

1. ✅ **market_phase 계산 로직**: cache.py의 점수 기반 시스템 확인 (Lines 470-569)
2. ✅ **cio_defensive.txt 내용**: CIO v1.3 개선사항 반영 확인 (질문 기반 평가, Risk Guardian 원칙)
3. ✅ **cio_neutral.txt 내용**: Balanced Analyst 자산 배분 원칙 확인
4. ✅ **cio_aggressive.txt 내용**: Alpha Predator 자산 배분 원칙 확인
5. ✅ **cio_base_rules.txt 역할**: CIO-Process2 공통 규칙 확인 (VERIFIED는 없음)
6. ✅ **VERIFIED 체크리스트 위치**: cio.py User Prompt에서 조건부 포함 확인 (AI 모드만)

#### 효과

- ✅ **프롬프트 공유 아키텍처 검증**: CIO와 Process2 간 일관성 보장 확인
- ✅ **페르소나 시스템 이해 개선**: 로그 vs 코드 차이 명확화
- ✅ **CIO v1.3 반영 확인**: Process2에 모든 개선사항 자동 반영됨
- ✅ **역할 분리 명확화**: VERIFIED는 CIO만, CIO 브리핑은 Process2만
- ✅ **문서화**: 프롬프트 로그 분석 시 주의사항 교훈 정리

#### 관련 파일

- `ai_strategy/prompts.py`: 페르소나 파일 로딩 및 선택 로직
- `ai_strategy/process2.py`: Process2 메인 로직 (Lines 65-172)
- `data_manager/cache.py`: market_phase 계산 로직 (Lines 470-569)
- `ai_strategy/cio.py`: CIO User Prompt 생성 로직 (Lines 1668-1711)
- `docs/prompts_log/매매판단_20251024_222420.txt`: Process2 프롬프트 스냅샷 (Fear 국면)

#### 관련 문서 업데이트

- `docs/dev_guide/매매판단_명세서.md`: v1.2 (페르소나 시스템 설명 추가)

---

### 3.1.1 CIO v1.3 개선사항 프로덕션 검증 (2025-10-25)

**버전**: v1.3 (검증 완료)

#### 검증 목적

CIO v1.3에서 도입된 모든 개선사항이 실제 운영 환경에서 정상적으로 작동하는지 확인

#### 검증 방법

프로덕션 프롬프트 로그 3건을 라인바이라인 분석:
1. **AI 자동편입** (AI자동편입_20251025_014350.txt)
2. **CIO 포트폴리오** (CIO포트폴리오_20251025_014746.txt)
3. **Process2 매매판단** (매매판단_20251025_014909.txt)

#### 검증 결과 (ALL PASS ✅)

| 검증 항목 | AI 자동편입 | CIO | Process2 | 상태 |
|---------|------------|-----|----------|------|
| 페르소나 시스템 | N/A | ✅ Risk Guardian | ✅ Risk Guardian | **PASS** |
| Part 0 정체성 프레임워크 | N/A | ✅ Lines 2-198 | N/A | **PASS** |
| VERIFIED 체크리스트 | ✅ Absolute Rule 2 | ✅ Lines 614-655 | N/A | **PASS** |
| 질문 기반 평가 | ✅ 티어 평가 | ✅ 3가지 질문 | ✅ Lines 29-52 | **PASS** |
| 전략적 딜레마 응답 | N/A | ✅ Lines 275-331 | N/A | **PASS** |
| 변동성 연동 현금 비중 | N/A | ✅ 70% | ✅ 70% | **PASS** |
| CIO 브리핑 이행 | N/A | N/A | ✅ Lines 327-354 | **PASS** |
| G vs C 신호 충돌 | N/A | N/A | ✅ 3가지 질문 | **PASS** |
| 목표 비중 괴리도 분석 | N/A | N/A | ✅ thinking_process | **PASS** |

#### 주요 발견 사항

**1. AI 자동편입 - Absolute Rule 2 정상 작동**
```
상황: ENA (VERIFIED), LA (ALTERNATIVE), PROVE (ALTERNATIVE)
규칙: VERIFIED 1개 → 그 1개만 선정
결과: ENA만 선정 ✅ (LA, PROVE 정상 배제)
```

**2. CIO - ENA 0% 편입 케이스 (정상)**
```
상황: ENA = VERIFIED (Sharpe 5.69), AI 자동편입 1순위
결과: 0% 할당 (미포함)
이유:
  - 2일 전 매도 (2025-10-23) → 14일 관찰 기간 내
  - 120일선 데이터 없음 → 워뇨띠 전략 적용 불가
  - VERIFIED 체크리스트 3조건 모두 미충족
판단: "편입/제외 일관성 규칙 > VERIFIED 체크리스트" 우선순위 정상 ✅
```

**3. Process2 - CIO 목표 비중 괴리도 분석 작동**
```
PUNDIX: "CIO 목표 6.0% vs 현재 3.76% (괴리 2.24%)"
SOL: "CIO 목표 10.0% vs 현재 9.78% (괴리 0.22%)"
→ tactical_summary에 "CIO 목표 vs 단기 리스크 저울질" 명시 ✅
```

**4. Process2 - G vs C 신호 충돌 분석 작동**
```
AVNT: G섹션 매수세 vs C섹션 중립
→ 3가지 질문 기반 분석 실행:
  Q1. 단기 잡음인가, 추세 시작인가?
  Q2. 어느 신호가 더 신뢰할 만한가?
  Q3. 감수할 손실은 얼마인가?
→ 최종 판단: G섹션 우선 ✅
```

#### 중요한 개념 재확인

**프롬프트 로그 vs 실제 코드** (착각 방지 재교육):
- **프롬프트 로그** = 특정 시점의 스냅샷 (해당 시장 상황의 페르소나만 보임)
- **실제 코드** = 3가지 페르소나가 모두 존재 (market_phase에 따라 동적 선택)
  * Risk Guardian (Fear & Greed < 45)
  * Balanced Analyst (45 ≤ F&G ≤ 55)
  * Alpha Predator (F&G > 55)

**VERIFIED 체크리스트의 실제 역할**:
- ❌ **오해**: "VERIFIED면 무조건 편입"
- ✅ **실제**: "VERIFIED 코인을 제외하려면 3가지 조건 중 하나는 충족해야 함" (제외 방지 규칙)
- ✅ **우선순위**: 편입/제외 일관성 규칙 > VERIFIED 체크리스트

#### 결론

모든 CIO v1.3 개선사항이 프로덕션 환경에서 정상적으로 작동하고 있음을 확인했습니다.

#### 관련 파일

- `docs/prompts_log/CIO_v1.3_개선사항_검증_리포트.md`: 상세 검증 리포트 (표, 예시, 라인 번호 포함)
- `docs/prompts_log/AI자동편입_20251025_014350.txt`: AI 자동편입 검증 로그
- `docs/prompts_log/CIO포트폴리오_20251025_014746.txt`: CIO 검증 로그
- `docs/prompts_log/매매판단_20251025_014909.txt`: Process2 검증 로그

#### 관련 문서 업데이트

- `docs/dev_guide/트레이딩봇_수정이력.md`: 본 섹션 추가
- `docs/dev_guide/매매판단_명세서.md`: Section 0 추가 (v1.1 → v1.2)

---

### 3.1.2 관심 코인 삭제 로직 개선 (2025-10-25)

**버전**: CIO v1.4

#### 문제 발견

**현상**: LA, PROVE가 holding_status('활성')와 coin_watch_history에 동시 존재 (이중 편입)

**원인**: CIO가 관심 코인을 평가했지만 **0% 비중 할당 시** coin_watch_history에서 삭제되지 않음

**기존 로직** (`ai_strategy/cio.py` Lines 2554-2571):
```python
# CIO가 이 코인을 '활성'으로 승격시켰는지 확인
if symbol in coin_weights_to_db and coin_weights_to_db[symbol] > 0:
    # 승격: holding_status 등록 + coin_watch_history 삭제
else:
    logger.info(f"⏭️ {symbol}: 승격 보류 → coin_watch_history에 유지")
    # ⚠️ 문제: 0% 비중 코인은 영원히 관심 테이블에 남음!
```

#### 해결 방안

**삭제 조건 완화**: CIO가 평가한 코인은 비중과 무관하게 처리

**수정 후 로직** (`ai_strategy/cio.py` Lines 2554-2587):
```python
# CIO가 이 코인을 평가했는지 확인
if symbol in coin_weights_to_db:
    # 비중 > 0%: 승격 (holding_status '활성' + coin_watch_history 삭제)
    if coin_weights_to_db[symbol] > 0:
        logger.info(f"✅ {symbol}: '활성'으로 승격 (비중 {coin_weights_to_db[symbol]:.1f}%)")

        # holding_status에 등록
        db_manager.update_holding_status(symbol, {
            '관리상태': '활성',
            'GPT보유비중': coin_weights_to_db[symbol],
            # ...
        })

        # coin_watch_history에서 삭제
        db_manager.delete_from_watchlist(symbol)

    # 비중 = 0%: 제외 판단 (coin_watch_history 삭제 + holding_status '제외')
    else:
        logger.info(f"❌ {symbol}: CIO 제외 판단 (0% 비중) → coin_watch_history에서 삭제")

        # coin_watch_history에서 삭제
        db_manager.delete_from_watchlist(symbol)

        # holding_status에 있으면 '제외' 상태로 변경
        existing_holding = db_manager.get_holding_status(symbol)
        if existing_holding:
            db_manager.update_holding_status(symbol, {'관리상태': '제외'})
            logger.info(f"   ↳ holding_status '제외' 상태로 변경")
else:
    # CIO가 분석하지 않은 코인 (이론상 발생 안 함)
    logger.warning(f"⚠️ {symbol}: CIO 분석 대상 아님 → coin_watch_history에 유지")
```

#### 효과

- ✅ **CIO 0% 비중 코인 자동 삭제**: coin_watch_history에서 즉시 제거
- ✅ **holding_status '제외' 상태 설정**: 재편입 방지
- ✅ **이중 편입 문제 완전 해결**: holding_status와 coin_watch_history 동시 존재 방지
- ✅ **관심 코인 자동 정리**: 불필요한 코인 축적 방지

#### 예상 동작

**시나리오**: CIO가 LA, PROVE를 0% 비중으로 결정

**기존 동작** (버그):
```
01:47:47 | 🧹 CIO 평가 완료. 관심 종목 2개를 정리합니다.
01:47:47 | ⏭️ PROVE: 승격 보류 → coin_watch_history에 유지
01:47:47 | ⏭️ LA: 승격 보류 → coin_watch_history에 유지

결과: coin_watch_history에 계속 남음 (이중 편입 발생)
```

**개선 후 동작**:
```
01:47:47 | 🧹 CIO 평가 완료. 관심 종목 2개를 정리합니다.
01:47:47 | ❌ PROVE: CIO 제외 판단 (0% 비중) → coin_watch_history에서 삭제
01:47:47 |    ↳ holding_status '제외' 상태로 변경
01:47:47 | ❌ LA: CIO 제외 판단 (0% 비중) → coin_watch_history에서 삭제
01:47:47 |    ↳ holding_status '제외' 상태로 변경

결과: coin_watch_history에서 삭제됨 + holding_status '제외' 상태
```

#### 관련 파일

- `ai_strategy/cio.py`: Lines 2554-2587 (관심 코인 정리 로직)
- `docs/prompts_log/관심코인_삭제_로직_분석.md`: 상세 분석 리포트
- `docs/dev_guide/AI자동편입_명세서.md`: Section 8 추가 (v1.1 → v1.2)

#### 관련 문서 업데이트

- `docs/dev_guide/트레이딩봇_수정이력.md`: 본 섹션 추가
- `docs/dev_guide/AI자동편입_명세서.md`: Section 8 "관심 코인 생명주기 관리" 추가

---

### 3.2 AI자동편입-CIO-Process2 파이프라인 통합 개선 (2025-10-24)

**버전**: v2.1

#### 개선 배경

AI 자동편입, CIO, Process2 간의 역할 중복 및 정보 단절 문제로 시스템 효율성 저하:
- AI 자동편입이 CIO 관리 중인 코인을 다시 검증 (리소스 낭비)
- CIO가 AI 자동편입 선정 정보를 모르고 판단 (정보 단절)
- Process2가 CIO 이전 전략을 읽는 동기화 문제 (데이터 불일치)

#### 4가지 핵심 개선 (Fix 1~4)

---

#### **Fix 1: AI 자동편입 CIO 관리 코인 제외 로직**

**목적**: AI 자동편입과 CIO의 역할 명확화 및 리소스 절약

**구현**:
```python
# data_manager/universe.py (Line 430-470)
# CIO 관리 중인 코인 조회 (활성 + 관망)
cio_managed = db_manager.get_active_coins()

# AI 자동편입 후보에서 제외
candidates = [coin for coin in all_coins if coin not in cio_managed]

logger.info(f"🔍 [AI자동편입 제외 로직] CIO 관리 중인 코인: {len(cio_managed)}개")
logger.info(f"📋 AI 자동편입 후보: {len(candidates)}개")
```

**효과**:
- ✅ 역할 분리: AI 자동편입 = 신규 발굴, CIO = 기존 관리
- ✅ API 비용 절감: 중복 검증 제거
- ✅ 시스템 일관성 향상

**검증**: "🔍 [AI자동편입 제외 로직] CIO 관리 중인 코인: 8개" (로그 확인)

---

#### **Fix 2: CIO-Process2 동기화 검증 로직**

**목적**: Process2가 최신 CIO 전략을 정확히 읽도록 DB 동기화 보장

**구현**:
```python
# main.py (Line 623-642)
# CIO 실행 완료 → 큐에 타임스탬프 포함하여 작업 추가
queue.put({
    'type': 'rebalance',
    'cio_timestamp': datetime.now(timezone.utc).isoformat()
})

# Process2 워커: 2초 대기 + DB 검증
time.sleep(2)
latest_cio = db_manager.get_latest_cio_report()
if latest_cio['timestamp'] >= cio_timestamp:
    logger.info("✅ [CIO-Process2 동기화] DB 데이터 확인 완료")
```

**효과**:
- ✅ 데이터 일관성: Process2가 최신 CIO 전략 확실히 읽음
- ✅ 타임스탬프 기반 검증
- ✅ 큐 기반 아키텍처 유지

**검증**: "✅ [CIO-Process2 동기화] DB 데이터 확인 완료" (로그 확인)

---

#### **Fix 3: VERIFIED 체크리스트 추가**

**목적**: CIO가 VERIFIED 코인을 0% 배정할 때 명시적 근거 요구

**구현**:
```markdown
# ai_strategy/prompts/cio_base_rules.txt (74줄 추가)
## 계층 0.5: VERIFIED 체크리스트 (AI 자동편입 존중)

VERIFIED 코인을 0% 배정하려면 아래 3가지 예외 조건 중 **1개 이상**을 충족해야 합니다:

1. **기술적 약세**: 120일선 아래 -10% 이상 위치 (명확한 하락 추세)
2. **상관관계 리스크**: 기존 보유 코인과 상관계수 0.7 이상 (포트폴리오 분산 저해)
3. **과거 실패 이력**: 동일 코인을 최근 7일 이내 손절한 경험
```

**효과**:
- ✅ AI 자율성 유지: "무조건 배정"이 아닌 "예외 조건 제시"
- ✅ 검증 정보 존중: VERIFIED 코인의 가치 인정
- ✅ 추적 가능성: CIO rationale에 체크리스트 충족 여부 명시

**검증**: VIRTUAL/ENA 제외 시 rationale에 체크리스트 조건 명시 확인

---

#### **Fix 4: AI→CIO 데이터 파이프라인 구축 (메모리 캐시 기반)**

**목적**: AI 자동편입 선정 정보(순위, 티어, Sharpe)를 CIO에 전달하여 정보 단절 해소

**구현**:

**① AI 자동편입 수정** (`data_manager/universe.py` Line 677-747):
```python
# AI 선정 정보를 메모리에만 저장 (DB 저장 X)
ai_selection_info = {}

for i, candidate in enumerate(top_4_coins[:2], start=1):
    symbol = candidate['symbol']
    sharpe_ratio = candidate.get('phase2_metrics', {}).get('sharpe_ratio', 0)
    validation_tier = candidate.get('validation_tier', 'UNKNOWN')

    ai_selection_info[symbol] = {
        '순위': i,
        '티어': validation_tier,
        '샤프': round(sharpe_ratio, 2)
    }

# Tuple로 반환 (DB 저장 안 함)
return active_coins, ai_selection_info
```

**② main.py 수정** (Line 130, 691-708, 909-911):
```python
# 글로벌 캐시 선언
ai_selection_cache = {}

# AI 자동편입 실행 후 캐시 저장
latest_universe, ai_selection_info = get_dynamic_universe()
ai_selection_cache = ai_selection_info
logger.info(f"📋 [Fix 4] AI 선정 정보 {len(ai_selection_info)}개 코인을 캐시에 저장")

# CIO 호출 시 캐시 전달
run_portfolio_rebalance(ai_selection_info=ai_selection_cache)
```

**③ CIO 프롬프트 생성** (`ai_strategy/cio.py` Line 1630-1678):
```python
# 파라미터로 받은 AI 선정 정보를 프롬프트에 포함
if ai_selection_info:
    ai_selection_section = f"""
# 🤖 AI 자동편입 최신 결과
- **시스템이 선정한 유망 코인**: AI가 듀얼 퍼널 3단계 검증을 통과한 코인들입니다.
- **중요**: 이 코인들은 백테스팅을 통과한 검증된 종목이므로, 특별한 근거 없이 0% 배정을 금지합니다.

   1순위: **VIRTUAL** - ✅ VERIFIED (Sharpe: 5.75)
   2순위: **ENA** - ✅ VERIFIED (Sharpe: 1.77)

**⚠️ 필수 확인**: VERIFIED 코인을 0% 배정하려면 반드시 '계층 0.5: VERIFIED 체크리스트' 3가지 예외 조건 중 1개 이상을 충족해야 합니다.
    """
```

**데이터 흐름** (3단계 파이프라인):
```
[AI 자동편입] data_manager/universe.py
      ↓ Tuple 반환: (active_coins, ai_selection_info)
[main.py] ai_selection_cache = ai_selection_info (메모리 저장)
      ↓ 파라미터 전달
[CIO] recalculate_portfolio_weights(ai_selection_info=cache)
      ↓ 프롬프트 포함
[AI 판단] 정보 제공 후 자율적 판단
```

**효과**:
- ✅ DB 복잡도 제거: 스키마 변경 없이 임시 데이터 전달
- ✅ 정보 파이프라인 구축: AI 자동편입 → CIO 완전 연계
- ✅ AI 자율성 유지: 정보 제공 후 CIO가 자율적으로 판단 (VIRTUAL/ENA 상관관계 리스크로 제외)
- ✅ 검증 가능성: 프롬프트 로그에서 전체 과정 추적 가능

**검증**:
- AI 자동편입 로그: "📋 [Fix 4] AI 선정 정보 2개 코인을 캐시에 저장 (CIO 전달용)"
- CIO 프롬프트: "🤖 AI 자동편입 최신 결과" 섹션 포함 확인
- CIO 자율 판단: VIRTUAL/ENA를 상관관계 리스크(SOL과 0.79, 0.80)로 0% 배정
- Process2 실행: AVNT 10% 추가매수 (CIO 목표 5% 달성 위해)

---

#### 통합 효과

**프로세스 흐름**:
```
[AI 자동편입] 신규 유망 코인 발굴 (CIO 관리 코인 제외)
      ↓ (순위, 티어, Sharpe 정보 메모리 전달)
[CIO] 포트폴리오 전략 수립 (AI 선정 정보 참고하여 자율 판단)
      ↓ (DB에 목표비중, 목표수익률, 손절률 저장)
[Process2] 실시간 매매 타이밍 판단 (CIO 전략 동기화 검증 후 실행)
```

**핵심 원칙**:
- ✅ **역할 분리**: AI 자동편입(발굴), CIO(전략), Process2(실행)
- ✅ **정보 연계**: 메모리 캐시 기반 파이프라인으로 데이터 흐름 구축
- ✅ **AI 자율성**: 명시적 규칙 강요 없이 정보 제공 후 자율 판단
- ✅ **데이터 일관성**: 타임스탬프 기반 동기화 검증

**수정된 파일**:
- `data_manager/universe.py`: Fix 1 (제외 로직), Fix 4 (Tuple 반환)
- `main.py`: Fix 2 (동기화 로직), Fix 4 (글로벌 캐시)
- `ai_strategy/cio.py`: Fix 4 (프롬프트 생성)
- `ai_strategy/prompts/cio_base_rules.txt`: Fix 3 (체크리스트)

**관련 문서 업데이트**:
- `docs/dev_guide/AI자동편입_명세서.md`: v1.1 (Fix 1)
- `docs/dev_guide/CIO비중_명세서.md`: v1.2 (Fix 3, Fix 4)
- `docs/dev_guide/매매판단_명세서.md`: v1.1 (Fix 2)

---

### 3.2 프로세스 연계 개선 (2025-10-24)

**작성일**: 2025-10-24

#### 개선 내용

Process1, CIO, Process2의 연계 구조를 명확히 정의하고 각 프로세스의 책임을 재정의했습니다.

#### 핵심 원칙

1. **CIO는 전략가** - 목표 비중 설정
2. **Process2는 실행자** - CIO 목표를 읽어서 매매
3. **Process1은 감시자** - 긴급 상황 감지 시 CIO 호출

---

### 3.3 재평가 상태 관리 시스템 구축 (2025-10-25) ⭐

**작성일**: 2025-10-25

#### 배경 및 문제 인식

**문제 상황**:
```
1. 스몰캡/미드캡/라지캡 보유 (암호화폐 고변동성)
   ↓
2. 상승 추세 → 트레일링 스탑 전량 익절 ✅
   ↓
3. 익절 다음 날, 전날 고점 대비 더 많은 상승 발생 📈
   ↓
4. 문제: 좋은 종목의 상승 추세를 끝까지 따라가지 못함 ❌
```

**근본 원인**:
- ❌ 트레일링 스탑 자체의 문제가 아님
- ✅ **암호화폐 고변동성**으로 인한 일시 조정 후 재상승 패턴
- ✅ **모든 시가총액 코인**에서 발생 (스몰캡 변동성이 특히 크지만 전체 적용)

**기존 방식의 한계**:
```
익절 완료 → holding_status.관리상태 = '제외' → 재상승 놓침 ❌
```

#### 해결 방안: "재평가" 상태 도입

**새로운 흐름**:
```
익절 완료 → holding_status.관리상태 = '재평가' → 추세 감시 → 재진입 포착 ✅
```

**"재평가" 상태의 본질**:
- ✅ **전량 익절 완료** (수익 실현)
- ✅ **추세 감시 지속** (포트폴리오에서 완전히 제외하지 않음)
- ✅ **재진입 기회 포착** (상승 시그널 시 '활성' 전환)
- ✅ **불필요한 재진입 방지** (하락 시그널 시 '제외' 전환)

#### 관리상태 3단계 시스템

| 상태 | 의미 | 보유수량 | GPT보유비중 | 전환 조건 |
|-----|------|---------|------------|----------|
| **활성** | 현재 포트폴리오 편입 | > 0 or 0 (매수 대기) | > 0% | 트레일링 스탑 익절 → 재평가 |
| **재평가** ⭐ | 전량 익절 후 추세 감시 | 0 (수익 실현 완료) | 0% | 상승 시그널 → 활성 <br> 하락 시그널 → 제외 |
| **제외** | 포트폴리오 완전 종료 | 0 | 0% | - |

#### 구현 세부사항

**① 트레일링 스탑 → '재평가' 전환 로직**:

**코드 위치**: `trade_manager.py` Lines 914-925 (execute_sell 함수)

```python
# 트레일링 스탑에 의한 전량익절인 경우 '재평가' 상태로 전환
is_trailing_stop_profit = (
    decision_type in ['전량익절', '전량익절(전량 전환)'] and
    final_reason and '트레일링' in final_reason and
    profit_amount > 0
)

if is_trailing_stop_profit:
    logger.info(f"🔄 [{symbol}] 트레일링 스탑 익절 완료. 관리상태를 '재평가'로 변경합니다.")
    db_manager.update_holding_status(symbol, {'관리상태': '재평가'})
else:
    logger.info(f"📤 [{symbol}] 시스템 규칙 매도 완료. 관리상태를 '제외'로 변경합니다.")
    db_manager.update_holding_status(symbol, {'관리상태': '제외'})
```

**트리거 흐름**:
- `main.py` Line 192: `check_profit_loss_triggers()` → 트레일링 스탑 감지
- `main.py` Line 203: `execute_sell(reason="동적 트레일링 스탑...")` 호출
- `trade_manager.py`: `'트레일링' in final_reason` 체크 → '재평가' 전환

**② CIO 재진입 허용 로직**:

**코드 위치**: `ai_strategy/cio.py` Lines 2433-2443

```python
if current_management_status == '재평가':
    if new_status_from_ai == '제외':
        # 하락 시그널 → 제외 확정 (허용)
        final_management_status = '제외'
    elif new_status_from_ai == '활성':
        # [재평가 로직 활성화] 상승 시그널 → 재진입 허용 ⭐
        final_management_status = '활성'
        logger.info(f"🔄 [{symbol}] CIO 재진입 판단: '재평가' → '활성' 전환")
    # else: '재평가' 유지 (CIO가 아직 판단 보류)
```

**⚠️ 중요**: CIO가 비중 > 0% 할당 시에만 '활성' 전환 (ai_selected_symbols 조건)

**CIO 평가 시나리오**:

1. **상승 시그널 포착** → '활성' 전환 + 목표 비중 설정
   ```
   CIO 판단: "MA120 위 유지 + MACD 상승. 추세 지속"
   → management_status: '재평가' → '활성'
   → GPT보유비중: 0% → 5%
   → Process2: 5% 매수 실행
   ```

2. **하락 시그널 포착** → '제외' 전환
   ```
   CIO 판단: "MA120 이탈 + MACD 하락. 추세 종료"
   → management_status: '재평가' → '제외'
   → GPT보유비중: 0% 유지
   → Process2: 더 이상 분석 대상 아님
   ```

3. **신호 불분명** → '재평가' 유지
   ```
   CIO 판단: "추세 불분명. 관찰 지속"
   → management_status: '재평가' 유지
   → GPT보유비중: 0% 유지
   → Process2: HOLD
   ```

#### 재진입 평가 원칙

**CIO는 매 정기 호출 시 "재평가" 코인도 분석 대상에 포함**:

1. **상승 시그널 확인**: MA120 위 유지 + MACD 상승 전환
2. **과거 수익 검증**: 이미 트레일링 스탑으로 수익 실현한 종목
3. **현재 활성 코인과 비교**: 상대 매력도 평가 필수
4. **변동성 고려**: 일시 조정은 정상 (추세 유지 여부 확인)

**철학 강조**:
> **"재평가" 상태의 자산은 과거의 영광입니다.**
>
> 이 자산의 재진입 가능성을 평가하되, **현재 시장에서 새롭게 나타난 '활성' 상태의 유망주들과의 상대적 매력도를 반드시 비교하십시오.**
>
> 만약 새로운 기회가 더 크다고 판단되면, 과거의 승리에 얽매이지 말고 과감히 '재평가' 자산의 목표 비중을 0으로 유지하거나 '관리상태'를 '제외'하여 새로운 기회에 자본을 재배치하십시오.

#### 시나리오 예시

**시나리오: SOPH 트레일링 스탑 익절 후 재진입**

```
Day 1 (10:00): SOPH 트레일링 스탑 익절
  ├─ Process2 실행: 전량 매도 (100%)
  ├─ holding_status.관리상태 = '재평가'
  ├─ holding_status.보유수량 = 0
  └─ holding_status.GPT보유비중 = 0%

Day 2 (09:00): CIO 정기 평가
  ├─ SOPH 분석: "익절 후 재상승 (+10%)"
  │
  ├─ Case A: 상승 시그널 포착 ✅
  │   ├─ MA120 위 유지 (+5%)
  │   ├─ MACD 1일봉 상승 전환
  │   ├─ 현재 활성 코인과 비교: SOPH 매력도 우위
  │   ├─ CIO 판단: "추세 지속, 재진입"
  │   ├─ management_status: '재평가' → '활성'
  │   ├─ GPT보유비중: 0% → 5%
  │   └─ Process2: 5% 매수 실행
  │
  └─ Case B: 하락 시그널 포착 ❌
      ├─ MA120 이탈 (-3%)
      ├─ MACD 1일봉 데드크로스
      ├─ CIO 판단: "추세 종료, 제외 확정"
      ├─ management_status: '재평가' → '제외'
      └─ GPT보유비중: 0% 유지

Day 2 (10:00): Process2 실행 (Case A 시)
  ├─ CIO 목표: 5% (현재 0%)
  ├─ G섹터 신호: 긍정적 (MA120 위, MACD 상승)
  ├─ 판단: BUY
  ├─ percentage: 5.0
  ├─ reason: "CIO 재진입 판단. 익절 후 추세 재확인. G섹터 긍정적"
  └─ 5% 매수 실행 ✅
```

#### 효과

**Before (기존 방식)**:
```
트레일링 스탑 익절 → '제외' 상태 → 재상승 놓침 ❌
→ 좋은 종목의 상승 추세를 끝까지 따라가지 못함
```

**After (재평가 시스템)**:
```
트레일링 스탑 익절 → '재평가' 상태 → 추세 감시 → 재진입 포착 ✅
→ 암호화폐 고변동성 대응, 추세 끝까지 추적
```

**핵심 개선점**:
- ✅ **추세 추적 능력 강화**: 일시 조정 후 재상승 패턴 대응
- ✅ **수익 극대화**: 좋은 종목의 상승 추세 끝까지 따라가기
- ✅ **리스크 관리**: 하락 추세 전환 시 즉시 '제외' 전환
- ✅ **AI 자율 판단**: 상승/하락 시그널을 CIO가 종합 분석

#### 수정된 파일 (v1.2 업데이트 - 실제 구현 반영)

**프롬프트 파일**:
- `ai_strategy/prompts/cio_aggressive.txt` (Lines 91-96): 재평가 자산관리 원칙 추가
- `ai_strategy/prompts/cio_neutral.txt` (Lines 79-84): 재평가 자산관리 원칙 추가
- `ai_strategy/prompts/cio_defensive.txt` (Lines 26-27): 재평가 자산관리 원칙 (기존 존재)

**로직 파일**:
- `trade_manager.py` (Lines 914-925): 트레일링 스탑 → '재평가' 전환 로직 구현 ⭐
- `ai_strategy/cio.py` (Lines 2437-2440): '재평가' → '활성' 재진입 허용 로직 구현 ⭐
- `supabase_adapter.py` (Lines 250-254): 중복 로직 제거 (충돌 해결)

**문서 파일**:
- `docs/dev_guide/CIO비중_명세서.md`: v1.4 → v1.5 (실제 구현 내용 반영)
- `docs/dev_guide/매매판단_명세서.md`: v1.3 → v1.4 (실제 구현 내용 반영)
- `docs/dev_guide/트레이딩봇_수정이력.md`: v1.1 → v1.2 (Section 3.3 업데이트)

#### 관련 문서

- **CIO비중_명세서**: [Section 3.4 재평가 상태 관리 원칙](CIO비중_명세서.md#34-재평가-상태-관리-원칙--추세-추적-시스템)
- **매매판단_명세서**: [Section 3.5 재평가 상태 코인 처리 원칙](매매판단_명세서.md#35-재평가-상태-코인-처리-원칙-)

---

### 3.4 트레일링 스탑 AI 프롬프트 개선 (2025-10-25)

> **작성일**: 2025-10-25
> **버전**: v1.3
> **목적**: ATR 멀티플라이어 동적 계산 정보를 AI에게 정확히 전달

#### 문제점

**AI가 받던 프롬프트 (기존)**:
```
시스템 트레일링 스탑: 12% 활성화, 8% 거리로 자동 익절
```
- **문제**: AI가 "고정 8% 거리"로 이해
- **실제**: ATR × 3.0 멀티플라이어 방식으로 2%~8% 범위 내 동적 계산

#### 개선 내용 (2가지 파일 수정)

**1. prompts.py (Lines 58-73) - 동적 설정값 5개 전달**:
```python
# 변경 전: 고정값 2개만 전달
activation_threshold = 12.0
distance_threshold = 8.0

# 변경 후: 동적 설정값 5개 전달
activation_threshold = 12.0
use_atr_trailing = True
atr_multiplier = 3.0      # ⭐ 핵심 추가
min_distance = 2.0        # ⭐ 핵심 추가
max_distance = 8.0        # ⭐ 핵심 추가
```

**2. cio_base_rules.txt (Lines 220-227, 409-416) - ATR 동적 계산 설명**:
```
AI가 받는 프롬프트:
  * 동적 거리 계산: ATR% × 3.0
  * 범위 제한: 최소 2.0% ~ 최대 8.0%
  * 핵심 특징: 시장 변동성(ATR)에 따라 유연하게 조절
```

#### 효과

| 항목 | Before | After |
|------|--------|-------|
| AI 인식 | "고정 8% 거리" | "ATR × 3.0 동적 계산" |
| 변동성 대응 | 설명 없음 | "2%~8% 범위 자동 조절" |
| 전달 정확도 | 불완전 | 완전 (5개 설정값 모두 전달) |

#### 수정 파일

- `ai_strategy/prompts.py` (Lines 58-73)
- `ai_strategy/prompts/cio_base_rules.txt` (Lines 220-227, 409-416)
- `docs/dev_guide/매매판단_명세서.md`: v1.4 → v1.5 (Section 3.6 추가)
- `docs/dev_guide/트레이딩봇_수정이력.md`: v1.2 → v1.3 (Section 3.4 추가)

#### 관련 문서

- **매매판단_명세서**: [Section 3.6 트레일링 스탑 시스템](매매판단_명세서.md#36-트레일링-스탑-시스템-)

---

## 4. AI 자동편입 개선 이력

### 4.1 AI 자동편입 검증 (2025-10-22)

#### 검증 목적

듀얼 퍼널 시스템 (Momentum Hunter + Quality Compounder)의 정확성 검증

#### 검증 결과

- ✅ Momentum Hunter 정상 작동
- ✅ Quality Compounder 정상 작동
- ✅ AI 최종 면접 로직 검증 완료
- ✅ 1-2순위 holding_status 저장 확인
- ✅ 3-4순위 coin_watch_history 저장 확인

---

### 4.2 AI 자동편입 고도화 (2025-10-22)

#### 고도화 내용

1. **백테스팅 시스템 강화**
   - Adaptive Backtest: 데이터 부족 시 대체 검증
   - Mini Backtest: 빠른 검증 (7일 데이터)

2. **듀얼 퍼널 스코어링 개선**
   - Momentum Score = 가격 변화율 × 거래량 비율
   - Quality Score = log(거래대금) × (1 / 변동성)

3. **AI 최종 면접 강화**
   - 섹터 분석 추가
   - 리스크 요소 종합 평가

---

### 4.3 AI 자동편입 데이터 수집 수정 (2025-10-22)

#### 수정 내용

1. **병렬 데이터 수집** - ThreadPoolExecutor 사용
2. **캐싱 전략** - TTL 5분으로 API 호출 최소화
3. **에러 핸들링** - 재시도 로직 강화

---

### 4.4 AI 자동편입 최종 검증 (2025-10-22)

#### 검증 항목

- ✅ 상위 4개 선정 정확성
- ✅ 순위별 저장 로직
- ✅ 중복 편입 방지
- ✅ CIO 트리거 정상 작동

---

## 5. CIO 포트폴리오 개선 이력

### 5.1 CIO 개선 검증 완료 (2025-10-22)

#### 검증 내용

1. **목표 비중 설정 로직 검증**
   - GPT보유비중 정확성
   - GPT목표수익률/손절률 합리성

2. **AI 자동편입 존중 원칙 검증**
   - VERIFIED 코인 예외적 제외만 허용
   - 일관성 테스트 통과

---

### 5.2 CIO 개선 완료 (2025-10-22)

#### 개선 사항

1. **프롬프트 구조화**
   - Part 0: 정체성
   - Part 1: 목표 비중
   - Part 2: 리스크 관리
   - Rationale: 전략 요약

2. **비중 정규화 로직 추가**
   - 총합 100% 보장
   - 반올림 오차 자동 보정

---

### 5.3 CIO 포트폴리오 프롬프트 검토 (2025-10-22)

#### 검토 결과

- ✅ 핵심 철학 명확화
- ✅ 판단 원칙 우선순위 정립
- ✅ 시나리오 라이브러리 구축
- ✅ 검증 체크리스트 수립

---

## 6. 긴급도 시스템 개선

### 6.1 긴급도 시스템 최종 단순화 (2025-10-23)

#### 단순화 원칙

**"Simple is Best" - 복잡한 임계값보다 AI의 자율 판단을 신뢰**

#### 주요 변경

1. **동적 임계값 제거** - 고정 임계값 75점 사용
2. **긴급도 타입 단순화** - individual_coin, market_regime_change 두 가지만
3. **AI 판단 강화** - Gemini의 빠른 분석 활용

---

### 6.2 Process1 긴급도 시스템 분석 (2025-10-23)

#### 분석 결과

- ✅ 5분마다 실시간 모니터링
- ✅ 긴급 상황 감지 시 즉시 CIO 호출
- ✅ 1시간 주기보다 12배 빠른 대응

---

### 6.3 Process1 긴급도 시스템 최종 제안 (2025-10-23)

#### 최종 제안

1. **긴급도 점수 75점 이상** → CIO 즉시 호출
2. **개별 코인 긴급도** → 해당 코인만 CIO 분석
3. **시장 체제 전환** → 전체 포트폴리오 재평가

---

### 6.4 Process1 긴급도 시스템 구현 가이드 (2025-10-23)

#### 구현 단계

1. Process1에서 15분봉 데이터 수집
2. AI 긴급도 분석 호출 (Gemini)
3. 긴급도 75점 이상 시 emergency_coins 생성
4. CIO 즉시 호출 (recalculate_portfolio_weights)
5. Process2 트리거

---

### 6.5 Process2 즉시 매수 상세 분석 (2025-10-23)

#### 분석 내용

- Process2는 CIO 목표를 읽어서 매매 실행
- 긴급 상황 시에도 동일한 로직 적용
- GPT매매비중으로 단계적 매수 진행

---

## 7. 주요 기능 설명

### 7.1 AI 자동편입

**파일 위치**: `data_manager/universe.py`, `ai_strategy/market_analysis.py`

#### 듀얼 퍼널 시스템

1. **Momentum Hunter (모멘텀 사냥꾼)**
   - 단기 급등 가능성 포착
   - 거래량 급증 + 가격 상승률 분석

2. **Quality Compounder (품질 컴파운더)**
   - 장기 안정 성장 가능성 포착
   - 시가총액 + 안정성 + 120일선 분석

3. **AI 최종 면접**
   - 두 퍼널 결과 종합 평가
   - 상위 4개 선정

#### 순위별 처리

- **1-2순위**: `holding_status`에 '활성' 상태로 즉시 저장 → CIO 호출
- **3-4순위**: `coin_watch_history`에 '관심' 상태로 저장 → Process1 모니터링

---

### 7.2 CIO 비중

**파일 위치**: `ai_strategy/cio.py`

#### 역할

CIO는 **전략가**로서 다음을 결정:

1. **포트폴리오 구성** - 어떤 코인을 보유할지, 각 코인의 목표 비중
2. **리스크 관리** - 목표 수익률, 손절 기준선
3. **상태 관리** - 활성/재평가/관심/제외 상태 결정

#### CIO 호출 조건

1. 첫 실행
2. 24시간 경과
3. 정기 재평가 (09:00, 21:40, 04:00)
4. 신규 편입 코인 (AI 자동편입 1-2순위)
5. 개별 코인 긴급도
6. 시장 체제 전환

#### 출력 결과

- `GPT보유비중`: 목표 포트폴리오 비중 (%)
- `GPT목표수익률`: 목표 수익률 (%)
- `GPT목표손절률`: 손절 기준선 (%)
- `관리상태`: 활성/재평가/관심/제외
- `cio_latest_rationale`: CIO 판단 근거

---

### 7.3 매매판단

**파일 위치**: `ai_strategy/process2.py`, `trade_manager.py`

#### 역할

Process2는 **실행자**로서 다음을 결정:

1. **매매 판단** - 신규매수/추가매수/매도/보유
2. **매매 비중 결정** - GPT매매비중 (0-100%)
3. **실제 거래 실행** - 업비트 API 호출

#### GPT보유비중 vs GPT매매비중

| 구분 | 설정 주체 | 의미 | 예시 |
|------|----------|------|------|
| **GPT보유비중** | CIO (전략가) | 포트폴리오에서 이 코인의 목표 비중 | BTC 30% (전체 자산의 30%) |
| **GPT매매비중** | Process2 (실행자) | 한 번에 채울 비중 (0-100%) | 50% (목표의 절반만 진입) |

#### Auto-escalation

목표 비중 달성 시간 10배 가속:
- 목표 갭 20%p 이상 → 3배 가속
- 목표 갭 10%p 이상 → 2배 가속
- 목표 갭 5%p 이상 → 1.5배 가속

#### Smart Fractional

목표 갭의 65%를 1회 매수로 최소 보장

#### TWAP 분할 매매

- 3회 split
- 소액은 단일 주문으로 통합
- 1건으로 통합 기록 (거래 기록 67% 감소)

---

### 7.4 기타 기능

**파일 위치**: `docs/기타기능.md`

#### 포함 기능

1. **익절/손절 시스템**
   - 트레일링 스탑
   - 동적 손절선 (ATR 기반)

2. **서킷브레이커**
   - 일일 손실 제한
   - 거래 중단 조건

3. **포트폴리오 동기화**
   - 5분마다 보유 현황 업데이트
   - DB와 실제 잔고 일치

4. **일일 리포트**
   - 매일 09:05 자동 생성
   - 누적 수익률, 승률, 손익비

5. **AI 브리핑**
   - 매일 20:00, 21:00, 22:00, 23:00
   - CIO 일일 보고서 생성

---

## 8. 통합 완료 파일 목록

### 8.1 Architecture (3개)

- ✅ ARCHITECTURE_COINCONFIG_VS_DB.md
- ✅ GITIGNORE_STRUCTURE.md
- ✅ TRADING_BOT_PROCESS_FLOW.md

### 8.2 Optimization (4개)

- ✅ DATA_MANAGER_SPLIT_GUIDE.md
- ✅ DEPLOYMENT_SUCCESS.md (파일 크기 초과로 요약만 포함)
- ✅ LOG_IMPROVEMENT.md
- ✅ OPTIMIZATION_MASTER_PLAN.md (파일 크기 초과로 요약만 포함)

### 8.3 Process Analysis (12개)

- ✅ ai자동편입_검증_251022.md
- ✅ ai자동편입_고도화_251022.md
- ✅ ai자동편입_데이터수집_수정_251022.md
- ✅ ai자동편입_최종검증_251022.md
- ✅ cio_개선_검증_완료_251022.md
- ✅ cio_개선_완료_251022.md
- ✅ cio포트폴리오_프롬프트_검토_251022.md
- ✅ PROCESS_URGENCY_FINAL_SIMPLE_TRUTH.md
- ✅ PROCESS1_URGENCY_SYSTEM_ANALYSIS.md
- ✅ PROCESS1_URGENCY_SYSTEM_FINAL_PROPOSAL.md
- ✅ PROCESS1_URGENCY_SYSTEM_IMPLEMENTATION_GUIDE.md
- ✅ PROCESS2_IMMEDIATE_BUY_DETAILED_ANALYSIS.md

### 8.4 Docs Root (6개)

- ✅ AI자동편입.md
- ✅ CIO비중.md
- ✅ 매매판단.md
- ✅ 기타기능.md
- ✅ 프로세스연계개선_1024.md
- ✅ DEVELOPMENT_GUIDE.md (dev_guide/README.md로 이동)

---

## 9. 참고 자료

### 9.1 내부 문서

- [README.md](./README.md) - 개발 가이드 총괄
- [AI자동편입_명세서.md](./AI자동편입_명세서.md) - AI 자동편입 프롬프트 명세
- [CIO비중_명세서.md](./CIO비중_명세서.md) - CIO 프롬프트 명세
- [매매판단_명세서.md](./매매판단_명세서.md) - Process2 프롬프트 명세

### 9.2 코드 파일

- `main.py` - 시스템 진입점
- `config.py` - 전역 설정
- `trade_manager.py` - 거래 실행
- `supabase_adapter.py` - DB 관리
- `ai_strategy/` - AI 전략 모듈
- `data_manager/` - 데이터 수집 모듈

---

**📅 최종 업데이트**: 2025-10-24
**📦 작성자**: AI Trading Bot Team
**📝 통합 대상**: 25개 MD 파일 → 1개 통합 문서
