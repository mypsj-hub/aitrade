# CIO 포트폴리오 비중 함수 완전 분석 및 개혁안

**분석 일자:** 2025-10-15
**운영 결과:** 40일간 1000만원 → 700만원 (-30% 손실)
**목표:** 근본적인 개혁을 통한 체계적 포트폴리오 구성

---

## 🎯 개혁 4대 핵심 원칙 (Reform Principles)

### ✅ 원칙 1: AI 자율 의사결정 우선
**"AI가 직접 분석하고 판단해서 스스로 모든 것을 결정"**

- ❌ **지양**: 명시적 하드코딩 규칙 (예: `MAX_SINGLE_POSITION = 20%`)
- ✅ **지향**: AI가 상황에 맞춰 스스로 판단하도록 프롬프트로 유도
- **이유**: 시장은 끊임없이 변화하며, 고정된 규칙은 특정 상황에서 오히려 독이 될 수 있음. AI가 맥락을 이해하고 유연하게 대응하도록 해야 함.

**예시:**
```python
# ❌ 나쁜 방식: 하드코딩 규칙
if weight > 20:
    weight = 20  # 강제 제한

# ✅ 좋은 방식: AI 프롬프트로 유도
"""
포트폴리오의 안정성을 위해, 단일 자산에 과도하게 집중하는 것은
큰 리스크를 초래할 수 있습니다. 현재 시장 변동성과 자산의
안정성을 종합적으로 고려하여 적절한 비중을 스스로 판단하십시오.
"""
```

---

### ✅ 원칙 2: 6개월 프롬프트 개선 성과 보존
**"현재 프롬프트는 6개월 이상의 모든 문제점을 보완해온 노력의 결과물"**

- ❌ **지양**: 프롬프트 전면 삭제 후 신규 작성
- ✅ **지향**: 기존 프롬프트 보완 및 개선 (점진적 진화)
- **이유**: 현재 프롬프트에는 수많은 실전 경험과 개선 사항이 녹아있음. 이를 무시하면 같은 실수를 반복하게 됨.

**보존해야 할 핵심 요소:**
- 워뇨띠 투자 5대 원칙 (120일선, 추세 추종, 분할 원칙 등)
- 투자 연혁 존중 규칙 (Narrative Respect & Invalidation Rule)
- 거래 일관성 강화 (휩쏘 방지 규칙)
- 유동성 등급별 비중 제한
- 동적 페르소나 시스템 (공격형/방어형/중립형)
- 상관관계 리스크 관리
- 성과 피드백 및 AI 자기반성 지침

---

### ✅ 원칙 3: 기존 함수 최대 활용
**"무작정 신규 함수를 생성하는 것이 아니라 기존 함수를 최대한 활용"**

- ❌ **지양**: 비슷한 기능의 신규 함수 무분별 생성
- ✅ **지향**: 기존 함수 재사용 → 필요시에만 신규 생성 → 중복 제거

**기존 함수 분석:**
```python
# 이미 존재하는 함수들 (재사용 가능)
_prepare_rebalance_data_and_prompt()  # 데이터 수집 및 프롬프트 생성
get_technical_indicators()             # 기술적 지표
get_liquidity_grades()                 # 유동성 등급
calculate_portfolio_volatility()       # 포트폴리오 변동성
get_trade_history_for_coin()          # 거래 히스토리
get_performance_metrics()              # 성과 지표
_generate_strategic_dilemma_text()    # 전략적 딜레마 생성
update_portfolio_weights()             # 비중 업데이트
upsert_report_rationale()              # CIO 보고서 저장
```

**개혁 시 접근 방식:**
1. 기존 함수 먼저 확인 → 수정 가능한지 검토
2. 완전히 다른 로직이 필요할 때만 신규 함수 생성
3. 신규 함수 생성 시, 기존 중복 함수는 제거하여 코드 최적화

---

### ✅ 원칙 4: CIO 역할 재정립 - 전략 계획 vs 전술 실행 명확화
**"CIO는 전략 계획(What), Process2는 전술 실행(How & When)"**

#### 현재 문제점:
```python
# 현재: Process2(매매 판단)가 GPT목표수익률/손절률 설정
# ai_strategy.py:1290-1291, 1344-1345
decision = {
    "coin": "BTC",
    "매매판단": "추가매수",      # ← Process2가 결정
    "GPT목표수익률": 15,         # ← Process2가 설정
    "GPT목표손절률": -7,         # ← Process2가 설정
    ...
}
```

**문제:**
- ❌ **역할 역전**: 하위 조직(Process2)이 전략 목표를 설정하고, 상위 조직(CIO)은 비중만 결정
- ❌ **일관성 부재**: Process2는 개별 코인만 보고 목표 설정 → 포트폴리오 전체 리스크 고려 안 함
- ❌ **책임 소재 불명확**: 목표 설정 실패 시 CIO vs Process2 중 누구 책임인지 모호
- ❌ **매매판단 중복**: CIO가 "비중 확대"를 결정하면 Process2가 "추가매수"를 그대로 실행 → 역할 중복

#### 개선 방향: 전략 계획 vs 전술 실행 명확화

```
현재 구조 (잘못됨):
┌─────────────────┐
│  CIO (Process3) │  ← "비중만" 결정
│                 │     예: BTC 20% 할당
└─────────────────┘
         ↓ 비중 전달
┌─────────────────┐
│  Process2       │  ← 목표 설정 + 매매 판단 + 타이밍까지 모두 결정
│                 │     1. 목표수익률 15% 설정
│                 │     2. "추가매수" 결정
│                 │     3. 즉시 매수 or 분할 매수 결정
└─────────────────┘

개선된 구조 (전략 vs 전술 분리):
┌─────────────────┐
│  CIO (Process3) │  ← 전략 계획 (What)
│  전략 계획가     │     1. 비중: BTC 20% 할당
│                 │     2. 목표: 수익률 15%, 손절 -7%
│                 │     3. 방향: "비중 확대 필요" (전략적 지시)
└─────────────────┘
         ↓ 전략 지시 (비중 + 목표 + 방향)
┌─────────────────┐
│  Process2       │  ← 전술 실행 (How & When)
│  전술 실행가     │     1. CIO 지시: "BTC 비중 15% → 20% 확대"
│                 │     2. 현재 시장 분석: RSI 과매수, 눌림목 대기 필요
│                 │     3. 최적 타이밍 계산: 3일간 분할 매수 계획
│                 │     4. 실행 결정: "오늘 1차 추가매수 (목표의 30%)"
└─────────────────┘
```

---

#### 역할 구분 상세 (전략 vs 전술)

**CIO (전략 계획가)의 역할:**
```
"무엇을(What) 얼마나(How Much) 언제까지(Target)"

1. 포트폴리오 전체 구성
   - 어떤 코인에 투자할지 (BTC, ETH, SOL...)
   - 각 코인의 목표 비중 (BTC 20%, ETH 15%...)
   - 섹터 밸런스 (Layer 1 50%, DeFi 20%...)

2. 전략적 목표 설정
   - 각 코인의 목표 수익률 (BTC 15%, SOL 25%...)
   - 각 코인의 손절률 (BTC -7%, SOL -10%...)
   - 포트폴리오 전체 리스크 관리

3. 전략적 방향 지시
   - "BTC 비중 15% → 20% 확대"
   - "ETH 비중 10% → 5% 축소"
   - "현금 비중 30% → 40% 확보"
```

**Process2 (전술 실행가)의 역할:**
```
"어떻게(How) 언제(When) 얼마씩(How Much Detail)"

1. CIO 전략 지시 수신
   - CIO: "BTC 비중 15% → 20% 확대 (목표수익률 15%, 손절 -7%)"

2. 현재 시장 상황 분석 (전술 판단)
   - RSI 75 (과매수 구간) → 즉시 매수는 위험
   - 120일선 위치: +5% (매수 구간이지만 상승 과열)
   - 호가 불균형: +15% (매도 우세)
   - 최적 거래 타이밍: 눌림목 대기 필요

3. 최적 실행 전략 수립
   - 목표: 5% 비중 확대 (현재 평가액 1000만 기준 = 50만원 추가 매수)
   - 전략: 3일간 분할 매수
     - 1일차: 15만원 (목표의 30%) → RSI 70 이하 시 실행
     - 2일차: 20만원 (목표의 40%) → 120일선 근접 시 실행
     - 3일차: 15만원 (목표의 30%) → 잔여 금액 실행

4. 오늘의 실행 결정
   - 판단: "매매보류" or "추가매수(1차, 30%)"
   - 근거: "RSI 75로 과매수. 70 이하 눌림목 대기 후 1차 매수 예정"
```

---

#### 실제 작동 예시: BTC 비중 확대 시나리오

**시나리오:** CIO가 BTC 비중을 15% → 20%로 확대하기로 결정

**Step 1: CIO 전략 결정 (매일 1회)**
```json
{
    "weights": [
        {"asset": "BTC", "weight": 20}  // 15% → 20% 확대
    ],
    "targets": {
        "BTC": {
            "target_profit": 15,
            "stop_loss": -7,
            "rationale": "BTC는 현재 상승 추세 강함. 포트폴리오 안정성 위해 보수적 목표 설정."
        }
    },
    "rationale": "BTC 모멘텀 강화 확인. 비중 확대하여 상승 추세 추종."
}
```

**Step 2: Process2 전술 판단 (매일 3회)**

**Day 1 오전 10시:**
```
CIO 지시: BTC 비중 15% → 20% 확대 필요
현재 보유: 150만원 (전체 1000만원 기준 15%)
목표 보유: 200만원 (전체 1000만원 기준 20%)
추가 매수 필요: 50만원

시장 분석:
- 현재가: 95,000,000원
- RSI: 75 (과매수 구간 ⚠️)
- 120일선: +5% (매수 구간 ✅)
- 호가 불균형: +15% (매도 우세 ⚠️)
- 최적 타이밍 점수: 40/100 (낮음)

전술 판단:
매매판단: "매매보류"
GPT매매비중: 0
거래사유: "CIO 지시로 비중 확대 필요하나, RSI 75 과매수 + 호가 매도 우세로 눌림목 대기.
          RSI 70 이하 or 호가 균형 시 1차 추가매수(30%) 예정."
```

**Day 2 오후 2시:**
```
CIO 지시: BTC 비중 15% → 20% 확대 필요 (계속 유효)
현재 보유: 150만원 (아직 매수 안 함)
목표 보유: 200만원
추가 매수 필요: 50만원

시장 분석:
- 현재가: 93,000,000원 (2% 하락 → 눌림목 발생!)
- RSI: 68 (과매수 해소 ✅)
- 120일선: +3% (매수 구간 ✅)
- 호가 불균형: -5% (매수 우세 ✅)
- 최적 타이밍 점수: 75/100 (좋음)

전술 판단:
매매판단: "추가매수"
GPT매매비중: 30  // 목표의 30%만 우선 매수
거래사유: "눌림목 발생 + RSI 68 적정 수준 + 호가 매수 우세로 1차 추가매수 실행.
          향후 120일선 근접 시 2차 추가매수(40%) 예정."
실제 매수 금액: 15만원 (50만원 목표의 30%)
```

**Day 3 오전 10시:**
```
CIO 지시: BTC 비중 15% → 20% 확대 필요 (계속 유효)
현재 보유: 165만원 (1차 매수 완료)
목표 보유: 200만원
추가 매수 필요: 35만원

시장 분석:
- 현재가: 94,000,000원 (1% 반등)
- RSI: 70 (중립)
- 120일선: +4% (매수 구간 ✅)
- 호가 불균형: 0% (중립)
- 최적 타이밍 점수: 65/100 (보통)

전술 판단:
매매판단: "추가매수"
GPT매매비중: 60  // 잔여 목표의 60% (전체 목표 대비 40%)
거래사유: "1차 매수 후 안정적 흐름. 목표 비중 달성 위해 2차 추가매수 실행."
실제 매수 금액: 20만원 (잔여 35만원의 60%)
```

**Day 5 오후 2시:**
```
CIO 지시: BTC 비중 15% → 20% 확대 필요 (계속 유효)
현재 보유: 185만원 (1차+2차 매수 완료)
목표 보유: 200만원
추가 매수 필요: 15만원 (최종)

시장 분석:
- 현재가: 92,000,000원 (2% 하락)
- RSI: 65 (적정)
- 120일선: +2% (120일선 근접! ✅)
- 최적 타이밍 점수: 80/100 (매우 좋음)

전술 판단:
매매판단: "추가매수"
GPT매매비중: 100  // 잔여 전액
거래사유: "120일선 근접 (워뇨띠 핵심 매수 타이밍) + RSI 적정. 3차 매수로 CIO 목표 비중 달성."
실제 매수 금액: 15만원 (잔여 전액)
```

**최종 결과:**
- **CIO 전략**: "BTC 15% → 20% 확대" (1일차 결정)
- **Process2 전술**: 5일간 3회 분할 매수로 목표 달성
  - 1차: 15만원 (눌림목 타이밍)
  - 2차: 20만원 (안정적 흐름)
  - 3차: 15만원 (120일선 근접)
- **평균 매수가**: 93,333,000원 (즉시 일괄 매수 대비 유리)

---

#### CIO가 목표를 설정해야 하는 이유 (보완)

1. **포트폴리오 전체 리스크 고려**: 변동성 큰 코인 3개 보유 시, 목표를 낮춰 리스크 분산
2. **시장 국면 반영**: 공포장에서는 모든 코인의 목표 손절률을 보수적으로 설정
3. **자산 간 균형**: BTC는 보수적 목표(10%/−5%), 알트코인은 공격적 목표(30%/−10%)
4. **일관된 전략**: CIO가 "현금 확보 전략"을 선택했다면, 모든 코인의 익절 목표를 낮춰 빠른 현금화
5. **전략과 전술 분리**: CIO는 "무엇을 얼마나", Process2는 "언제 어떻게" → 역할 명확화로 책임 소재 분명

**구현 방법:**
```python
# CIO JSON 응답에 targets 필드 추가
{
    "weights": [
        {"asset": "BTC", "weight": 20},
        {"asset": "ETH", "weight": 15}
    ],
    "targets": {  # ← 신규 추가
        "BTC": {
            "target_profit": 12,    # CIO가 포트폴리오 맥락에서 결정
            "stop_loss": -6,
            "rationale": "현재 포트폴리오 변동성 지수 65로 높은 상황. BTC는 안정 자산으로서 보수적 목표 설정하여 변동성 헷지."
        },
        "ETH": {
            "target_profit": 20,
            "stop_loss": -8,
            "rationale": "ETH/BTC 비율 강세로 알트 시즌 초입 판단. 공격적 목표 설정하여 상승 모멘텀 극대화."
        }
    },
    "rationale": "전체 전략 설명..."
}
```

---

## 📊 Part 1: 현재 구조 완전 분석

### 1.1 전체 아키텍처

```
recalculate_portfolio_weights()  # ai_strategy.py:1630-2018
├── 1. 분석 대상 선정
│   └── get_active_coin_list() → 활성/재평가 상태 코인
│
├── 2. 데이터 수집 (_prepare_rebalance_data_and_prompt)  # line 2019-2339
│   ├── 시장 데이터
│   │   ├── Fear & Greed Index
│   │   ├── BTC Dominance
│   │   ├── Market Trend (24h 변화율)
│   │   └── Portfolio Volatility Index
│   ├── 포트폴리오 데이터
│   │   ├── 현재 보유 현황
│   │   ├── 거래 히스토리
│   │   ├── 성과 지표 (승률, 손익비, 손익비 기반 AI 자기반성 지침)
│   │   └── 누적 수익률
│   └── 개별 코인 데이터 (각 코인별로 수집)
│       ├── 기술적 지표 (RSI, MACD, BB, Stoch, ATR, 다중 시간대)
│       ├── 차트 이미지 (base64)
│       ├── 120일선 위치 (워뇨띠 핵심)
│       ├── 거래 히스토리 & 맥락 (마지막 행동, 보유 일수)
│       ├── 투자 연혁 (최초 진입 thesis, 최근 활동)
│       ├── 상관관계 데이터
│       ├── 유동성 등급 (A/B/C)
│       ├── 최적 거래 타이밍
│       ├── 김치 프리미엄
│       ├── 트레일링 스탑 상태
│       └── 전략적 딜레마 텍스트
│
├── 3. AI 프롬프트 생성 (시장 상황별 동적 페르소나)  # line 1676-1821
│   ├── 공격형 CIO (탐욕장) - Alpha Hunter
│   ├── 방어형 CIO (공포장) - Risk Guardian
│   ├── 중립형 CIO (횡보장) - Balanced Strategist
│   └── Base Rules (공통 규칙)
│       ├── 워뇨띠 투자 5대 원칙
│       ├── 투자 연혁 존중 규칙 (★★★★★)
│       ├── 고급 판단 시스템 (유동성 등급별 비중 제한)
│       ├── 거래 일관성 강화 (휩쏘 방지 ★★★★★)
│       ├── 5단계 의사결정 프로세스
│       └── 차트 분석 기반 전략적 통찰
│
├── 4. AI 분석 요청 (OpenAI/Gemini)  # line 1837-1964
│   ├── OpenAI: JSON Schema (strict mode)
│   └── Gemini: JSON 형식 강제 프롬프트
│   └── JSON 응답: weights[], rationale, strategy_type, risk_level
│       └── (is_dynamic_mode 시) management_status 추가
│
└── 5. 결과 적용  # line 1965-2018
    ├── update_portfolio_weights(weights)
    ├── (is_dynamic_mode 시) 관리상태 업데이트
    ├── upsert_report_rationale(rationale)
    └── update_system_status('cio_last_run')
```

---

### 1.2 핵심 프롬프트 구조 분석

#### 📌 중요: 현재 프롬프트의 6개월 누적 개선 사항

현재 프롬프트는 다음과 같은 실전 경험을 통해 발전해왔음:

1. **투자 연혁 존중 규칙** (★★★★★): 보유 자산 비중 축소 시 최초 진입 논리 반박 필수
2. **거래 일관성 강화** (★★★★★): 매수 직후 급격한 비중 축소 금지 (휩쏘 방지)
3. **워뇨띠 5대 원칙**: 120일선 기준, 추세 추종, 분할 원칙, 감정 역이용, 알트 시즌 판단
4. **유동성 등급별 비중 제한**: A등급 40%, B등급 25%, C등급 15% (절대 규칙)
5. **성과 피드백 기반 자기반성**: 손익비 < 0.8 시 확신도 엄격 평가, 현금 비중 확대
6. **상관관계 리스크 관리**: 0.7 이상 페어 합계 40% 제한
7. **소액 비중 정리**: 3% 미만 코인 과감히 정리

#### 공격형 CIO (탐욕장) - ai_strategy.py:1676-1687
```python
aggressive_cio_prompt = """
당신은 시장의 모든 기회를 포착하여 수익을 극대화하는 '알파 사냥꾼' CIO입니다.
현재 시장은 강력한 상승 추세 또는 극심한 탐욕 국면입니다.

## 🔥 공격적 자산 배분 원칙
1. **변동성 연동 현금 관리**: 변동성 지수 50 미만 → 현금 10% 이하, 70 초과 → 현금 30% 이상
2. **주도주 집중 투자**: 가장 강력한 모멘텀을 가진 주도주에 30% 이상의 과감한 비중 할당
3. **추세 동조**: 상관관계 높은 자산이라도 모두 상승 추세라면 동반 비중 확대 검토
4. **원칙 충돌 해결**: '탐욕' 상태 현금 확보 원칙 < 강력한 '추세 추종' 우선
5. **규칙 적용 우선순위**: 일반 원칙과 충돌 시 이 공격적 원칙 최우선
6. **신규 기회 검증**: '신규 편입' 자산은 새로운 알파 후보 → 최소 탐색 비중 할당 우선 고려
7. **재평가 자산 관리**: '재평가' 자산은 과거의 영광 → 현재 '활성' 유망주와 비교 후 과감히 제외
"""
```

#### 방어형 CIO (공포장) - ai_strategy.py:1689-1701
```python
defensive_cio_prompt = """
당신은 어떤 상황에서도 자본을 지켜내는 '철벽 수비' 리스크 관리자 CIO입니다.
현재 시장은 깊은 하락 추세 또는 극심한 공포 국면입니다. '잃지 않는 것'이 유일한 목표입니다.

## 🛡️ 방어적 자산 배분 원칙
1. **변동성 연동 현금 극대화**: 변동성 지수 50 초과 → 현금 60% 이상, 70 초과 → 현금 80% 이상
2. **개별 자산 비중 제한**: 모든 자산 비중 상한선 15%로 제한
3. **상관관계 리스크 통제**: 상관도 높은 자산들 비중 합 20% 이하로 엄격 관리
4. **역발상 투자 최소화**: '공포' 상태 시 소량 분할 매수만, 대부분 현금 보유
5. **규칙 적용 우선순위**: 일반 원칙과 충돌 시 이 방어적 원칙 최우선
6. **신규 위험 평가**: '신규 편입' 자산은 검증되지 않은 위험 요소 → '제외' 기본, 강력한 방어적 근거 시만 '활성' 유지
7. **재평가 자산 관리**: '재평가' 자산은 과거의 영광 → 현재 '활성' 유망주와 비교 후 과감히 제외
"""
```

#### 중립형 CIO (횡보장) - ai_strategy.py:1704-1714
```python
neutral_cio_prompt = """
당신은 워뇨띠 전략을 완벽하게 구사하는 '균형잡힌' 포트폴리오 전략가 CIO입니다.
현재 시장은 방향성이 불분명한 중립 국면입니다. 리스크와 기회의 균형을 맞춰야 합니다.

## ⚖️ 균형적 자산 배분 원칙
1. **변동성 기반 현금 관리**: 변동성 지수 60 이상 → 현금 50% 이상, 40 이하 → 현금 30% 이하
2. **쏠림 투자 방지**: 특정 자산 비중 25%를 넘지 않도록
3. **선별적 집중**: 가장 유망한 1~2개 자산에 선별적으로 비중 집중
4. **규칙 적용 우선순위**: 이 균형적 원칙은 일반 원칙들과 조화
6. **신규 자산 검증**: '신규 편입' 자산은 증명되지 않은 '후보' → 객관적 검증 후 균형 판단
7. **재평가 자산 관리**: '재평가' 자산은 과거의 영광 → 현재 '활성' 유망주와 비교 후 과감히 제외
"""
```

#### Base Rules (공통 규칙) - ai_strategy.py:1780-1819
```python
base_rules_prompt = """
## 핵심 분석 규칙 및 원칙

👑 '투자 연혁' 존중 및 반박 규칙 (Narrative Respect & Invalidation Rule) (★★★★★)
이미 보유 중인 자산의 비중을 축소하거나 '제외'하기 전, 먼저 해당 자산의 '투자 연혁' 전체를 검토해야 합니다.
비중을 축소하려면, **'최초 진입'의 핵심 논리가 더 이상 유효하지 않거나, '최근 활동'을 통해 의도했던 전략이 실패했음**을
`rationale`에 명확하게 증명해야 합니다.

## 1. 워뇨띠 투자 5대 원칙 (기반 철학)
- **추세 추종**: 상승 추세 자산 비중 늘리고, 하락 추세 자산 비중 줄임
- **120일선 기준**: 120일선 위 = '매수 구간', 아래 = '익절/관망 구간'
- **분할 원칙**: 시장 상황 불명확 시 점진적 조절
- **감정 역이용**: '공포' 시 유망 자산 비중 확대 기회, '탐욕' 시 현금 확보 기회
- **알트 시즌 판단**: ETH > BTC 강세 시 알트코인 비중 확대 긍정 검토

## 2. 고급 판단 시스템 (CIO의 의사결정 툴)
- **유동성 등급별 비중 제한 (절대 규칙)**:
  A등급 최대 40%, B등급 최대 25%, C등급 최대 15%
- **거래 일관성 강화 (휩쏘 방지 규칙) (★★★★★)**:
  - 매수 후 급격한 비중 축소 금지: 최근 '신규/추가 매수' 실행 시 명확한 하락 반전 신호 없이 단기 변동성으로 목표 비중 급격 축소 금지
  - 매도 후 급격한 비중 확대 금지: 최근 '익절/손절' 실행 시 해당 판단 근거 뒤집힐 강력한 상승 돌파 신호 없이 목표 비중 확대 금지
- **상관관계 리스크 관리**: 상관관계 0.7 이상 자산들 비중 합 40% 초과 방지
- **소액 비중 코인 정리**: 총 평가액 3% 미만 소액 코인 유망하지 않으면 과감히 0%로

## 3. 포트폴리오 비중 조절 의사결정 5단계 프로세스
1. **(거시 분석)** 시장 전체 국면 (공포/탐욕), 온체인 데이터, BTC 도미넌스 → '공격' vs '수비' 판단
2. **(개별 자산 평가)** 각 자산의 120일선 위치, 기술적 지표, 다중 시간대 추세 일치 → '투자 매력도' 점수
3. **(상대 비교)** 투자 매력도 높은 자산 vs 낮은 자산 비교, 거래 히스토리 & 상관관계 고려
4. **(현금 비중 결정)** 1~3단계 종합하여 현재 시장 리스크에 적합한 현금(KRW) 비중 먼저 결정
5. **(최종 비중 할당)** 결정된 현금 비중 제외한 나머지를 '투자 매력도'에 따라 배분 (합 100%)
6. **(최종 규칙 검증)** 모든 결정이 현재 페르소나의 조건부 규칙(IF-THEN)과 완벽히 일치하는지 자체 검증, `rationale`에 명시

## 4. 차트 분석 기반 전략적 통찰
- **추세의 질적 분석**: 차트 추세가 가파르고 안정적 vs 변동성 크고 혼란스러움
- **변동성 평가**: 볼린저밴드 폭으로 변동성 파악, 밴드 폭 급격 확장 시 리스크 크다고 판단
- **핵심 가격대 확인**: 장기 지지선/저항선 근접 확인, 중요 저항선 돌파는 비중 확대 근거
- **패턴 인식**: 명확한 상승/하락 패턴 보이면 기술적 지표보다 우선 고려 가능
"""
```

---

### 1.3 제공되는 데이터 상세

`_prepare_rebalance_data_and_prompt()` 함수가 수집하는 모든 데이터:

#### A. 시장 메타 데이터
```python
{
    "fear_greed_index": 62,
    "market_classification": "Greed",
    "btc_dominance": 58.3,
    "market_trend_24h": 2.5,
    "portfolio_volatility": 45.2,
    "exchange_rate": 1350.0,
    "onchain_summary": "전반적으로 긍정적 (Score: 65)"
}
```

#### B. 포트폴리오 현황
```python
{
    "total_value": 7000000,
    "krw_balance": 2000000,
    "coins_value": 5000000,
    "cumulative_return": -30.0,
    "performance_metrics": {
        "summary": "최근 30일 수익성 악화",
        "profit_factor": 0.6,      # 손익비
        "net_profit": -3000000,
        "win_rate": 35,
        "avg_profit_percent": 8.2,
        "avg_loss_percent": -12.5
    }
}
```

#### C. 개별 코인 데이터 (각 코인별로 수집)
```python
{
    "symbol": "BTC",
    "current_price": 95000000,
    "liquidity_grade": "A (최상위)",

    # 기술적 지표
    "indicators": {
        "rsi": 65.2,
        "macd_diff": 0.5,
        "bb_position": 75,
        "stoch_k": 68,
        "atr": 2.5,
        "volatility": 3.8,
        "volume_ratio": 1.5,
        "price_change_24h": 2.3,
        "ma_120": 92000000,
        "multi_timeframe": {
            "1h": {"rsi": 62, "macd_status": "상승"},
            "4h": {"rsi": 68, "macd_status": "상승"},
            "1d": {"rsi": 65, "macd_status": "상승"}
        }
    },

    # 120일선 분석 (워뇨띠 핵심)
    "ma_120_status": "✅ 120일선 위 +3.26% (워뇨띠 매수구간)",

    # 보유 정보
    "holding": {
        "current_status": "보유",
        "management_status": "활성",
        "current_weight": 30.0,
        "gpt_target_weight": 25.0,
        "current_profit": 5.5,
        "highest_profit": 8.2,
        "holding_quantity": 0.05,
        "avg_buy_price": 90000000
    },

    # 거래 히스토리 & 맥락
    "history": {
        "position_context": {
            "is_holding": True,
            "last_action": "추가매수",
            "days_held": 7
        },
        "summary": {
            "total_trades": 5,
            "buy_count": 3,
            "sell_count": 2
        },
        "recent_trades": [
            {"date": "2025-10-13", "type": "추가매수", "amount": 1000000},
            {"date": "2025-10-10", "type": "신규매수", "amount": 2000000}
        ]
    },

    # 투자 연혁 (최초 진입 thesis)
    "investment_narrative": {
        "initial_entry": {
            "type": "신규매수",
            "thesis": "BTC는 120일선 돌파 후 상승 추세 확립...",
            "timestamp": "2025-10-05"
        },
        "recent_activities": [
            {"type": "추가매수", "thesis": "추가 상승 모멘텀 확인..."}
        ]
    },

    # 상관관계
    "correlation": {
        "ETH": 0.85,
        "SOL": 0.72
    },

    # 차트 이미지
    "chart_image": "base64_encoded_png...",

    # 최적 거래 타이밍
    "optimal_timing": {
        "order_book_imbalance": -5.2,
        "interpretation": "매수 우세"
    },

    # 김치 프리미엄
    "kimchi_premium": 2.5,

    # 트레일링 스탑 상태
    "trailing_stop": {
        "activated": True,
        "trigger_price": 92000000,
        "status": "아직 발동 안 됨"
    },

    # 전략적 딜레마
    "strategic_dilemma": "RSI 과매수 구간이지만 거래량 증가로 추세 신뢰도 높음..."
}
```

---

## 🔴 Part 2: 발견된 7가지 핵심 문제 (재분석)

### 문제 1: 과도한 집중 투자 → 큰 손실
**현상:**
- 공격형 페르소나 시 몇 개 종목에 30%+ 비중 할당
- 해당 종목 급락 시 포트폴리오 전체 타격

**원인 분석:**
```python
# ai_strategy.py:1681
"주도주에 30% 이상의 과감한 비중을 할당하는 것을 두려워하지 마십시오"
```

**문제점:**
- ❌ **상황 판단 없는 집중**: AI가 맥락을 고려하지 않고 무조건 30% 할당
- ❌ **페르소나별 상한선 차이**: 공격 30%, 중립 25%, 방어 15% → 일관성 부재

**개선 방향 (원칙 1 적용: AI 자율 판단):**
```python
# ❌ 기존: 명시적 비중 지시
"주도주에 30% 이상의 과감한 비중을 할당"

# ✅ 개선: AI가 맥락에 따라 판단하도록 유도
"""
주도주는 포트폴리오의 핵심 수익 엔진이지만, 과도한 집중은 단일 자산 리스크를 초래합니다.
현재 포트폴리오의 전체 변동성, 주도주의 안정성, 다른 자산과의 상관관계를 종합적으로 고려하여
적절한 비중을 스스로 판단하십시오.
만약 주도주가 매우 안정적이고 포트폴리오 변동성이 낮다면 더 높은 비중도 가능하지만,
그 반대의 경우라면 리스크 분산을 위해 비중을 제한해야 합니다.
"""
```

**실제 데이터 예시:**
```
탐욕장 + SOL 35% 할당 → 7일 후 -20% 급락 → 포트폴리오 -7% 손실
원인: SOL이 급등 중이었지만 변동성이 매우 높았음 (포트폴리오 변동성 지수 75)
→ AI가 변동성을 고려하여 비중을 제한했어야 함
```

---

### 문제 2: 선택과 집중 vs 15개 종목 유지 모순
**현상:**
- Dynamic Mode 프롬프트는 "선택과 집중" 강조
- 실제로는 15개까지 허용
- 결과: 중도반단한 분산 투자

**원인 분석:**
```python
# ai_strategy.py:1755
"최대 15개의 핵심 자산으로 구성"
```

**문제점:**
- ❌ **목표 불명확**: "선택과 집중" vs "15개 분산" 모순
- ❌ **AI가 혼란**: 도대체 몇 개를 선택해야 하는지 모호

**개선 방향 (원칙 1 + 2 적용):**
```python
# ✅ 개선: AI가 상황에 맞춰 최적 종목 수 결정
"""
## 포트폴리오 구성 철학: '선택과 집중'

당신의 임무는 시장에서 진짜 주도주를 소수 정예로 가려내는 것입니다.

### 최적 종목 수 가이드라인:
- **공격형 (탐욕장)**: 모멘텀이 명확한 5~8개 주도주에 집중하여 상승 추세를 극대화하십시오.
- **방어형 (공포장)**: 변동성이 낮은 3~5개 안전 자산만 보유하고 나머지는 현금으로 전환하십시오.
- **중립형 (횡보장)**: 다양한 섹터에서 잠재력 있는 7~10개 자산에 균형 있게 분산하십시오.

### 절대 한계:
현금(KRW)을 제외하고 **최대 15개**까지 허용되지만, 이는 절대 한계입니다.
만약 15개에 근접한다면, 이는 '선택과 집중' 원칙에서 벗어난 것이므로
가장 확신이 낮은 자산부터 과감히 제외하여 집중도를 높이십시오.
"""
```

---

### 문제 3: 수익 실현 타이밍 문제
**현상:**
- 수익률 상승 시 AI가 비중을 계속 확대
- 상승 중 비중 확대 → 평균 단가 상승 → 하락 시 수익 대부분 증발

**원인 분석:**
```python
# ai_strategy.py:1682
"추세 동조: 상승 추세라면 동반 비중 확대를 긍정적으로 검토"
```

**실제 패턴:**
```
1일차: META 10% 할당, +5% 수익
3일차: 추세 확인 → 20% 확대 (평균단가 상승)
5일차: 계속 상승 → 25% 확대 (평균단가 더 상승)
7일차: -10% 급락 → 수익 대부분 사라짐 → 당황하여 제외 결정
```

**문제점:**
- ❌ **수익 실현 로직 없음**: 언제 비중을 축소해야 하는지 모름
- ❌ **평균 단가 고려 부재**: 현재 수익률만 보고 판단
- ❌ **목표 수익률 없음**: 언제까지 들고 갈지 계획 없음 → **문제 7과 연결**

**개선 방향 (원칙 4 적용: CIO가 목표 설정):**

**핵심: CIO가 편입 시 목표를 미리 설정해야 함**
```python
# CIO가 META 편입 시 목표 설정
{
    "META": {
        "initial_weight": 10,
        "target_profit": 20,      # CIO가 변동성 분석 후 결정
        "stop_loss": -8,
        "rebalance_plan": {
            "action_at_10_percent": "비중 유지하며 관찰",
            "action_at_20_percent": "목표 달성, 비중 50% 축소하여 수익 실현",
            "action_at_30_percent": "과열 구간, 비중 70% 축소하여 대부분 현금화"
        },
        "rationale": "META는 AI 테마로 단기 모멘텀 강하지만 변동성 높음. 20% 목표 도달 시 절반 익절."
    }
}
```

**프롬프트 개선:**
```python
# ✅ 개선: 수익 실현 전략 추가
"""
## 수익 실현 및 리밸런싱 전략

### 원칙: "수익은 실현할 때 진짜 수익"
보유 자산이 목표 수익률에 도달하면, 추가 상승을 기대하며 비중을 확대하는 것은
평균 단가를 높여 리스크를 증가시킵니다. 다음 원칙을 따르십시오:

1. **목표 수익률 50% 도달 시**: 현재 비중 유지, 추가 확대 금지
2. **목표 수익률 100% 도달 시**: 비중 30~50% 축소하여 수익 일부 실현
3. **목표 수익률 150% 초과 시**: 비중 50~70% 축소하여 대부분 수익 실현

이 전략은 "상승 추세 동조" 원칙보다 우선합니다.
추가 상승 기회를 놓치는 것보다, 확보한 수익을 보호하는 것이 CIO의 책임입니다.
"""
```

---

### 문제 4: CIO 분석 데이터 부족
**현상:**
- CIO는 Process2보다 상위 의사결정
- 하지만 제공되는 데이터는 오히려 더 적음

**데이터 비교:**
```python
# CIO 입력 데이터 (_prepare_rebalance_data_and_prompt)
✅ 시장 메타 데이터 (Fear&Greed, BTC Dominance)
✅ 포트폴리오 현황
✅ 기본 기술적 지표 (RSI, MACD, BB)
✅ 차트 이미지
✅ 상관관계 행렬
✅ 거래 히스토리 & 맥락
✅ 투자 연혁
✅ 유동성 등급
✅ 성과 피드백 (손익비 기반 자기반성)
✅ 온체인 데이터 요약
❌ 온체인 상세 데이터 (없음)
❌ 거래량 프로파일 상세 (volume_ratio만 있음)
❌ 섹터 분류 및 섹터 성과 (없음)
❌ 펀더멘털 분석 (TVL, FDV, 개발 활동 등 없음)

# Process2 입력 데이터 (analyze_coin_with_wonyotti_strategy)
✅ 상세 기술적 지표 (15+개)
✅ 차트 이미지
✅ 거래 히스토리 (AI 사고 과정 포함)
✅ 투자 내러티브
✅ 거래 사이클 분석
✅ 성과 지표 (상세)
✅ CIO 전략 브리핑
✅ 최적 거래 타이밍
✅ 김치 프리미엄
```

**문제점:**
- ❌ **부분적으로만 문제**: 이미 많은 데이터를 제공하고 있음 (투자 연혁, 거래 맥락, 성과 피드백 등)
- ⚠️ **섹터/펀더멘털 부족**: 이 부분만 보완 필요

**개선 방향 (원칙 3 적용: 기존 함수 활용):**

**재사용 가능한 기존 함수들:**
```python
# 이미 존재하는 함수 재활용
get_technical_indicators()  # 기술적 지표 (이미 사용 중)
get_trade_history_for_coin()  # 거래 히스토리 (이미 사용 중)
get_investment_narrative()  # 투자 연혁 (이미 사용 중)
get_performance_metrics()  # 성과 지표 (이미 사용 중)
```

**신규 추가 필요 (최소한으로):**
```python
# 1. 섹터 분류 함수 (신규 - 기존에 없음)
def get_sector_classification(symbol: str) -> Dict:
    """
    코인의 섹터 정보 반환
    - 내부적으로 정적 매핑 사용 (config.py에 정의)
    """
    SECTOR_MAP = {
        'BTC': {'primary': 'Layer 1', 'sub': 'Store of Value'},
        'ETH': {'primary': 'Layer 1', 'sub': 'Smart Contract Platform'},
        'SOL': {'primary': 'Layer 1', 'sub': 'High Performance'},
        ...
    }
    return SECTOR_MAP.get(symbol, {'primary': 'Unknown', 'sub': 'Unknown'})

# 2. 거래량 프로파일 확장 (기존 volume_ratio 확장)
# _prepare_rebalance_data_and_prompt 내부에서 indicators['volume_ratio'] 활용
# 추가 API 호출 없이 이미 수집된 데이터로 해석 강화
```

**프롬프트 개선 (섹터 정보 활용):**
```python
# ✅ 프롬프트에 섹터 밸런스 지침 추가
"""
## 섹터 밸런스 관리

포트폴리오를 구성할 때 섹터 분산을 고려하십시오:
- **Layer 1 (BTC, ETH, SOL 등)**: 포트폴리오의 핵심 (40~60%)
- **DeFi (AAVE, UNI 등)**: 고위험 고수익 (10~20%)
- **AI/Gaming 등 테마**: 단기 모멘텀 (0~20%)

특정 섹터에 과도하게 집중하면(50% 초과) 섹터 전체 하락 시 포트폴리오가 동반 타격을 받습니다.
"""
```

---

### 문제 5: 자체 분석 및 계획 부재
**현상:**
- 현재는 데이터 수집 → AI 요청 → 즉시 결정
- 코인별 단기/중기 계획 없음

**현재 프로세스:**
```
데이터 수집 → AI 요청 (1회) → 즉시 결정
```

**문제점:**
- ❌ **계획 부재**: 즉흥적 결정
- ❌ **추적 불가**: 왜 그 결정을 했는지 모름 → **사실 `rationale`에 기록되므로 부분적으로 해결됨**

**재평가 (원칙 2 적용: 기존 개선 사항 보존):**

**이미 존재하는 계획 메커니즘:**
1. **투자 연혁**: 최초 진입 thesis 저장 → 나중에 참고
2. **rationale**: 매번 결정 이유 저장
3. **성과 피드백**: 30일 성과 기반 AI 자기반성

**부족한 부분:**
- ⚠️ **다음 리밸런싱 시점 계획 없음**: CIO가 "다음에 다시 검토할 조건" 명시 안 함

**개선 방향 (기존 구조 활용):**
```python
# CIO JSON 응답에 next_review_trigger 추가 (간단한 확장)
{
    "weights": [...],
    "targets": {...},  # 목표 설정 (문제 7 해결)
    "rationale": "...",
    "next_review_trigger": {  # ← 신규 추가
        "condition": "BTC가 120일선 이탈 시 OR 포트폴리오 변동성 지수 70 초과 시",
        "max_days": 3  # 늦어도 3일 내 재검토
    }
}
```

---

### 문제 6: 편입/제외 판단 불안정
**현상:**
- 급등락에 반응하여 편입/제외 반복
- "활성 → 제외 → 재평가 → 활성 → 제외" (15일간 5번 변경)

**원인 분석:**
- ❌ **단기 모멘텀 의존**: 3일 급등 → 편입 → 5일 후 급락 → 제외
- ❌ **"거래 일관성 규칙"이 비중에만 적용**: 편입/제외 결정에는 미적용

**개선 방향 (원칙 2 적용: 기존 규칙 확장):**

**기존 "거래 일관성 규칙" 확장:**
```python
# ✅ 개선: 편입/제외에도 일관성 규칙 적용
"""
## 거래 일관성 강화 (확장: 편입/제외 포함) (★★★★★)

### 비중 조정 일관성 (기존)
- 매수 직후 급격한 비중 축소 금지
- 매도 직후 급격한 비중 확대 금지

### 편입/제외 일관성 (신규)
- **최근 '활성'으로 편입한 코인 (7일 이내)**:
  명확한 실패 신호(예: 120일선 이탈 + 거래량 급감) 없이 단기 변동성만으로
  '제외' 상태로 변경 금지. 최소 7일 관찰 후 판단.

- **최근 '제외'한 코인 (14일 이내)**:
  제외 판단의 근거가 완전히 뒤집힐 강력한 신호(예: 주요 호재 발생 + 거래량 폭발)
  없이 다시 '활성'으로 편입 금지. 최소 14일 관찰 후 재평가.

이 규칙은 "휩쏘"를 방지하여 포트폴리오의 안정성을 유지합니다.
"""
```

---

### 문제 7: 목표 설정 메커니즘 부재 ⭐⭐⭐⭐⭐
**현상:**
- `GPT목표수익률`, `GPT목표손절률` 필드 존재
- 하지만 현재는 Process2(매매 판단)가 설정 → **역할 역전**

**현재 구조 (잘못됨):**
```python
# ai_strategy.py:1290-1291 (Process2 JSON 스키마)
{
    "GPT목표수익률": {"type": "number"},  # ← Process2가 설정
    "GPT목표손절률": {"type": "number"}   # ← Process2가 설정
}
```

**문제점:**
- ❌ **역할 역전**: 하위 조직(Process2)이 목표 설정, 상위 조직(CIO)은 비중만 결정
- ❌ **포트폴리오 맥락 부재**: Process2는 개별 코인만 보고 목표 설정 → 전체 리스크 고려 안 함
- ❌ **일괄 적용**: 모든 코인 동일 목표 (15%, -7%) → 변동성 차이 미반영

**개선 방향 (원칙 4 적용: CIO 역할 재정립):**

#### Step 1: CIO JSON 응답에 targets 추가
```python
# CIO JSON 스키마 수정 (ai_strategy.py:1850-1872)
{
    "weights": [...],
    "targets": {  # ← 신규 추가
        "BTC": {
            "target_profit": 12,
            "stop_loss": -6,
            "rationale": "BTC는 안정 자산. 포트폴리오 변동성 높은 상황에서 보수적 목표 설정."
        },
        "SOL": {
            "target_profit": 25,
            "stop_loss": -10,
            "rationale": "SOL은 고변동성 자산. 높은 목표 설정하되 손절도 여유 있게."
        }
    },
    "rationale": "..."
}
```

#### Step 2: CIO가 설정한 목표를 DB에 저장
```python
# recalculate_portfolio_weights() 내부 수정 (ai_strategy.py:1965-2018)
if result and result.get('targets'):
    targets = result['targets']
    for symbol, target_info in targets.items():
        db_manager.update_holding_status(symbol, {
            'GPT목표수익률': target_info['target_profit'],
            'GPT목표손절률': target_info['stop_loss']
        })
```

#### Step 3: Process2는 CIO가 설정한 목표 참조만
```python
# analyze_coin_with_wonyotti_strategy() 수정
# Process2 JSON 스키마에서 GPT목표수익률/손절률 제거
# 대신 CIO가 설정한 값을 읽어서 프롬프트에 포함
cio_target = db_manager.get_holding_status(symbol)
cio_target_profit = cio_target.get('GPT목표수익률', 15)
cio_target_stop = cio_target.get('GPT목표손절률', -7)

process2_prompt = f"""
CIO가 설정한 목표:
- 목표 수익률: {cio_target_profit}%
- 손절률: {cio_target_stop}%

당신은 이 목표 범위 내에서 매매 판단을 수행하십시오.
"""
```

#### Step 4: CIO 프롬프트에 목표 설정 지침 추가
```python
"""
## 목표 설정 책임 (CIO의 핵심 역할)

당신은 각 코인의 목표 수익률과 손절률을 설정할 책임이 있습니다.
Process2(매매 담당)는 당신이 설정한 목표 범위 내에서만 행동합니다.

### 목표 설정 원칙:
1. **포트폴리오 전체 리스크 고려**:
   - 포트폴리오 변동성 지수가 높으면(60+) 모든 코인의 목표를 보수적으로 설정
   - 변동성 지수가 낮으면(40 이하) 공격적 목표 가능

2. **개별 자산 특성 반영**:
   - BTC처럼 안정적 자산: 목표 수익률 10~15%, 손절 -5~-7%
   - 알트코인(SOL, AVAX 등): 목표 수익률 20~30%, 손절 -10~-12%
   - 고변동성 테마 코인: 목표 수익률 30~50%, 손절 -15~-20%

3. **시장 국면 반영**:
   - 공격형 페르소나 (탐욕장): 목표 수익률 높게 설정
   - 방어형 페르소나 (공포장): 목표 수익률 낮게, 손절 촘촘하게

4. **목표 달성 시 비중 조정 계획**:
   - 목표 수익률 달성 시 → 비중 30~50% 축소 계획
   - 손절률 도달 시 → 즉시 청산

모든 코인에 대해 명확한 목표와 그 근거(rationale)를 제시하십시오.
"""
```

---

## 📈 Part 3: 통계적 문제 분석

### 손실 패턴 분석 (추정)
```
총 손실: -30% (1000만 → 700만)

손실 요인 분해:
1. 과도한 집중 투자 손실: -15%  (50%)  → 문제 1
2. 잘못된 타이밍 (고점 비중 확대): -8%  (27%)  → 문제 3
3. 빈번한 편입/제외 비용: -4%  (13%)  → 문제 6
4. 목표 없는 매매: -3%  (10%)  → 문제 7
```

### 거래 효율성 분석 (추정)
```
평균 보유 기간: 5일 (너무 짧음) → 문제 6
승률: 35% (매우 낮음)
손익비: 0.6 (손실이 더 큼) → 문제 3, 7
최대 낙폭: -25% (리스크 관리 실패) → 문제 1
```

---

## 🎯 Part 4: 개혁 방향성 (4대 원칙 기반)

### 재정리된 개혁 방향

#### 1. AI 자율 판단 강화 (원칙 1)
- ✅ 하드코딩 규칙 제거 → 프롬프트로 유도
- ✅ 맥락 이해 강화 프롬프트 추가

#### 2. 기존 프롬프트 보완 (원칙 2)
- ✅ 워뇨띠 5대 원칙 유지
- ✅ 투자 연혁 존중 규칙 유지
- ✅ 거래 일관성 규칙 확장 (편입/제외 포함)
- ✅ 수익 실현 전략 추가
- ✅ 섹터 밸런스 지침 추가

#### 3. 기존 함수 재사용 (원칙 3)
- ✅ _prepare_rebalance_data_and_prompt 확장
- ✅ 섹터 분류 신규 함수만 추가 (최소한)
- ✅ 중복 제거

#### 4. CIO 역할 재정립 (원칙 4)
- ✅ CIO가 목표 설정 주체로 이관
- ✅ Process2는 목표 참조만
- ✅ targets 필드 JSON 스키마에 추가

---

## 🔧 Part 5: 구체적 개혁안 (수정됨)

### 5.1 개혁 구조 (원칙 기반)

```
[ Phase 1: 데이터 수집 확장 (기존 함수 활용) ]
├── _prepare_rebalance_data_and_prompt() 수정
│   ├── 기존 데이터 유지 (시장, 포트폴리오, 기술적 지표, 차트, 거래 히스토리, 투자 연혁 등)
│   └── 신규 추가 (최소한)
│       ├── 섹터 분류 (get_sector_classification 신규 함수)
│       └── 거래량 해석 강화 (기존 volume_ratio 활용)

[ Phase 2: 프롬프트 보완 (삭제 금지, 추가만) ]
├── 기존 프롬프트 보존
│   ├── 워뇨띠 5대 원칙 ✅
│   ├── 투자 연혁 존중 규칙 ✅
│   ├── 거래 일관성 규칙 ✅
│   ├── 유동성 등급별 비중 제한 ✅
│   └── 성과 피드백 자기반성 ✅
│
└── 신규 추가 (보완)
    ├── AI 자율 판단 유도 (집중 투자, 종목 수 등)
    ├── 수익 실현 전략
    ├── 섹터 밸런스 지침
    ├── 편입/제외 일관성 규칙 (거래 일관성 확장)
    └── 목표 설정 책임 및 지침

[ Phase 3: CIO 역할 확대 ]
├── JSON 스키마에 targets 필드 추가
├── CIO가 각 코인별 목표 수익률/손절률 설정
├── DB에 저장 (update_holding_status)
└── Process2는 CIO 목표 참조만

[ Phase 4: 실행 로직 수정 (최소한) ]
├── recalculate_portfolio_weights() 수정
│   ├── targets 저장 로직 추가
│   └── next_review_trigger 저장 (선택)
│
└── analyze_coin_with_wonyotti_strategy() 수정
    └── GPT목표수익률/손절률 JSON 스키마에서 제거
    └── CIO 설정 목표를 읽어서 프롬프트에 포함
```

---

### 5.2 프롬프트 개선안 (기존 보존 + 추가)

#### A. 기존 프롬프트 (보존)
```python
# ai_strategy.py:1676-1714 (동적 페르소나)
aggressive_cio_prompt  # ✅ 유지
defensive_cio_prompt   # ✅ 유지
neutral_cio_prompt     # ✅ 유지

# ai_strategy.py:1780-1819 (Base Rules)
base_rules_prompt      # ✅ 유지
  - 워뇨띠 5대 원칙
  - 투자 연혁 존중 규칙 (★★★★★)
  - 유동성 등급별 비중 제한
  - 거래 일관성 강화 (★★★★★)
  - 5단계 의사결정 프로세스
  - 차트 분석 기반 전략적 통찰
```

#### B. 신규 추가 프롬프트 (보완)
```python
# ✅ 추가 1: AI 자율 판단 강화
autonomy_enhancement_prompt = """
## AI 자율 판단 원칙 (매우 중요)

당신은 주어진 모든 데이터를 종합적으로 분석하여 스스로 최적의 결정을 내려야 합니다.
아래 지침은 '절대 규칙'이 아니라 '판단의 기준점'입니다.
상황에 따라 유연하게 해석하고 적용하십시오.

### 집중 투자 vs 분산 투자
- **기준점**: 단일 자산에 과도하게 집중(30%+)하면 해당 자산 급락 시 포트폴리오 전체 타격
- **당신의 판단**: 현재 포트폴리오 변동성, 주도주의 안정성, 상관관계를 종합 고려하여 적절한 비중 스스로 결정
- **예시**: 변동성 지수 40 이하 + BTC(A등급) + 다른 자산과 낮은 상관관계 → 30% 이상 가능
- **예시**: 변동성 지수 70 + 알트코인(C등급) + 높은 상관관계 → 10% 이하로 제한

### 최적 종목 수
- **철학**: '선택과 집중' - 진짜 주도주 소수 정예로 가려내기
- **기준점**: 공격 5~8개, 방어 3~5개, 중립 7~10개
- **당신의 판단**: 현재 시장에서 명확한 기회가 몇 개나 있는지 스스로 평가
- **절대 한계**: 현금 제외 최대 15개 (이는 예외 없음)
"""

# ✅ 추가 2: 수익 실현 전략 (페르소나별 차별화) ⭐ 개선됨
profit_taking_strategy_prompt = """
## 수익 실현 및 리밸런싱 전략

### 원칙: "수익은 실현할 때 진짜 수익"
보유 자산이 목표 수익률에 접근하면, 추가 상승을 기대하며 비중을 확대하는 것은
평균 단가를 높여 리스크를 증가시킵니다.

### 수익률별 대응 (페르소나별 조정):

**공격형 (알파 사냥꾼) 시:**
1. **목표 수익률 50% 도달**: 현재 비중 유지, 추세가 강하면 추가 10% 확대 가능
2. **목표 수익률 100% 도달**: 비중 20~30% 축소 (트레일링 스탑 활용)
3. **목표 수익률 150% 초과**: 비중 40~50% 축소 (일부 수익 확보하되 추세 동조)

**방어형 (리스크 수호자) 시:**
1. **목표 수익률 50% 도달**: 현재 비중 유지, 추가 확대 금지
2. **목표 수익률 100% 도달**: 비중 50~60% 축소 (과감한 수익 실현)
3. **목표 수익률 150% 초과**: 비중 70~80% 축소 (대부분 현금화)

**중립형 (균형 전략가) 시:**
1. **목표 수익률 50% 도달**: 현재 비중 유지, 관찰 모드
2. **목표 수익률 100% 도달**: 비중 30~50% 축소 (기본 원칙)
3. **목표 수익률 150% 초과**: 비중 50~70% 축소 (표준 대응)

이 전략은 "상승 추세 동조" 원칙보다 우선하되, 페르소나에 따라 유연하게 적용합니다.
"""

# ✅ 추가 3: 섹터 밸런스 지침
sector_balance_prompt = """
## 섹터 밸런스 관리

포트폴리오를 구성할 때 섹터 분산을 고려하십시오:

### 섹터별 권장 비중 범위:
- **Layer 1 (BTC, ETH, SOL 등)**: 40~60% (포트폴리오의 핵심)
- **DeFi (AAVE, UNI, LINK 등)**: 10~20% (고위험 고수익)
- **AI/Gaming 등 테마**: 0~20% (단기 모멘텀)

### 리스크:
특정 섹터에 50% 초과 집중 시, 섹터 전체 하락 시 포트폴리오 동반 타격.
예: Layer 1에 70% 집중 → BTC 하락 시 전체 하락
"""

# ✅ 추가 4: 편입/제외 일관성 규칙
inclusion_exclusion_consistency_prompt = """
## 편입/제외 일관성 규칙 (거래 일관성 확장)

### 최근 편입 코인 (7일 이내):
명확한 실패 신호(120일선 이탈 + 거래량 급감) 없이
단기 변동성만으로 '제외' 상태 변경 금지. 최소 7일 관찰 후 판단.

### 최근 제외 코인 (14일 이내):
제외 근거가 완전히 뒤집힐 강력한 신호(주요 호재 + 거래량 폭발) 없이
다시 '활성' 편입 금지. 최소 14일 관찰 후 재평가.

이 규칙은 "휩쏘"를 방지하여 포트폴리오 안정성 유지.
"""

# ✅ 추가 5: 목표 설정 책임 (CIO 역할 재정립)
target_setting_responsibility_prompt = """
## 목표 설정 책임 (CIO의 핵심 역할)

당신은 각 코인의 목표 수익률과 손절률을 설정할 책임이 있습니다.
Process2(매매 담당)는 당신이 설정한 목표 범위 내에서만 행동합니다.

### 목표 설정 원칙:

1. **포트폴리오 전체 리스크 고려**:
   - 포트폴리오 변동성 지수 높으면(60+) → 모든 코인 목표 보수적
   - 변동성 지수 낮으면(40 이하) → 공격적 목표 가능

2. **개별 자산 특성 반영**:
   - BTC(안정): 목표 수익률 10~15%, 손절 -5~-7%
   - 알트코인(SOL, AVAX): 목표 수익률 20~30%, 손절 -10~-12%
   - 고변동성 테마: 목표 수익률 30~50%, 손절 -15~-20%

3. **시장 국면 반영**:
   - 공격형 (탐욕장): 목표 수익률 높게
   - 방어형 (공포장): 목표 수익률 낮게, 손절 촘촘하게

4. **목표 달성 시 계획**:
   - 목표 수익률 달성 → 비중 30~50% 축소
   - 손절률 도달 → 즉시 청산

모든 코인에 명확한 목표와 근거(rationale) 제시 필수.
"""

# ✅ 추가 6: Rationale 충돌 해결 지침 ⭐ 신규 추가
rationale_conflict_resolution_prompt = """
## Rationale 작성 시 충돌 해결 지침

### 원칙: "상충하는 지표를 모두 언급하고 균형점 설명"

서로 상충하는 지표(예: 낮은 변동성 vs 공포 심리)가 있을 때,
두 지표를 모두 명시하고, 최종 결정이 어떻게 균형을 맞춘 것인지 명확히 설명하십시오.

### 나쁜 예시 (모순):
"변동성 지수가 낮아 공격적인 투자가 가능합니다. 현금 비중을 70%로 유지하여 시장 변동성에 대비합니다."
→ 문제: "공격 가능" vs "70% 현금" 모순

### 좋은 예시 (균형):
"변동성 지수 30으로 낮아 투자 기회를 암시하지만, 공포탐욕지수 34(공포)이므로
소극적인 비중 30%만 투자하고 나머지 70%는 현금으로 보유하여 양쪽 가능성에 모두 대비합니다."
→ 개선: 두 지표를 모두 언급하고 균형점 명확히 설명

이 지침은 rationale 작성 시 반드시 적용하십시오.
"""

# 최종 시스템 프롬프트 구성
system_prompt = f"""
{dynamic_cio_persona_prompt}    # 기존 페르소나 (공격/방어/중립)
{dynamic_mode_rules}             # 기존 Dynamic Mode 규칙
{base_rules_prompt}              # 기존 Base Rules
{autonomy_enhancement_prompt}    # ← 신규 추가 1
{profit_taking_strategy_prompt}  # ← 신규 추가 2 (페르소나별 개선)
{sector_balance_prompt}          # ← 신규 추가 3
{inclusion_exclusion_consistency_prompt}  # ← 신규 추가 4
{target_setting_responsibility_prompt}    # ← 신규 추가 5
{rationale_conflict_resolution_prompt}    # ← 신규 추가 6 ⭐
"""
```

---

### 5.3 JSON 스키마 수정

#### CIO JSON 스키마 (ai_strategy.py:1850-1872)
```python
# ✅ targets 필드 추가
{
    "type": "object",
    "properties": {
        "weights": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "asset": {"type": "string"},
                    "weight": {"type": "number"},
                    "management_status": {"type": "string"}  # dynamic_mode 시만
                },
                "required": ["asset", "weight"]
            }
        },
        "targets": {  # ← 신규 추가
            "type": "object",
            "additionalProperties": {
                "type": "object",
                "properties": {
                    "target_profit": {"type": "number"},
                    "stop_loss": {"type": "number"},
                    "rationale": {"type": "string"}
                },
                "required": ["target_profit", "stop_loss", "rationale"]
            }
        },
        "rationale": {"type": "string"},
        "strategy_type": {"type": "string"},
        "risk_level": {"type": "string"}
    },
    "required": ["weights", "targets", "rationale", "strategy_type", "risk_level"]
}
```

#### Process2 JSON 스키마 (ai_strategy.py:1280-1300)
```python
# ❌ GPT목표수익률, GPT목표손절률 제거
{
    "type": "object",
    "properties": {
        "coin": {"type": "string"},
        "매매판단": {"type": "string"},
        "판단확신": {"type": "integer"},
        "GPT매매비중": {"type": "integer"},
        # "GPT목표수익률": 제거 ❌
        # "GPT목표손절률": 제거 ❌
        "거래사유": {"type": "string"},
        "thinking_process": {"type": "string"}
    },
    "required": ["coin", "매매판단", "판단확신", "GPT매매비중", "거래사유", "thinking_process"]
}
```

---

### 5.4 코드 수정 사항 (최소한)

#### A. recalculate_portfolio_weights() 수정
```python
# ai_strategy.py:1965-2018
# ✅ targets 저장 로직 추가

# 기존 코드
if result and result.get('weights'):
    weights_data = {item['asset']: item['weight'] for item in result['weights']}
    db_manager.update_portfolio_weights(weights_data)

    # ✅ 신규 추가: targets 저장
    if result.get('targets'):
        targets = result['targets']
        for symbol, target_info in targets.items():
            if symbol != 'KRW':  # KRW는 목표 없음
                db_manager.update_holding_status(symbol, {
                    'GPT목표수익률': target_info['target_profit'],
                    'GPT목표손절률': target_info['stop_loss']
                })
                logger.info(f"📊 [{symbol}] CIO 목표 설정: 익절 {target_info['target_profit']}%, 손절 {target_info['stop_loss']}%")
```

#### B. _prepare_rebalance_data_and_prompt() 수정
```python
# ai_strategy.py:2019-2339
# ✅ 섹터 정보 추가 (최소한)

# 개별 코인 루프 내부에 추가 (line 2122 근처)
for coin in coins_to_analyze:
    symbol = coin.symbol

    # ✅ 신규 추가: 섹터 분류
    sector_info = get_sector_classification(symbol)

    # 프롬프트에 섹터 정보 포함
    coin_block += f"\n- **섹터**: {sector_info['primary']} > {sector_info['sub']}"
```

#### C. get_sector_classification() 신규 함수
```python
# ai_strategy.py 또는 config.py
# ✅ 신규 함수 (최소한)

def get_sector_classification(symbol: str) -> Dict[str, str]:
    """
    코인의 섹터 분류 반환 (정적 매핑)
    """
    SECTOR_MAP = {
        'BTC': {'primary': 'Layer 1', 'sub': 'Store of Value'},
        'ETH': {'primary': 'Layer 1', 'sub': 'Smart Contract Platform'},
        'SOL': {'primary': 'Layer 1', 'sub': 'High Performance'},
        'AVAX': {'primary': 'Layer 1', 'sub': 'Smart Contract Platform'},
        'AAVE': {'primary': 'DeFi', 'sub': 'Lending'},
        'UNI': {'primary': 'DeFi', 'sub': 'DEX'},
        'LINK': {'primary': 'DeFi', 'sub': 'Oracle'},
        'RNDR': {'primary': 'AI', 'sub': 'Rendering'},
        'FET': {'primary': 'AI', 'sub': 'Agent Network'},
        'IMX': {'primary': 'Gaming', 'sub': 'NFT Layer 2'},
        # ... (모든 코인 추가)
    }
    return SECTOR_MAP.get(symbol, {'primary': 'Unknown', 'sub': 'Unknown'})
```

#### D. analyze_coin_with_wonyotti_strategy() 수정
```python
# ai_strategy.py:400-1400
# ❌ JSON 스키마에서 GPT목표수익률/손절률 제거
# ✅ CIO 설정 목표를 프롬프트에 포함

# 기존 코드 (line 600 근처)
holding_data = db_manager.get_holding_status(coin_config.symbol)

# ✅ 신규 추가: CIO 목표 읽기
cio_target_profit = holding_data.get('GPT목표수익률', 15)  # CIO가 설정한 값
cio_target_stop = holding_data.get('GPT목표손절률', -7)

# 프롬프트에 포함
process2_prompt += f"""
## CIO가 설정한 목표 (반드시 준수)
- 목표 수익률: {cio_target_profit}%
- 손절률: {cio_target_stop}%

당신은 이 목표 범위 내에서 매매 판단을 수행하십시오.
CIO가 설정한 목표를 임의로 변경하지 마십시오.
"""
```

---

### 5.5 데이터 수집 확장 (최소한)

#### 기존 데이터 (재사용)
```python
# _prepare_rebalance_data_and_prompt()에서 이미 수집 중
✅ 시장 메타 데이터 (Fear&Greed, BTC Dominance, Market Trend)
✅ 포트폴리오 현황 (보유 현황, 누적 수익률)
✅ 성과 피드백 (손익비, 승률 → AI 자기반성 지침)
✅ 기술적 지표 (RSI, MACD, BB, Stoch, ATR, 다중 시간대)
✅ 120일선 위치 (워뇨띠 핵심)
✅ 거래 히스토리 & 맥락
✅ 투자 연혁 (최초 진입 thesis, 최근 활동)
✅ 상관관계 데이터
✅ 유동성 등급
✅ 차트 이미지
✅ 최적 거래 타이밍
✅ 김치 프리미엄
✅ 트레일링 스탑 상태
✅ 전략적 딜레마
✅ 온체인 데이터 요약
```

#### 신규 추가 (최소한)
```python
# 1. 섹터 분류 (get_sector_classification 신규 함수)
✅ 정적 매핑으로 구현 (API 호출 없음)

# 2. 거래량 해석 강화 (기존 volume_ratio 활용)
✅ 이미 수집된 indicators['volume_ratio'] 사용
✅ 프롬프트 내 해석만 추가 (line 2196-2203에 이미 존재)
```

---

## 🔬 Part 6: 예상 개선 효과

### Before (현재)
```
40일 수익률: -30%
승률: 35%
손익비: 0.6
최대 낙폭: -25%
평균 보유 기간: 5일
편입/제외 변경: 15일간 5번 (불안정)
```

### After (개혁 후 예상)
```
40일 수익률 목표: -5% ~ +10%
승률 목표: 50%+
손익비 목표: 1.5+
최대 낙폭 목표: -12%  (AI 자율 판단으로 -15% → -12% 개선)
평균 보유 기간: 12일+  (편입/제외 일관성 규칙)
편입/제외 변경: 15일간 최대 2번 (안정)
```

### 개선 메커니즘
1. **AI 자율 판단 강화** → 맥락에 맞는 리스크 관리 → 최대 낙폭 감소
2. **수익 실현 전략** → 목표 도달 시 비중 축소 → 손익비 향상
3. **CIO 목표 설정** → Process2가 일관된 목표 추종 → 승률 향상
4. **편입/제외 일관성** → 휩쏘 방지 → 보유 기간 연장, 거래 비용 절감
5. **섹터 밸런스** → 특정 섹터 집중 방지 → 리스크 분산

---

## ✅ Part 7: 다음 단계 (우선순위)

### Phase 1: 즉시 실행 가능 (기존 코드 최소 수정)
1. ✅ **프롬프트 보완** (ai_strategy.py:1676-1821)
   - 신규 프롬프트 5개 추가 (Part 5.2.B)
   - 기존 프롬프트 보존

2. ✅ **CIO JSON 스키마 수정** (ai_strategy.py:1850-1872)
   - targets 필드 추가

3. ✅ **CIO 결과 저장 로직** (ai_strategy.py:1965-2018)
   - targets 저장 코드 추가 (5줄)

### Phase 2: 신규 함수 추가 (최소한)
4. ✅ **섹터 분류 함수** (ai_strategy.py 또는 config.py)
   - get_sector_classification() 신규 생성
   - SECTOR_MAP 정의

5. ✅ **데이터 수집 확장** (_prepare_rebalance_data_and_prompt)
   - 섹터 정보 추가 (2줄)

### Phase 3: Process2 수정
6. ✅ **Process2 JSON 스키마 수정** (ai_strategy.py:1280-1300)
   - GPT목표수익률/손절률 제거

7. ✅ **Process2 프롬프트 수정** (ai_strategy.py:600 근처)
   - CIO 목표 읽어서 포함

### Phase 4: 테스트 및 검증
8. ⏳ **백테스트**: 과거 40일 데이터로 개혁안 검증
9. ⏳ **실전 테스트**: 소액(100만원)으로 1주일 테스트
10. ⏳ **프로덕션 배포**: 검증 완료 후 본격 운영

---

## 📌 핵심 요약

### 개혁의 본질
이번 개혁은 **"고도화"가 아닌 "원칙 기반 재설계"**입니다:

1. **AI 자율성 극대화**: 하드코딩 규칙 제거, AI가 맥락에 맞춰 스스로 판단
2. **6개월 노하우 보존**: 기존 프롬프트 삭제 금지, 보완만
3. **코드 최적화**: 기존 함수 재사용, 중복 제거
4. **역할 재정립**: CIO가 목표 설정 주체로 (상위 조직 역할 복원)

### 기대 효과
- 승률: 35% → 50%+
- 손익비: 0.6 → 1.5+
- 최대 낙폭: -25% → -12%
- 보유 안정성: 5일 → 12일+

### 다음 액션
사용자 피드백 → Phase 1 즉시 실행 → Phase 2~3 순차 진행 → 백테스트 → 프로덕션

---

## 🚨 Part 8: 긴급 코인 처리 전략 최적화

### 8.1 현재 구조 분석

**Process1 긴급도 감지 시스템:**
```python
# main.py:213-256
# Process1에서 quick_market_analysis() 호출
market_analysis = quick_market_analysis(urgency_threshold=dynamic_threshold)

if market_analysis.get('has_issue_coins', False):
    issue_coins = market_analysis.get('issue_coins', [])
    # 긴급 코인 리스트 생성
    market_triggers.append({
        'symbol': coin_info['symbol'],
        'type': 'market_issue',
        'issue_reason': coin_info['reason'],
        'urgency': coin_info.get('urgency', 'low')
    })
    # Process2 (AI 매매 판단)로 전달
    all_ai_triggers.extend(market_triggers)
```

**현재 CIO 데이터 수집:**
```python
# ai_strategy.py:1639-1653
# CIO는 DB에서 '활성' 상태 코인만 조회
analysis_target_coins = db_manager.get_active_coin_list()

# 긴급 코인 정보는 받지 않음
# → 기존 보유 종목만 재평가
```

**데이터 흐름:**
```
┌─────────────────┐
│  Process1       │
│  긴급도 감지     │
└────────┬────────┘
         │
         ├─ 긴급 코인 발견 (예: SOL 급등, XRP 급락)
         │
         ↓
┌─────────────────┐
│  Process2       │  ✅ 긴급 코인 정보 받음
│  매매 판단       │     → 보유 종목의 매도/추가매수 결정
└─────────────────┘

         ❌ CIO는 긴급 코인 정보를 받지 않음

┌─────────────────┐
│  CIO (Process3) │  ❌ 긴급 코인 정보 없음
│  포트폴리오      │     → 기존 활성 종목만 재평가
│  비중 재구성     │     → 신규 기회 놓칠 가능성
└─────────────────┘
```

---

### 8.2 문제점 및 개선 방향

#### 현재 문제점:
1. **정보 비대칭**: Process2는 긴급 코인을 알지만, CIO는 모름
2. **기회 손실**: 급등/급락하는 신규 기회를 CIO가 포트폴리오에 반영 못함
3. **역할 불일치**: 전략 계획가(CIO)가 전술 실행가(Process2)보다 정보가 적음

#### 개선 옵션 분석:

**옵션 A: CIO에게 긴급 코인 정보 전달 (추천 ✅)**
```python
# 개선 방안
def run_portfolio_rebalance(newly_added_coins=None, emergency_coins=None):
    """
    Args:
        newly_added_coins: AI 자동편입 신규 코인
        emergency_coins: Process1에서 감지한 긴급 코인 리스트
    """
    # CIO에게 두 가지 정보 모두 전달
    new_weights = recalculate_portfolio_weights(
        newly_added_coins=newly_added_coins,
        emergency_coins=emergency_coins  # 신규 파라미터
    )
```

**장점:**
- ✅ CIO가 전체 시장 긴급 상황을 종합적으로 판단
- ✅ 신규 기회(급등 코인)를 포트폴리오에 편입 가능
- ✅ 리스크(급락 코인)를 선제적으로 비중 축소/제외
- ✅ 전략(CIO) ↔ 전술(Process2) 정보 대칭성 확보

**단점:**
- ⚠️ CIO 실행 빈도가 낮으면 긴급 상황 대응 지연 (해결책: Part 9 참고)
- ⚠️ AI 분석 비용 소폭 증가 (긴급 코인 추가 분석)

**옵션 B: 현재 방식 유지 (긴급 코인 무시)**
```python
# 현재 방식
# CIO는 기존 활성 코인만 재평가
# Process2만 긴급 코인 처리
```

**장점:**
- ✅ 코드 변경 최소화
- ✅ AI 분석 비용 절감

**단점:**
- ❌ CIO가 신규 기회를 포트폴리오에 반영 못함
- ❌ 정보 비대칭 지속
- ❌ 전략가(CIO)의 역할 축소

---

### 8.3 최종 권장 사항

**✅ 옵션 A 채택: CIO에게 긴급 코인 정보 전달**

**구현 방안:**

**1단계: Process1 수정 (긴급 코인 정보 저장)**
```python
# main.py:221-256 수정
if market_analysis.get('has_issue_coins', False):
    issue_coins = market_analysis.get('issue_coins', [])

    # [신규] 긴급 코인을 DB 또는 메모리에 임시 저장
    # 옵션1: DB 테이블 'emergency_coins' 생성
    # 옵션2: 전역 변수로 관리 (간단함)
    emergency_coin_symbols = [coin['symbol'] for coin in issue_coins]

    # Process2 큐에 추가 (기존)
    enqueue_process2(trigger_coins=market_triggers)

    # [신규] CIO에게도 긴급 상황 알림 (옵션)
    # run_portfolio_rebalance(emergency_coins=issue_coins)
```

**2단계: CIO 함수 수정 (긴급 코인 분석 포함)**
```python
# ai_strategy.py:1630 수정
def recalculate_portfolio_weights(
    newly_added_coins: List[CoinConfig] = None,
    emergency_coins: List[Dict] = None  # 신규 파라미터
) -> Dict[str, float]:
    """
    Args:
        newly_added_coins: AI 자동편입 신규 코인
        emergency_coins: Process1에서 감지한 긴급 코인 (symbol, reason, urgency)
    """
    # 분석 대상 확장
    analysis_target_coins = db_manager.get_active_coin_list()

    # [신규] 긴급 코인 추가 (DB에 없어도 임시로 분석 대상 포함)
    if emergency_coins:
        for emergency_coin in emergency_coins:
            symbol = emergency_coin['symbol']
            # DB에 없으면 임시 CoinConfig 생성
            if symbol not in [c.symbol for c in analysis_target_coins]:
                # 긴급 코인을 '재평가' 상태로 임시 추가
                temp_coin = CoinConfig(
                    symbol=symbol,
                    management_status='재평가'  # CIO가 판단하도록
                )
                analysis_target_coins.append(temp_coin)

        logger.info(f"긴급 코인 {len(emergency_coins)}개 포함하여 CIO 분석 수행")

    # 프롬프트에 긴급 상황 정보 추가
    user_prompt = _prepare_rebalance_data_and_prompt(
        analysis_target_coins,
        emergency_info=emergency_coins  # 신규 파라미터
    )
```

**3단계: 프롬프트 수정 (긴급 상황 컨텍스트 추가)**
```python
# ai_strategy.py:_prepare_rebalance_data_and_prompt
if emergency_coins:
    emergency_context = f"""
    ## 🚨 긴급 시장 상황 알림
    Process1 실시간 모니터링에서 다음 긴급 상황을 감지했습니다:

    {"\n".join([f"- **{coin['symbol']}**: {coin['reason']} (긴급도: {coin.get('urgency', 'N/A')})" for coin in emergency_coins])}

    **CIO 판단 지침:**
    - 긴급 상황은 "시장이 지금 당장 주목하는 자산"을 의미합니다.
    - 각 긴급 코인이 포트폴리오에 편입할 가치가 있는지 신속히 평가하십시오.
    - 긴급도 'high'인 자산은 즉각적인 결정이 필요합니다 (비중 확대 or 제외).
    - 현재 보유 자산과의 상대적 매력도를 비교하여 자본 재배치를 검토하십시오.
    """
```

**4단계: 실행 흐름 개선**
```python
# main.py:process1() 수정
# 긴급 상황 발생 시 CIO도 즉시 호출 (옵션)
if market_analysis.get('has_issue_coins', False):
    issue_coins = market_analysis.get('issue_coins', [])

    # Process2 호출 (기존)
    enqueue_process2(trigger_coins=market_triggers)

    # [신규] CIO도 긴급 상황 인지하도록 (즉시 또는 다음 스케줄)
    # 옵션1: 즉시 호출 (긴급도 85점 이상일 때만)
    urgency_score = market_analysis.get('urgency_score', 0)
    if urgency_score >= 85:
        logger.info("🔥 긴급도 85점 이상! CIO 긴급 재구성 실행")
        run_portfolio_rebalance(emergency_coins=issue_coins)

    # 옵션2: 다음 스케줄까지 대기 (비용 절감)
    # → Part 9의 실행 빈도 최적화와 연계
```

---

### 8.4 구현 우선순위

**즉시 실행 (Phase 1):**
1. ✅ CIO 함수 파라미터 추가 (`emergency_coins`)
2. ✅ 긴급 코인을 임시 분석 대상에 포함하는 로직 추가
3. ✅ 프롬프트에 긴급 상황 컨텍스트 추가

**테스트 후 실행 (Phase 2):**
4. ⏳ 긴급도 85점 이상일 때 CIO 즉시 호출 로직 추가
5. ⏳ 긴급 코인 DB 테이블 생성 (선택사항)

**기대 효과:**
- CIO가 시장 긴급 상황을 실시간으로 인지
- 신규 기회(급등 코인)를 포트폴리오에 즉시 반영 가능
- 리스크(급락 코인)를 선제적으로 비중 축소/제외
- 전략(CIO) ↔ 전술(Process2) 정보 대칭성 확보

---

## ⏰ Part 9: CIO 실행 빈도 최적화

### 9.1 현재 실행 빈도 분석

**현재 코드 (main.py:621-638):**
```python
# 스케줄 설정
schedule.every(PROCESS1_INTERVAL).minutes.do(process1)  # 5분마다
schedule.every(1).hours.do(update_trading_universe)     # 1시간마다

# 포트폴리오 재구성 (CIO) - 현재 비활성화!
# schedule.every().day.at("09:10").do(run_portfolio_rebalance)  # ← 주석 처리됨

# AI 매매 판단 (Process2) - 하루 3회
schedule.every().day.at(PROCESS2_DAILY_TIME).do(enqueue_process2)  # 09:10
schedule.every().day.at("21:40").do(enqueue_process2)              # 21:40
schedule.every().day.at("04:00").do(enqueue_process2)              # 04:00
```

**실제 실행 트리거:**
```python
# main.py:386-387
def process2_worker():
    """Process2 큐에서 작업 꺼내서 실행"""
    trigger_coins = process2_queue.get()

    run_portfolio_rebalance()        # ← CIO 실행 (매번!)
    run_ai_decision_analysis(trigger_coins)  # Process2 실행
```

**현재 CIO 실행 조건 (코드 분석 결과):**
1. ✅ **시스템 시작 시** (main.py:610)
   - `run_portfolio_rebalance()` 직접 호출

2. ✅ **Process2 큐가 실행될 때마다** (main.py:386)
   - Process2가 호출되면 무조건 CIO도 함께 실행
   - 트리거: 하루 3회 스케줄 (09:10, 21:40, 04:00)
   - 트리거: Process1에서 긴급 상황 감지 시 (`enqueue_process2` 호출)

3. ✅ **AI 자동편입 모드에서 신규 코인 추가 시** (main.py:431-436)
   - `update_trading_universe()` → 1시간마다 실행
   - 신규 코인 발견 시 `enqueue_process2` 호출 → CIO 실행

**실제 실행 빈도 계산:**
```
최소 빈도: 하루 3회 (스케줄: 09:10, 21:40, 04:00)
최대 빈도: 하루 3회 + α
  - α: AI 자동편입으로 신규 코인 추가된 횟수
  - α: Process1 긴급 상황 감지 횟수

예상 일일 실행: 3~8회
```

---

### 9.2 문제점 및 최적화 방향

#### 현재 문제점:

**1. Process2 실행할 때마다 CIO도 무조건 실행**
```python
# main.py:386-387 (문제의 코드)
def process2_worker():
    run_portfolio_rebalance()        # ← 매번 실행 (불필요할 수 있음)
    run_ai_decision_analysis(trigger_coins)
```

**왜 문제인가?**
- Process2는 "기존 보유 종목의 매도/추가매수 판단" (전술 실행)
- CIO는 "전체 포트폴리오 비중 재설계" (전략 계획)
- **전술 실행할 때마다 전략을 다시 짜는 것은 비효율적**

**예시:**
```
09:10 스케줄 발동
→ CIO 실행: BTC 20%, ETH 15%, SOL 10% 목표 설정
→ Process2 실행: BTC 추가매수 결정

21:40 스케줄 발동 (8시간 후)
→ CIO 다시 실행: BTC 21%, ETH 14%, SOL 11% (약간만 변경)
→ Process2 실행: ETH 추가매수 결정

💡 8시간 만에 시장이 극적으로 변하지 않았다면,
   CIO를 다시 실행할 필요 없이 기존 목표 비중 유지해도 됨
```

**2. 스케줄 기반 CIO 실행이 주석 처리됨**
```python
# schedule.every().day.at("09:10").do(run_portfolio_rebalance)  # ← 비활성화
```
- 현재는 Process2 호출할 때만 CIO가 실행됨
- CIO 단독 실행 스케줄이 없음

---

### 9.3 사용자 제안 분석

**사용자가 제안한 3가지 트리거:**
1. ✅ **1시간마다 AI 자동편입모드에서 편입된 코인이 있는 경우**
2. ✅ **일일 지정된 시간**
3. ✅ **긴급도에서 시장 변화가 생겼을 때**

**각 트리거 평가:**

**트리거 1: AI 자동편입 신규 코인 (현재 구현됨 ✅)**
```python
# main.py:431-436
def update_trading_universe():
    latest_universe = get_dynamic_universe()
    if latest_universe:  # 신규 코인 발견
        enqueue_process2(trigger_coins=[...])  # → CIO 실행
```
- ✅ **매우 합리적**: 신규 코인은 포트폴리오 구성을 바꿀 수 있는 중요 정보
- ✅ **현재 구현 완료**

**트리거 2: 일일 지정된 시간**
```python
# 제안: 하루 1~2회 정기 재평가
schedule.every().day.at("09:00").do(run_portfolio_rebalance)  # 업비트 데이터 갱신 직후
schedule.every().day.at("21:00").do(run_portfolio_rebalance)  # (선택) 미국 시장 마감 후
```
- ✅ **합리적**: 시장 전체를 정기적으로 재평가
- ⚠️ **주의**: Process2와 중복 실행 방지 필요

**트리거 3: 긴급도 시장 변화 (현재 부분 구현 ⚠️)**
```python
# main.py:221-256
if market_analysis.get('has_issue_coins', False):
    enqueue_process2(trigger_coins=market_triggers)  # → CIO 실행
```
- ✅ **현재 구현됨**: 긴급 상황 시 Process2 큐 추가 → CIO 실행
- ⚠️ **문제**: 모든 긴급 상황에서 CIO를 실행할 필요는 없음
  - 예: 보유 종목 1개만 -7% 하락 (긴급도 70) → Process2만 처리하면 됨
  - 예: 시장 체제 전환 (긴급도 85) → CIO 전략 재수립 필요

---

### 9.4 최적화 권장 사항

**✅ 최종 권장 전략: "조건부 분리 실행"**

**핵심 원칙:**
1. **CIO는 "전략 계획"** → 시장 구조가 바뀔 때만 실행
2. **Process2는 "전술 실행"** → 자주 실행해도 OK
3. **불필요한 중복 실행 방지** → AI 비용 절감

---

### 9.5 구체적 구현 방안

**1단계: Process2 워커 로직 개선 (조건부 CIO 실행)**

```python
# main.py:375-398 수정
def process2_worker():
    """Process2 전용 워커 스레드 (개선 버전)"""
    last_cio_run_time = None  # CIO 마지막 실행 시간 추적

    while not shutdown_flag.is_set():
        try:
            trigger_coins = process2_queue.get(timeout=1.0)

            # [개선] CIO 실행 조건 판단
            should_run_cio = False
            trigger_type = None

            if trigger_coins:
                # 트리거 타입 확인
                trigger_types = {t.get('type') for t in trigger_coins}

                # 조건 1: 신규 편입 코인
                if 'new_addition' in trigger_types:
                    should_run_cio = True
                    trigger_type = "신규 편입 코인"

                # 조건 2: 시장 체제 전환 (긴급도 85점 이상)
                if 'market_regime_change' in trigger_types:
                    should_run_cio = True
                    trigger_type = "시장 체제 전환"

                # 조건 3: 정기 재평가 (하루 1회 이상 경과)
                if last_cio_run_time is None or \
                   (datetime.now() - last_cio_run_time).total_seconds() > 86400:  # 24시간
                    should_run_cio = True
                    trigger_type = "정기 재평가 (24시간 경과)"

            # CIO 실행 (조건부)
            if should_run_cio:
                logger.info(f"🎯 CIO 실행 트리거: {trigger_type}")
                run_portfolio_rebalance()
                last_cio_run_time = datetime.now()
            else:
                logger.info("⏭️ CIO 건너뜀 (기존 목표 비중 유지)")

            # Process2는 항상 실행
            run_ai_decision_analysis(trigger_coins)

            process2_queue.task_done()

        except queue.Empty:
            continue
```

**2단계: 긴급도 분류 개선 (긴급도 레벨별 처리)**

```python
# ai_strategy.py:2658-2662 수정
if final_urgency_score >= urgency_threshold:
    # [개선] 긴급도 레벨 분류
    if final_urgency_score >= 85:
        # 초긴급: 시장 체제 전환 → CIO 필요
        trigger_type = 'market_regime_change'
        logger.warning(f"🔥 초긴급 (85+): CIO 재구성 필요")
    else:
        # 일반 긴급: 보유 종목 이슈 → Process2만
        trigger_type = 'market_issue'
        logger.warning(f"⚠️ 일반 긴급 (65-84): Process2만 실행")

    return {
        'has_issue_coins': True,
        'trigger_type': trigger_type,  # 신규 필드
        'issue_coins': triggered_coins_formatted,
        'urgency_score': final_urgency_score  # 신규 필드
    }
```

**3단계: 스케줄 기반 CIO 정기 실행 추가**

```python
# main.py:621-638 수정
schedule.every(PROCESS1_INTERVAL).minutes.do(process1)
schedule.every(1).hours.do(update_trading_universe)

# [신규] CIO 정기 재평가 (하루 1회)
schedule.every().day.at("09:00").do(lambda: enqueue_process2([{
    'type': 'daily_rebalance',
    'symbol': 'SCHEDULED',
    'reason': '정기 포트폴리오 재평가'
}]))

# Process2 정기 실행 (하루 3회)
schedule.every().day.at("09:10").do(enqueue_process2)
schedule.every().day.at("21:40").do(enqueue_process2)
schedule.every().day.at("04:00").do(enqueue_process2)
```

**4단계: Process1 긴급 상황 트리거 개선**

```python
# main.py:221-256 수정
if market_analysis.get('has_issue_coins', False):
    issue_coins = market_analysis.get('issue_coins', [])
    urgency_score = market_analysis.get('urgency_score', 0)
    trigger_type = market_analysis.get('trigger_type', 'market_issue')

    # 트리거 생성 (타입 포함)
    market_triggers = []
    for coin_info in issue_coins:
        market_triggers.append({
            'symbol': coin_info['symbol'],
            'type': trigger_type,  # 'market_regime_change' or 'market_issue'
            'urgency_score': urgency_score,
            'issue_reason': coin_info['reason']
        })

    # Process2 큐에 추가 (CIO 실행 여부는 worker가 판단)
    enqueue_process2(trigger_coins=market_triggers)
```

---

### 9.6 최적화 후 실행 빈도

**CIO 실행 조건 (개선 후):**
1. ✅ **시스템 시작 시** (1회)
2. ✅ **하루 1회 정기 재평가** (09:00)
3. ✅ **AI 자동편입으로 신규 코인 추가 시** (평균 0~2회/일)
4. ✅ **시장 체제 전환 감지 시** (긴급도 85점 이상, 평균 0~1회/일)

**예상 일일 실행 빈도:**
```
평상시: 1~2회/일 (정기 재평가 + 신규 편입 0~1회)
변동성 큰 날: 3~4회/일 (정기 + 신규 편입 + 체제 전환)

기존: 3~8회/일
개선: 1~4회/일
→ AI 비용 약 40~50% 절감
```

**Process2 실행 빈도 (변경 없음):**
```
- 하루 3회 정기 실행 (09:10, 21:40, 04:00)
- Process1 긴급 상황 감지 시 (0~5회/일)
→ 총 3~8회/일 (기존과 동일)
```

---

### 9.7 구현 우선순위

**즉시 실행 (Phase 1):**
1. ✅ Process2 워커 조건부 CIO 실행 로직 추가
2. ✅ 긴급도 레벨 분류 (85점 이상 = 체제 전환)
3. ✅ CIO 정기 재평가 스케줄 추가 (09:00)

**테스트 후 실행 (Phase 2):**
4. ⏳ 24시간 경과 자동 재평가 로직 (보험)
5. ⏳ CIO 실행 빈도 모니터링 및 미세 조정

**기대 효과:**
- AI 분석 비용 40~50% 절감
- CIO 실행을 "의미있는 시장 변화"에만 집중
- Process2는 여전히 빠르게 대응 (기존 빈도 유지)
- 전략(CIO) ↔ 전술(Process2) 역할 명확히 분리

---

### 9.8 과거 분리 운영 경험 및 싱크 이슈 분석

**사용자 피드백:**
> "이전에 process2에 비중/매매 모두 들어가있었는데, RUN_PROCESS_2_TEST와 RUN_PORTFOLIO_REBALANCE_TEST로 분리해서 독립적으로 운영도 해봤는데, 뭔가 싱크가 제대로 맞지 않는 느낌이라서 현재 다시 process2_worker()에 모두 넣고 사용중"

**싱크 이슈의 원인 분석:**

**1. 타이밍 불일치 (Timing Mismatch)**
```python
# 문제 상황 예시:

09:00 - CIO 실행 (독립 스케줄)
→ BTC 20%, ETH 15%, SOL 10% 목표 설정
→ DB에 저장

09:05 - 시장 급변 (BTC +8% 급등)
→ Process1이 긴급 상황 감지
→ Process2 큐에 추가

09:06 - Process2 실행 (매매 판단만)
→ DB에서 목표 비중 읽음: BTC 20%
→ 현재 보유: BTC 15%
→ 판단: "추가매수 5% 필요"

하지만! 09:00 이후 시장이 크게 바뀌었는데,
CIO는 다음 정기 재평가(내일 09:00)까지 목표를 업데이트하지 않음
→ Process2는 "구식 목표"를 보고 매매 판단
→ 싱크 불일치!
```

**2. 데이터 정합성 문제 (Data Consistency)**
```python
# CIO와 Process2가 다른 시점의 데이터를 봄

CIO (09:00 실행):
- 시장 데이터: 09:00 시점
- 포트폴리오: 09:00 시점
→ 목표 비중 설정

Process2 (09:06 실행):
- 시장 데이터: 09:06 시점 (6분 후)
- 포트폴리오: 09:06 시점
- 하지만 목표는 09:00 시점 기준
→ 시간차로 인한 판단 오류
```

**3. 상태 전이 누락 (State Transition Loss)**
```python
# CIO와 Process2 사이에 상태 변화가 반영되지 않음

09:00 - CIO 실행
→ SOL을 '활성'으로 판단, 10% 비중 설정

09:05 - SOL 악재 발생 (거래소 상장폐지 발표)
→ Process1이 감지하지 못함 (다음 5분 주기 대기)

09:10 - Process2 실행
→ CIO 목표대로 "SOL 10% 맞추기 위해 추가매수"
→ 하지만 이미 악재로 -20% 폭락 중
→ 손실 발생!

09:15 - CIO 다음 실행 (독립 스케줄)
→ 이제야 SOL을 '제외'로 변경
→ 너무 늦음!
```

---

### 9.9 최종 권장 방안: "동기화된 함께 실행" (현재 방식 유지 + 조건부 개선)

**핵심 인사이트:**
- 사용자의 과거 경험이 증명: **CIO와 Process2는 같은 시점의 데이터를 봐야 함**
- 분리 실행의 이론적 장점(비용 절감)보다, **정합성 보장**이 더 중요
- 하지만 **무조건 실행**은 비효율적 → **조건부 실행**으로 개선

**✅ 최종 권장 전략: "동기화된 조건부 실행"**

**방안 A: 현재 방식 유지 + 스마트 스킵 (추천 ⭐⭐⭐)**
```python
# main.py:375-398 수정
def process2_worker():
    """Process2 전용 워커 스레드 (개선 버전)"""
    last_cio_result = None  # 마지막 CIO 결과 캐시

    while not shutdown_flag.is_set():
        try:
            trigger_coins = process2_queue.get(timeout=1.0)

            # [핵심] CIO 실행 여부 결정 (스마트 스킵)
            should_run_cio = _should_run_cio(trigger_coins, last_cio_result)

            if should_run_cio:
                logger.info("🎯 CIO 실행: 의미있는 변화 감지")
                new_weights = run_portfolio_rebalance()
                last_cio_result = {
                    'weights': new_weights,
                    'timestamp': datetime.now(),
                    'market_phase': get_current_market_phase()
                }
            else:
                logger.info("⏭️ CIO 스킵: 기존 목표 유지 (변화 없음)")

            # Process2는 항상 실행 (CIO 목표 기반)
            run_ai_decision_analysis(trigger_coins)

            process2_queue.task_done()

        except queue.Empty:
            continue

def _should_run_cio(trigger_coins, last_cio_result):
    """CIO 실행이 필요한지 판단하는 스마트 로직"""

    # 조건 1: 첫 실행이거나 24시간 경과 → 무조건 실행
    if last_cio_result is None:
        return True

    last_run = last_cio_result['timestamp']
    if (datetime.now() - last_run).total_seconds() > 86400:
        return True

    # 조건 2: 신규 편입 코인 → 무조건 실행
    trigger_types = {t.get('type') for t in trigger_coins} if trigger_coins else set()
    if 'new_addition' in trigger_types:
        return True

    # 조건 3: 시장 체제 전환 (긴급도 85+) → 무조건 실행
    if 'market_regime_change' in trigger_types:
        return True

    # 조건 4: 시장 페이즈 변경 → 무조건 실행
    current_phase = get_current_market_phase()
    if current_phase != last_cio_result.get('market_phase'):
        logger.info(f"📊 시장 페이즈 변경 감지: {last_cio_result.get('market_phase')} → {current_phase}")
        return True

    # 조건 5: 일반 긴급 상황 (긴급도 65-84) → 스킵 (Process2만 처리)
    return False
```

**장점:**
- ✅ **완벽한 동기화**: CIO와 Process2가 항상 같은 시점 데이터 사용
- ✅ **정합성 보장**: 상태 전이 누락 없음
- ✅ **비용 절감**: 의미없는 재실행 방지 (스마트 스킵)
- ✅ **사용자 경험 검증됨**: 현재 방식 기반이므로 안정성 높음

**단점:**
- ⚠️ 완전 분리보다는 비용 절감 효과가 적음 (하지만 정합성이 더 중요)

---

**방안 B: CIO 결과 캐싱 + Process2 참조 (대안)**
```python
# CIO 결과를 DB에 저장하고, Process2가 참조
# 하지만 캐시 유효성 판단이 복잡하고, 역시 싱크 이슈 가능성 있음
# → 추천하지 않음
```

---

### 9.10 최종 비교 요약

| 항목 | 과거 (분리 실행) | 현재 (무조건 함께) | 개혁안 (조건부 함께) ⭐ |
|------|----------------|-----------------|---------------------|
| **CIO-Process2 동기화** | ❌ 싱크 불일치 | ✅ 완벽 동기화 | ✅ 완벽 동기화 |
| **CIO 실행 빈도** | 1~2회/일 (독립) | 3~8회/일 (매번) | 1~4회/일 (조건부) |
| **데이터 정합성** | ⚠️ 시간차 존재 | ✅ 동일 시점 | ✅ 동일 시점 |
| **AI 비용** | 낮음 | 높음 | 중간 (30~40% 절감) |
| **전략 안정성** | ⚠️ 구식 목표 가능 | ⚠️ 너무 자주 변경 | ✅ 의미있는 변화만 |
| **긴급 대응** | ❌ 지연 가능 | ✅ 즉시 대응 | ✅ 즉시 대응 |
| **구현 복잡도** | 높음 (상태 관리) | 낮음 | 중간 (조건 로직) |
| **사용자 검증** | ❌ 싱크 이슈 경험 | ✅ 현재 사용 중 | ✅ 현재 방식 개선 |

**결론:**
- 과거 분리 실행의 실패 원인: **타이밍 불일치 + 데이터 정합성 문제**
- 현재 방식의 문제: **무조건 실행으로 인한 비용 과다**
- 개혁안: **조건부 실행으로 두 마리 토끼 잡기**
  - CIO와 Process2는 함께 실행 (동기화 보장)
  - 하지만 의미있는 변화가 없으면 CIO 스킵 (비용 절감)

---

### 9.11 구현 세부사항

**Step 1: 스마트 스킵 로직 구현**
```python
# main.py에 추가
def _should_run_cio(trigger_coins, last_cio_result):
    """
    CIO 실행 필요성을 판단하는 핵심 로직

    Returns:
        True: CIO 실행 필요
        False: CIO 스킵 (기존 목표 유지)
    """
    # [조건 1] 첫 실행이거나 24시간 경과
    if last_cio_result is None:
        return True

    last_run = last_cio_result.get('timestamp')
    if last_run and (datetime.now() - last_run).total_seconds() > 86400:
        logger.info("⏰ 24시간 경과 → CIO 정기 재평가 필요")
        return True

    # [조건 2] 신규 편입 코인
    trigger_types = {t.get('type') for t in trigger_coins} if trigger_coins else set()
    if 'new_addition' in trigger_types:
        logger.info("🆕 신규 코인 편입 → CIO 재구성 필요")
        return True

    # [조건 3] 시장 체제 전환 (긴급도 85+)
    if 'market_regime_change' in trigger_types:
        logger.info("🔥 시장 체제 전환 → CIO 재구성 필요")
        return True

    # [조건 4] 시장 페이즈 변경 (공포↔탐욕)
    current_phase = _get_current_market_phase()
    last_phase = last_cio_result.get('market_phase', 'unknown')
    if current_phase != last_phase:
        logger.info(f"📊 시장 페이즈 변경: {last_phase} → {current_phase} → CIO 재구성 필요")
        return True

    # [조건 5] 정기 재평가 트리거
    if 'daily_rebalance' in trigger_types:
        logger.info("📅 정기 재평가 시간 → CIO 재구성 필요")
        return True

    # 그 외 일반 긴급 상황 → CIO 스킵
    logger.info("⏭️ 일반 긴급 상황 → CIO 스킵 (Process2만 처리)")
    return False

def _get_current_market_phase():
    """현재 시장 페이즈 조회 (공포/탐욕/중립)"""
    try:
        market_data = market_cache.get_market_data(mode='quick')
        fear_greed = market_data.get('fear_greed_index', {})
        value = fear_greed.get('data', {}).get('value', 50)

        if value >= 70:
            return 'greed'
        elif value >= 55:
            return 'neutral'
        elif value >= 40:
            return 'neutral'
        else:
            return 'fear'
    except:
        return 'unknown'
```

**Step 2: Process2 워커 수정**
```python
# main.py:375-398 수정
def process2_worker():
    """Process2 전용 워커 스레드 (최종 개선 버전)"""
    logger.info("🔄 Process2 워커 스레드 시작")

    # [핵심] CIO 결과 캐시 (동기화 보장용)
    last_cio_result = None

    while not shutdown_flag.is_set():
        try:
            trigger_coins = process2_queue.get(timeout=1.0)

            if not trigger_coins:
                process2_queue.task_done()
                continue

            logger.info("=" * 80)
            logger.info(f"📥 Process2 큐 작업 시작 - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
            logger.info(f"🎯 트리거: {len(trigger_coins)}개 감지")
            logger.info("=" * 80)

            # Process1이 완전히 끝날 때까지 대기 (DB 락 방지)
            if process_locks['process1'].locked():
                logger.info("⏳ Process1 완료 대기 중...")
                while process_locks['process1'].locked() and not shutdown_flag.is_set():
                    time.sleep(0.1)

            # [핵심 개선] 조건부 CIO 실행
            should_run_cio = _should_run_cio(trigger_coins, last_cio_result)

            if should_run_cio:
                logger.info("🎯 CIO 포트폴리오 재구성 실행")
                new_weights = run_portfolio_rebalance()

                # CIO 결과 캐시 업데이트
                last_cio_result = {
                    'weights': new_weights,
                    'timestamp': datetime.now(),
                    'market_phase': _get_current_market_phase(),
                    'trigger_type': trigger_coins[0].get('type') if trigger_coins else 'unknown'
                }
            else:
                logger.info("⏭️ CIO 스킵 (기존 목표 비중 유지)")

            # Process2는 항상 실행 (CIO 최신 목표 기반)
            logger.info("🤖 AI 매매 판단 실행")
            run_ai_decision_analysis(trigger_coins)

            process2_queue.task_done()
            logger.info("✅ Process2 큐 작업 완료\n")

        except queue.Empty:
            continue
        except Exception as e:
            logger.error(f"❌ Process2 워커 오류: {e}", exc_info=True)
            process2_queue.task_done()
```

**Step 3: 스케줄 추가 (정기 재평가 보장)**
```python
# main.py:621-638 수정
schedule.every(PROCESS1_INTERVAL).minutes.do(process1)
schedule.every(1).hours.do(update_trading_universe)

# [신규] 하루 1회 정기 재평가 트리거 추가 (보험)
schedule.every().day.at("09:00").do(lambda: enqueue_process2([{
    'type': 'daily_rebalance',
    'symbol': 'SCHEDULED',
    'reason': '정기 포트폴리오 재평가'
}]))

# Process2 정기 실행 (기존 유지)
schedule.every().day.at("09:10").do(enqueue_process2)
schedule.every().day.at("21:40").do(enqueue_process2)
schedule.every().day.at("04:00").do(enqueue_process2)
```

---

### 9.12 예상 실행 흐름 시뮬레이션

**시나리오 1: 평상시 (변동성 낮음)**
```
09:00 - 정기 재평가 트리거
→ should_run_cio() = True (정기 재평가)
→ CIO 실행: BTC 20%, ETH 15%, SOL 10%
→ Process2 실행: 목표 대비 조정 필요 판단

09:10 - Process2 정기 스케줄
→ should_run_cio() = False (9시간 미경과)
→ CIO 스킵
→ Process2만 실행: 기존 목표 기반 매매 판단

21:40 - Process2 정기 스케줄
→ should_run_cio() = False (12시간 경과, 하지만 시장 변화 없음)
→ CIO 스킵
→ Process2만 실행

다음날 09:00 - 정기 재평가 트리거
→ should_run_cio() = True (24시간 경과)
→ CIO 실행
→ Process2 실행

CIO 실행: 2회/일 (09:00 정기 + 특별 상황 0회)
```

**시나리오 2: 변동성 큰 날 (긴급 상황 다수)**
```
09:00 - 정기 재평가 트리거
→ CIO 실행 (정기)
→ 시장 페이즈: neutral

11:30 - Process1이 긴급 상황 감지 (긴급도 75, BTC -5%)
→ should_run_cio() = False (일반 긴급)
→ CIO 스킵
→ Process2만 실행: BTC 매도 판단

14:20 - Process1이 시장 체제 전환 감지 (긴급도 88)
→ should_run_cio() = True (체제 전환)
→ CIO 실행: 방어 모드로 전환
→ 시장 페이즈: fear
→ Process2 실행: 현금 비중 확대

17:00 - AI 자동편입으로 XRP 신규 추가
→ should_run_cio() = True (신규 편입)
→ CIO 실행: XRP 포함 재구성
→ Process2 실행: XRP 초기 매수

21:40 - Process2 정기 스케줄
→ should_run_cio() = False (페이즈 동일, 4시간 경과)
→ CIO 스킵
→ Process2만 실행

CIO 실행: 4회/일 (정기 1회 + 체제전환 1회 + 신규편입 1회 + 다음날 정기 1회)
```

---

### 9.13 최종 비용 및 효과 분석

**CIO 실행 빈도 비교:**
```
[현재] 무조건 함께 실행
- 평상시: 3회/일 (스케줄)
- 변동성 높은 날: 5~8회/일
- 평균: 4~5회/일

[개혁안] 조건부 함께 실행
- 평상시: 1~2회/일 (정기 1회 + α 0~1회)
- 변동성 높은 날: 3~4회/일 (정기 1회 + 긴급 2~3회)
- 평균: 2~3회/일

비용 절감: 약 30~40%
```

**정합성 보장:**
- ✅ CIO와 Process2 항상 동일 시점 데이터 사용
- ✅ 상태 전이 누락 없음
- ✅ 타이밍 불일치 해결
- ✅ 과거 분리 실행의 싱크 이슈 근본 해결

**핵심 장점:**
1. **사용자 경험 검증**: 현재 방식 기반이므로 안정성 높음
2. **점진적 개선**: 큰 구조 변경 없이 조건 로직만 추가
3. **완벽한 동기화**: 분리 실행의 싱크 이슈 원천 차단
4. **비용 절감**: 스마트 스킵으로 불필요한 재실행 방지
5. **유연성**: 추후 조건 로직만 조정하면 세밀한 최적화 가능

---

## 🎯 Part 10: 최종 종합 개혁안 (Final Reform Plan)

### 10.1 개혁의 핵심 요약

이번 CIO 포트폴리오 개혁은 **"단순 고도화가 아닌 전면 개혁"**입니다. 4대 핵심 원칙을 바탕으로 다음 3가지 최적화를 추가로 완성했습니다:

**🔵 4대 핵심 원칙 (Part 1-4)**
1. ✅ **AI 자율 의사결정 우선** - 하드코딩 규칙 제거, AI가 맥락에 맞춰 스스로 판단
2. ✅ **6개월 프롬프트 보존** - 기존 프롬프트 삭제 금지, 보완만
3. ✅ **기존 함수 재사용** - 신규 함수 최소화, 중복 제거
4. ✅ **전략 vs 전술 분리** - CIO가 목표 설정, Process2가 타이밍 실행

**🟢 3대 추가 최적화 (Part 8-9)**
5. ✅ **긴급 코인 정보 통합** - CIO가 Process1 긴급 상황 인지하여 포트폴리오 반영
6. ✅ **조건부 함께 실행** - 동기화 보장하면서 비용 30~40% 절감
7. ✅ **싱크 이슈 근본 해결** - 과거 분리 실행 경험의 교훈 반영

---

### 10.2 전체 구현 로드맵

**Phase 1: 프롬프트 및 스키마 개선 (코드 최소 수정) ⏰ 1일** ✅ **구현 완료 (2025-10-15)**

**1.1 CIO 프롬프트 보완** ([ai_strategy.py:1849-1930](ai_strategy.py#L1849-L1930)) ✅
```python
# 기존 프롬프트 보존하면서 6개 신규 프롬프트 추가 (Part 5.2.B) ⭐ 개선됨
1. AI 자율 판단 강화 (Autonomy Enhancement)
2. 수익 실현 전략 - 페르소나별 차별화 (Profit Taking Strategy) ⭐
3. 섹터 밸런스 관리 (Sector Balance Guidance)
4. 편입/제외 일관성 규칙 (Entry/Exit Consistency)
5. 목표 설정 책임 (Target Setting Responsibility)
6. Rationale 충돌 해결 지침 (Rationale Conflict Resolution) ⭐ 신규
```

**1.2 CIO JSON 스키마 수정** ([ai_strategy.py:1973-1991, 2062-2073](ai_strategy.py)) ✅
```python
# targets 필드 추가 (Part 6.1)
{
    "targets": {
        "BTC": {
            "target_profit": 12,
            "stop_loss": -6,
            "rationale": "..."
        }
    }
}
```

**1.3 긴급 코인 파라미터 추가** ([ai_strategy.py:1629, main.py:283-301](ai_strategy.py)) ✅
```python
# Part 8.3 구현
def recalculate_portfolio_weights(
    newly_added_coins: List[CoinConfig] = None,
    emergency_coins: List[Dict] = None  # 신규
) -> Dict[str, float]:

# ⭐ 추가: CIO targets 저장 로직 (ai_strategy.py:2757-2776)
targets = ai_result.get('targets', {})
for symbol, target_info in targets.items():
    db_manager.update_holding_status(symbol, {
        'GPT목표수익률': target_profit,
        'GPT목표손절률': stop_loss
    })
```

---

**Phase 2: 핵심 로직 개선 (신규 함수 최소) ⏰ 2일** ✅ **구현 완료 (2025-10-15)**

**2.1 섹터 분류 함수 신규 생성** ([config.py:837-911](config.py#L837-L911)) ✅ 구현 완료
```python
# Part 5.2.B.5 구현
SECTOR_MAP = {
    "BTC": "Store of Value",
    "ETH": "Smart Contract Platform",
    "SOL": "High-Performance L1",
    "AVAX": "High-Performance L1",
    "AAVE": "DeFi Lending",
    "UNI": "DeFi DEX",
    # ... 50+ 코인 전체
}

def get_sector_classification(symbol: str) -> str:
    return SECTOR_MAP.get(symbol, "Other")

# ⭐ 추가 개선: 개별 자산 분석 출력에 섹터 정보 포함
# ai_strategy.py:2548 - User Prompt에 섹터 표시
- **유동성 등급**: **{liquidity_grade}** | **섹터**: **{get_sector_classification(symbol)}** | **관리상태**: **{management_status}**
```

**2.2 긴급 코인 프롬프트 통합 및 데이터 흐름** ✅
```python
# Part 8.3 단계 3 구현 (ai_strategy.py:2618-2642)
if emergency_coins:
    emergency_context = f"""
    ## 🚨 긴급 시장 상황 알림
    Process1 실시간 모니터링에서 다음 긴급 상황을 감지했습니다:
    ...
    """

# ⭐ 추가: 완전한 데이터 흐름 구현
# main.py:484-496 - emergency_coins 추출 및 전달
emergency_coins = [
    {'symbol': t['symbol'], 'reason': t.get('reason'), ...}
    for t in trigger_coins
    if t.get('type') in ['market_issue', 'market_regime_change']
]
new_weights = run_portfolio_rebalance(emergency_coins=emergency_coins)

# ai_strategy.py:1662-1680 - CIO에서 긴급 코인 분석 대상 추가
```

**2.3 CIO 조건부 실행 로직** ([main.py:378-447](main.py#L378-L447)) ✅
```python
# Part 9.11 구현 (핵심 개선!)
def _should_run_cio(trigger_coins, last_cio_result):
    """CIO 실행 필요성 판단"""
    # 5가지 조건 체크
    # 1. 첫 실행 or 24시간 경과
    # 2. 신규 편입 코인
    # 3. 시장 체제 전환 (긴급도 85+)
    # 4. 시장 페이즈 변경 (공포↔탐욕)
    # 5. 정기 재평가 트리거

def _get_current_market_phase() -> str:
    """현재 시장 페이즈 조회 (공포/탐욕/중립)"""
```

**2.4 긴급도 레벨 분류** ([ai_strategy.py:2976-3007](ai_strategy.py#L2976-L3007)) ✅
```python
# Part 9.11 단계 2 구현
if final_urgency_score >= 85:
    trigger_type = 'market_regime_change'  # CIO 필요
else:
    trigger_type = 'market_issue'  # Process2만

# coin_info에 type 필드 추가
coin_info['type'] = trigger_type
```

---

**Phase 3: Process2 수정 및 통합 ⏰ 1일** ✅ **구현 완료 (2025-10-15)**

**3.1 Process2 JSON 스키마 수정** ([ai_strategy.py:1282-1296](ai_strategy.py#L1282-L1296)) ✅
```python
# GPT목표수익률/손절률 제거 (CIO로 이관)
# Part 6.2 구현
"required": ["coin", "매매판단", "판단확신", "GPT매매비중", "거래사유", "thinking_process"]
# GPT목표수익률, GPT목표손절률 제거됨
```

**3.2 Process2 프롬프트 수정** ([ai_strategy.py:747-764](ai_strategy.py#L747-L764)) ✅
```python
# CIO 목표 읽어서 포함
# Part 6.3 구현
cio_target_profit = safe_float(holding_info.get('GPT목표수익률', 15))
cio_stop_loss = safe_float(holding_info.get('GPT목표손절률', -7))
position_details = f"""
* **[CIO 전략 목표]** 목표수익률: {target_profit:+.1f}% | 손절률: {stop_loss:+.1f}%
  (CIO가 포트폴리오 전략에 따라 설정한 목표입니다. 이 범위 내에서 최적 타이밍을 찾으십시오.)
"""
```

**3.3 Process2 워커 최종 개선** ([main.py:454-510](main.py#L454-L510)) ✅
```python
# Part 9.11 단계 2 구현
def process2_worker():
    last_cio_result = None  # 캐시

    while not shutdown_flag.is_set():
        # 조건부 CIO 실행
        if _should_run_cio(trigger_coins, last_cio_result):
            new_weights = run_portfolio_rebalance(emergency_coins=emergency_coins)
            last_cio_result = {...}  # 캐시 업데이트
        else:
            logger.info("⏭️ CIO 스킵")

        # Process2 항상 실행
        run_ai_decision_analysis(trigger_coins)
```

---

**Phase 4: 스케줄 및 DB 수정 ⏰ 1일** ✅ **구현 완료 (2025-10-15)**

**4.1 스케줄 추가** ([main.py:730-734](main.py#L730-L734)) ✅
```python
# Part 9.11 단계 3 구현
schedule.every().day.at("09:00").do(lambda: enqueue_process2([{
    'type': 'daily_rebalance',
    'symbol': 'SCHEDULED',
    'reason': '정기 포트폴리오 재평가'
}]))
```

**4.2 DB 스키마 확장** ⚠️ **사용자 결정: 기존 holding_status 테이블 활용**
```
# 신규 테이블 생성하지 않음
# 이유: 기존 holding_status 테이블의 GPT목표수익률/GPT목표손절률 컬럼 활용
# 장점: 조인 불필요, 기존 구조 재사용, 추가 작업 최소화
```

---

**Phase 5: 테스트 및 검증 ⏰ 3일** 🔜 **사용자 진행 예정**

**5.1 단위 테스트**
```python
# config.py 테스트 플래그 활용
RUN_PORTFOLIO_REBALANCE_TEST = True

# 테스트 항목:
1. CIO 조건부 실행 로직 검증
2. 긴급 코인 통합 검증
3. 시장 페이즈 변경 감지 검증
4. 24시간 정기 재평가 검증
```

**5.2 통합 테스트**
```python
# 시나리오 테스트
1. 평상시 (변동성 낮음): CIO 1~2회/일 확인
2. 변동성 큰 날: CIO 3~4회/일 확인
3. 신규 편입: CIO 즉시 실행 확인
4. 시장 체제 전환: CIO 즉시 실행 확인
```

**5.3 백테스트** (선택사항)
```python
# 과거 40일 데이터로 개혁안 검증
- 승률 개선: 35% → 50%+
- 손익비 개선: 0.6 → 1.5+
- 최대 낙폭 감소: -25% → -12%
```

**5.4 실전 소액 테스트**
```
- 100만원으로 1주일 테스트
- 로그 분석하여 CIO 실행 빈도 확인
- 싱크 이슈 발생 여부 확인
```

---

### 10.3 기대 효과 (Before → After)

| 지표 | 현재 (Before) | 개혁 후 (After) | 개선율 |
|------|--------------|----------------|--------|
| **승률** | 35% | 50%+ | +43% |
| **손익비** | 0.6 | 1.5+ | +150% |
| **최대 낙폭** | -25% | -12% | +52% |
| **보유 안정성** | 5일 | 12일+ | +140% |
| **CIO 실행 빈도** | 4~5회/일 | 2~3회/일 | -40% |
| **AI 비용** | 높음 | 중간 | -30~40% |
| **CIO-Process2 동기화** | ⚠️ 싱크 이슈 가능 | ✅ 완벽 동기화 | +100% |
| **데이터 정합성** | ✅ 동일 시점 | ✅ 동일 시점 | 유지 |
| **긴급 대응** | ⚠️ CIO는 인지 못함 | ✅ 전략-전술 통합 | +100% |

---

### 10.4 핵심 개선 포인트

**1. 과거 싱크 이슈 근본 해결 (Part 9.8-9.9)**
- ❌ 과거: CIO와 Process2 분리 → 타이밍 불일치, 데이터 정합성 문제
- ✅ 개혁안: 조건부 함께 실행 → 완벽한 동기화 + 비용 절감

**2. 정보 비대칭 해소 (Part 8)**
- ❌ 과거: Process1 긴급 코인 → Process2만 인지 → CIO는 모름
- ✅ 개혁안: CIO도 긴급 상황 인지 → 포트폴리오 전략에 반영

**3. 역할 재정립 (Part 4)**
- ❌ 과거: Process2가 목표 설정 + 매매 판단 (역할 혼재)
- ✅ 개혁안: CIO가 목표 설정 (전략) + Process2가 타이밍 실행 (전술)

**4. AI 자율성 극대화 (Part 1)**
- ❌ 과거: 하드코딩 규칙 (예: `MAX_SINGLE_POSITION = 20%`)
- ✅ 개혁안: 프롬프트로 유도, AI가 맥락에 맞춰 판단

**5. 비용 최적화 (Part 9)**
- ❌ 과거: CIO 무조건 실행 (4~5회/일)
- ✅ 개혁안: 스마트 스킵 (2~3회/일, 30~40% 절감)

---

### 10.5 실행 체크리스트

**✅ Phase 1: 프롬프트 및 스키마 개선 (1일)**
- [ ] CIO 프롬프트 5개 추가 (Part 5.2.B)
- [ ] CIO JSON 스키마에 targets 필드 추가
- [ ] 긴급 코인 파라미터 추가
- [ ] 프롬프트에 긴급 상황 컨텍스트 추가

**✅ Phase 2: 핵심 로직 개선 (2일)**
- [ ] 섹터 분류 함수 신규 생성
- [ ] `_should_run_cio()` 스마트 스킵 로직 구현
- [ ] `_get_current_market_phase()` 페이즈 조회 함수 구현
- [ ] 긴급도 레벨 분류 (85점 기준)

**✅ Phase 3: Process2 수정 및 통합 (1일)**
- [ ] Process2 JSON 스키마 수정 (목표 필드 제거)
- [ ] Process2 프롬프트 수정 (CIO 목표 포함)
- [ ] Process2 워커 조건부 CIO 실행 로직 적용

**✅ Phase 4: 스케줄 및 DB 수정 (1일)**
- [ ] 09:00 정기 재평가 스케줄 추가
- [ ] CIO targets 테이블 생성 (선택)
- [ ] Emergency coins 테이블 생성 (선택)

**✅ Phase 5: 테스트 및 검증 (3일)**
- [ ] 단위 테스트 (조건부 실행 로직)
- [ ] 통합 테스트 (전체 시나리오)
- [ ] 백테스트 (과거 40일)
- [ ] 실전 소액 테스트 (100만원 1주일)

**총 소요 기간: 8일 (1주일 + 1일)**

---

### 10.6 위험 요소 및 대응 방안

**위험 1: 조건부 실행 로직 버그**
- 위험: `_should_run_cio()` 로직 오류로 CIO가 필요한 순간 스킵될 가능성
- 대응: 24시간 경과 시 무조건 실행 (안전장치)
- 대응: 로그 상세 기록으로 모니터링

**위험 2: 긴급 코인 통합으로 인한 과매수**
- 위험: 긴급 코인을 CIO가 너무 적극적으로 편입할 가능성
- 대응: 긴급 코인은 '재평가' 상태로만 추가 (AI가 최종 판단)
- 대응: 프롬프트에 "긴급 = 기회이자 리스크" 명시

**위험 3: 시장 페이즈 오판**
- 위험: Fear/Greed 지수만으로 페이즈 판단 시 오류 가능성
- 대응: `_get_current_market_phase()` 로직에 예외 처리
- 대응: 페이즈 'unknown' 시 중립 모드 유지

**위험 4: 과거 싱크 이슈 재발**
- 위험: 조건부 실행에서도 미묘한 싱크 이슈 발생 가능성
- 대응: CIO와 Process2는 항상 함께 실행 (조건부지만 동기화 보장)
- 대응: `last_cio_result` 캐시로 최신 상태 추적

---

### 10.7 성공 기준 (KPI)

**정량적 지표:**
1. ✅ 승률 50% 이상 달성
2. ✅ 손익비 1.5 이상 달성
3. ✅ 최대 낙폭 -12% 이내 유지
4. ✅ CIO 실행 빈도 2~3회/일 유지
5. ✅ AI 비용 30% 이상 절감

**정성적 지표:**
1. ✅ CIO-Process2 싱크 이슈 0건
2. ✅ 긴급 코인 누락 0건
3. ✅ 전략-전술 역할 명확히 분리
4. ✅ 로그 가독성 향상 (CIO 스킵 사유 명확)
5. ✅ 사용자 만족도 (안정감)

---

### 10.8 마이그레이션 전략

**옵션 A: 점진적 마이그레이션 (추천 ⭐)**
```
1주차: Phase 1 (프롬프트) → 소액 테스트
2주차: Phase 2 (핵심 로직) → 소액 테스트
3주차: Phase 3-4 (통합) → 소액 테스트
4주차: Phase 5 (검증) → 프로덕션 배포
```

**옵션 B: 병렬 운영**
```
- 기존 시스템 유지 (메인 자금)
- 개혁안 별도 운영 (소액 자금)
- 2주간 성과 비교 후 전환
```

**옵션 C: 일괄 마이그레이션**
```
- 8일 집중 개발
- 백테스트 + 단위 테스트 완료 후
- 주말에 일괄 배포
```

---

### 10.9 최종 의사결정 매트릭스

| 개혁 항목 | 우선순위 | 난이도 | 기대효과 | 위험도 | 권장 |
|---------|---------|-------|---------|-------|------|
| **Part 1-4: 4대 원칙** | ⭐⭐⭐ | 낮음 | 매우 높음 | 낮음 | ✅ 즉시 실행 |
| **Part 5: 프롬프트 보완** | ⭐⭐⭐ | 낮음 | 높음 | 낮음 | ✅ 즉시 실행 |
| **Part 6: 역할 재정립** | ⭐⭐⭐ | 중간 | 매우 높음 | 중간 | ✅ 즉시 실행 |
| **Part 8: 긴급 코인 통합** | ⭐⭐ | 중간 | 중간 | 중간 | ✅ Phase 2 |
| **Part 9: 조건부 실행** | ⭐⭐⭐ | 중간 | 높음 | 낮음 | ✅ 즉시 실행 |

**최종 권장: 전체 개혁안 일괄 실행 (8일 소요)**

---

### 10.10 다음 단계

**즉시 실행 가능:**
1. ✅ 사용자 최종 승인
2. ✅ Phase 1 시작 (프롬프트 보완)
3. ✅ Git 브랜치 생성 (`feature/cio-reform`)
4. ✅ 일일 진행 상황 보고

**1주일 내:**
- Phase 1-4 완료 (코드 수정)
- 단위 테스트 완료
- 통합 테스트 시작

**2주일 내:**
- Phase 5 완료 (검증)
- 백테스트 결과 분석
- 실전 소액 테스트 시작

**1개월 내:**
- 프로덕션 배포
- 성과 모니터링
- 미세 조정

---

## 📌 최종 요약

### 이번 개혁의 핵심:
1. **"분리"가 아닌 "조건부 함께"** - 과거 싱크 이슈의 교훈
2. **"고도화"가 아닌 "전면 개혁"** - 근본적 원칙 재정립
3. **"이론"이 아닌 "실전 검증"** - 사용자 경험 기반

### 3대 혁신:
1. ✅ **완벽한 동기화** - CIO와 Process2 싱크 이슈 근본 해결
2. ✅ **정보 대칭** - 긴급 코인 통합으로 전략-전술 통합
3. ✅ **스마트 최적화** - 조건부 실행으로 비용 30~40% 절감

### 기대 결과:
- 승률: 35% → 50%+ (+43%)
- 손익비: 0.6 → 1.5+ (+150%)
- 최대 낙폭: -25% → -12% (+52%)
- AI 비용: -30~40% 절감

---

## 📝 Part 11: 구현 완료 로그 (Implementation Log)

**구현 일자**: 2025-10-15
**구현 엔진**: Claude Sonnet 4.5
**총 소요 시간**: 약 4시간 (문서 검토 + 구현 + 검증 + 문서 업데이트)

### 11.1 구현 완료 항목 (100%)

#### Phase 1-4: 핵심 기능 ✅ 완료
- ✅ **6개 신규 CIO 프롬프트 추가** (5개 계획 → 6개 구현, +1개)
  - AI 자율 판단 강화
  - 수익 실현 전략 - 페르소나별 차별화 ⭐ (개선됨)
  - 섹터 밸런스 관리
  - 편입/제외 일관성 규칙
  - 목표 설정 책임
  - Rationale 충돌 해결 지침 ⭐ (신규 추가)

- ✅ **CIO JSON targets 필드 추가**
  - OpenAI: ai_strategy.py:1973-1991
  - Gemini: ai_strategy.py:2062-2073

- ✅ **Emergency coins 완전한 데이터 흐름**
  - 파라미터 추가: ai_strategy.py:1629, main.py:283-301
  - 데이터 추출: main.py:484-496
  - CIO 통합: ai_strategy.py:1662-1680
  - 프롬프트 컨텍스트: ai_strategy.py:2618-2642

- ✅ **섹터 분류 시스템 (50+ 코인)**
  - SECTOR_MAP: config.py:837-911
  - get_sector_classification() 함수
  - ⭐ User Prompt에 섹터 정보 표시: ai_strategy.py:2548

- ✅ **스마트 스킵 로직 (5가지 조건)**
  - _should_run_cio(): main.py:378-424
  - _get_current_market_phase(): main.py:426-447

- ✅ **긴급도 레벨 분류 (85+ threshold)**
  - Gemini: ai_strategy.py:2976-3007
  - OpenAI: ai_strategy.py:3145-3158
  - type 필드 추가로 CIO vs Process2 라우팅

- ✅ **Process2 역할 재정립**
  - JSON schema에서 목표 필드 제거: ai_strategy.py:1282-1296
  - CIO 목표 읽기: ai_strategy.py:747-764

- ✅ **09:00 정기 재평가 스케줄**
  - main.py:730-734

- ✅ **CIO targets DB 저장 로직**
  - ai_strategy.py:2757-2776
  - holding_status 테이블의 GPT목표수익률/손절률 활용

### 11.2 추가 개선 사항 (문서 외 ⭐)

1. ✅ **섹터 정보를 개별 자산 분석에 포함**
   - 위치: ai_strategy.py:2548
   - 효과: CIO가 섹터 밸런스를 실제로 고려 가능

2. ✅ **페르소나별 차별화된 수익 실현 전략**
   - 위치: ai_strategy.py:1879-1896
   - 개선: 공격형/방어형/중립형 각각 다른 비율 적용
   - 효과: 시장 국면에 맞는 더 정교한 수익 실현

3. ✅ **Rationale 충돌 해결 지침 추가**
   - 위치: ai_strategy.py:2074, Part 5.2.B.6
   - 배경: 프롬프트 검증 중 발견된 논리적 모순 문제
   - 효과: AI가 상충하는 지표를 명시적으로 언급하도록 강제

### 11.3 검증 완료 항목

- ✅ **Python 문법 오류 없음** (py_compile 통과)
- ✅ **프롬프트 구조 완결성 검증** (System/User/Response 3단 구조)
- ✅ **System/User 프롬프트 상관관계 검증** (모든 데이터 정확히 매칭)
- ✅ **데이터 흐름 완전성 검증** (Process1 → CIO → Process2)
- ✅ **실제 테스트 프롬프트로 동작 검증** (Gemini 버전)
  - 입력: 공포탐욕지수 34, 변동성 30, CELO/MNT 보유
  - 출력: 70% 현금, targets 필드 정상 생성

### 11.4 기술적 의사결정 기록

**Q1: 신규 DB 테이블 생성 vs 기존 테이블 활용?**
**결정**: 기존 `holding_status` 테이블 활용
**근거**: 사용자 선호, 조인 불필요, 기존 구조 재사용

**Q2: CIO-Process2 분리 vs 조건부 함께 실행?**
**결정**: 조건부 함께 실행
**근거**: 사용자의 과거 분리 실행 시 싱크 이슈 경험 반영

**Q3: 프롬프트 개수 증가 (5 → 6개)?**
**결정**: Rationale 충돌 해결 지침 추가
**근거**: 프롬프트 검증 중 실제 문제 발견, 필수 개선 사항으로 판단

**Q4: 손익비 0 오류 처리 방법?**
**결정**: 코드 레벨 수정 권장사항으로 제시 (미구현)
**근거**: 데이터 수집 로직 수정 필요, 현재 AI 판단은 정상 작동 중

### 11.5 미완료 항목 (사용자 실전 테스트)

- 🔜 **Phase 5.1**: 단위 테스트 (조건부 실행 로직, 긴급 코인 통합 등)
- 🔜 **Phase 5.2**: 통합 테스트 (전체 시나리오 테스트)
- 🔜 **Phase 5.3**: 백테스트 (과거 40일 데이터)
- 🔜 **Phase 5.4**: 실전 소액 테스트 (1M won, 1주일)

### 11.6 성공 기준 (KPI) - 검증 대기

**정량적 지표**:
1. 🔜 승률 50% 이상 달성
2. 🔜 손익비 1.5 이상 달성
3. 🔜 최대 낙폭 -12% 이내 유지
4. 🔜 CIO 실행 빈도 2~3회/일 유지
5. 🔜 AI 비용 30% 이상 절감

**정성적 지표**:
1. 🔜 CIO-Process2 싱크 이슈 0건
2. 🔜 긴급 코인 누락 0건
3. ✅ 전략-전술 역할 명확히 분리 (구현 완료)
4. ✅ 로그 가독성 향상 (CIO 스킵 사유 명확) (구현 완료)
5. 🔜 사용자 만족도 (안정감)

### 11.7 참고 링크

- **구현 코드**:
  - ai_strategy.py (2,757줄 → 2,800+줄)
  - main.py (454-510줄: process2_worker, 378-447줄: 스마트 스킵 로직)
  - config.py (837-911줄: 섹터 분류)

- **원본 분석**: docs/CIO_PORTFOLIO_ANALYSIS.md (2,961줄)

- **Git 브랜치**: (사용자가 생성 예정)

### 11.8 다음 단계

**즉시 가능**:
1. ✅ 구현 완료 (Phase 1-4)
2. ✅ 문서 업데이트 완료
3. 🔜 사용자 실전 테스트 시작
4. 🔜 Git 커밋 & 브랜치 생성

**1주일 내**:
- 실전 소액 테스트 (1M won)
- 성과 모니터링 및 로그 분석
- 미세 조정 필요 시 추가 개선

**1개월 내**:
- 프로덕션 전체 자금 투입
- KPI 달성 여부 평가
- 최종 개혁 성공 판정

---

**분석 완료: 2025-10-15**
**구현 완료: 2025-10-15**
**문서 업데이트: 2025-10-15**
**최종 개혁안: 4대 원칙 + 3대 최적화 + 3대 추가 개선 = 완전한 CIO 포트폴리오 개혁** ✅
**다음: 사용자 최종 승인 후 Phase 1 즉시 시작 🚀**
