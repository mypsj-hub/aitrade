# 🔍 관심 코인(coin_watch_history) 삭제 로직 분석 리포트

**분석 일시**: 2025-10-25
**문제 상황**: LA, PROVE가 holding_status('활성')와 coin_watch_history에 동시 존재
**분석 목표**: 관심 코인 삭제 로직 전체 파악 및 버그 원인 규명

---

## 📋 관심 코인 삭제 경로 (총 2가지)

### 경로 1: AI 자동편입 1-2순위 승격 시 삭제 ✅

**파일**: `data_manager/universe.py` (Lines 711-715)

**시점**: AI 자동편입 실행 시, 1-2순위로 선정된 코인을 holding_status에 등록할 때

**코드**:
```python
# 1-2순위 처리 (holding_status에 '활성' 등록)
for i, candidate in enumerate(top_4_coins[:2], start=1):
    symbol = candidate['symbol']

    # holding_status에는 '활성' 상태만 저장
    db_manager.update_holding_status(symbol, {
        '관리상태': '활성',
        'GPT보유비중': 0,  # CIO가 비중 결정
    })
    logger.info(f"✅ [{i}순위] {symbol}: '활성' 상태로 holding_status에 등록")

    # [이중 편입 방지] 관심테이블에 있으면 삭제 (승격 처리)
    watchlist_coins = db_manager.get_watchlist_coins()
    if any(w['코인이름'] == symbol for w in watchlist_coins):
        db_manager.delete_from_watchlist(symbol)
        logger.info(f"   ↳ 관심테이블에서 삭제 (1-2순위 승격)")
```

**삭제 조건**:
- AI 자동편입에서 1-2순위로 선정됨
- holding_status에 '활성' 등록과 동시에 coin_watch_history에서 삭제

**동작**: ✅ 정상 작동

---

### 경로 2: CIO 평가 완료 후 승격 시 삭제 ⚠️ (버그 발견!)

**파일**: `ai_strategy/cio.py` (Lines 2548-2572)

**시점**: CIO 포트폴리오 재구성 완료 후, 관심 종목 정리 단계

**코드**:
```python
# [신규] CIO 평가 완료 후 관심 종목 정리
if watchlist_coins:
    logger.info(f"🧹 CIO 평가 완료. 관심 종목 {len(watchlist_coins)}개를 정리합니다.")
    for watch in watchlist_coins:
        symbol = watch['코인이름']

        # CIO가 이 코인을 '활성'으로 승격시켰는지 확인
        if symbol in coin_weights_to_db and coin_weights_to_db[symbol] > 0:  # ⚠️ 문제!
            logger.info(f"✅ {symbol}: '활성'으로 승격 (비중 {coin_weights_to_db[symbol]:.1f}%)")

            # holding_status에 등록 (관리상태='활성', GPT보유비중 설정)
            db_manager.update_holding_status(symbol, {
                '관리상태': '활성',
                'GPT보유비중': coin_weights_to_db[symbol],
                '보유수량': 0,
                '평가금액': 0,
                '매수금액': 0,
                '현재상태': '미보유'
            })

            # coin_watch_history에서 삭제
            db_manager.delete_from_watchlist(symbol)
        else:
            logger.info(f"⏭️ {symbol}: 승격 보류 → coin_watch_history에 유지")
```

**삭제 조건**:
- ✅ `symbol in coin_weights_to_db` (CIO가 이 코인을 분석함)
- ✅ `coin_weights_to_db[symbol] > 0` (**비중이 0%보다 커야 함**)

**문제점**:
- CIO가 관심 코인을 분석했지만 **0% 비중으로 결정**하면 삭제되지 않음!
- 결과: holding_status와 coin_watch_history에 동시 존재하는 "이중 편입" 발생

**디버깅 로그 증거** (2025-10-25 01:47:47):
```
01:47:47 | 🧹 CIO 평가 완료. 관심 종목 2개를 정리합니다.
01:47:47 | ⏭️ PROVE: 승격 보류 → coin_watch_history에 유지
01:47:47 | ⏭️ LA: 승격 보류 → coin_watch_history에 유지
```

→ PROVE와 LA가 CIO에서 **0% 비중**을 받았기 때문에 `coin_weights_to_db[symbol] > 0` 조건 실패!

---

## 🔍 LA, PROVE가 이중 편입된 시나리오 재구성

### 시나리오 1: 과거 AI 자동편입에서 1-2순위로 등록됨

**2025-10-24 이전 (추정)**:
1. AI 자동편입에서 LA 또는 PROVE가 **1-2순위**로 선정됨
2. `universe.py` Line 705-708에서 holding_status에 '활성' 등록
3. `universe.py` Line 711-715에서 coin_watch_history에서 삭제 (정상 처리)

**2025-10-25 01:43:50 (AI 자동편입)**:
1. LA, PROVE가 이번에는 **ALTERNATIVE 티어**로 분류됨
2. Absolute Rule 2 발동: VERIFIED 1개(ENA)만 선정 → LA, PROVE 탈락
3. **holding_status에는 과거 '활성' 상태 유지**
4. **coin_watch_history에는 등록 안 됨** (1-2순위 아니므로)

**2025-10-25 01:47:46 (CIO)**:
1. CIO가 LA, PROVE를 분석 대상에 포함 (holding_status '활성' 코인이므로)
2. CIO 최종 판단: LA 0%, PROVE 0% (Fear 30 → Risk Guardian → 신규 편입 제외)
3. `cio.py` Line 2555 조건 실패: `coin_weights_to_db['LA'] = 0` → `> 0` False
4. **coin_watch_history에서 삭제되지 않음!**
5. 로그: "⏭️ LA: 승격 보류 → coin_watch_history에 유지"

**현재 상태**:
- holding_status: LA, PROVE '활성' (과거 AI 편입 기록)
- coin_watch_history: LA, PROVE 존재 (**버그로 인해 삭제 안 됨**)

---

### 시나리오 2: 과거 AI 자동편입에서 3-4순위로 등록됨

**2025-10-24 이전 (추정)**:
1. AI 자동편입에서 LA 또는 PROVE가 **3-4순위**로 선정됨
2. `universe.py` Line 730-737에서 coin_watch_history에 '관심' 등록
3. holding_status에는 등록 안 됨 (3-4순위는 관심 테이블만)

**2025-10-25 01:43:50 (AI 자동편입) - 문제 발생 지점!**:
1. 이번에 LA, PROVE가 다시 **후보**로 올라옴
2. **Line 633-638 (Fix 1 로직)에서 holding_status 확인**:
   ```python
   existing_status = db_manager.get_holding_status(symbol)
   if existing_status and existing_status.get('관리상태') in ['활성', '재평가']:
       logger.info(f"⚠️ [{symbol}] CIO 관리 중인 코인 (상태: {existing_status.get('관리상태')}) → AI 검증 제외")
       continue
   ```
3. **만약 이전에 holding_status에 등록되어 있었다면** → 제외됨
4. **그런데 holding_status에 등록되어 있는 상태**라고 하셨으므로...
   → **Fix 1 로직이 작동하지 않았거나**, **다른 경로로 holding_status에 등록됨**

**추가 확인 필요**:
- LA, PROVE의 holding_status 등록 시점 확인
- '관리상태' 필드가 '활성'인지 확인

---

## 🐛 버그 원인 분석

### 버그 1: CIO 삭제 조건이 너무 엄격함

**위치**: `ai_strategy/cio.py` Line 2555

**문제**:
```python
if symbol in coin_weights_to_db and coin_weights_to_db[symbol] > 0:
    # 삭제 로직
```

**현재 로직**:
- CIO가 관심 코인에 **0% 비중**을 할당하면 coin_watch_history에서 삭제되지 않음
- 의도: "비중을 받은 코인만 승격"
- 부작용: "0% 비중 코인은 영원히 관심 테이블에 남음"

**예상 시나리오**:
1. 관심 코인이 CIO 분석 대상에 포함됨
2. CIO가 여러 이유로 0% 비중 할당 (예: Risk Guardian 모드, 120일선 이탈 등)
3. coin_watch_history에서 삭제되지 않음
4. 다음 사이클에서 또 분석 대상에 포함됨 (무한 반복)

---

### 버그 2: 관심 코인 자동 정리 로직 부재

**현재 상황**:
- coin_watch_history에 등록된 코인은 **수동 삭제하거나 CIO가 승격시키기 전까지 영원히 남음**
- 품질이 떨어진 코인, 장기간 승격되지 않은 코인 정리 로직 없음

**필요한 기능**:
- 일정 기간(예: 30일) 승격되지 않은 관심 코인 자동 삭제
- 품질 점수가 낮아진 코인 자동 삭제
- CIO가 명시적으로 "제외" 판단한 코인 삭제

---

## 💡 해결 방안

### 방안 1: CIO 삭제 조건 완화 (권장 ⭐)

**수정 위치**: `ai_strategy/cio.py` Lines 2548-2572

**현재 코드**:
```python
if symbol in coin_weights_to_db and coin_weights_to_db[symbol] > 0:
    # 승격 → holding_status 등록 + coin_watch_history 삭제
else:
    logger.info(f"⏭️ {symbol}: 승격 보류 → coin_watch_history에 유지")
```

**수정 후**:
```python
if symbol in coin_weights_to_db:
    # CIO가 이 코인을 평가함

    if coin_weights_to_db[symbol] > 0:
        # 승격: holding_status에 비중 설정 + coin_watch_history 삭제
        logger.info(f"✅ {symbol}: '활성'으로 승격 (비중 {coin_weights_to_db[symbol]:.1f}%)")

        db_manager.update_holding_status(symbol, {
            '관리상태': '활성',
            'GPT보유비중': coin_weights_to_db[symbol],
            '보유수량': 0,
            '평가금액': 0,
            '매수금액': 0,
            '현재상태': '미보유'
        })

        # coin_watch_history에서 삭제
        db_manager.delete_from_watchlist(symbol)

    else:
        # 0% 비중: 제외 판단 → coin_watch_history에서 삭제 (holding_status 등록 안 함)
        logger.info(f"❌ {symbol}: CIO 제외 판단 (0% 비중) → coin_watch_history에서 삭제")
        db_manager.delete_from_watchlist(symbol)

        # holding_status에 있으면 '제외' 상태로 변경
        existing_holding = db_manager.get_holding_status(symbol)
        if existing_holding:
            db_manager.update_holding_status(symbol, {'관리상태': '제외'})
            logger.info(f"   ↳ holding_status '제외' 상태로 변경")
else:
    # CIO가 분석하지 않은 코인 (이론상 발생 안 함)
    logger.warning(f"⚠️ {symbol}: CIO 분석 대상 아님 → coin_watch_history에 유지")
```

**효과**:
- ✅ CIO가 0% 비중 결정 시 coin_watch_history에서 삭제됨
- ✅ holding_status '제외' 상태로 변경하여 재편입 방지
- ✅ 이중 편입 문제 해결

---

### 방안 2: 관심 코인 자동 정리 스케줄러 추가

**새 함수 추가**: `supabase_adapter.py`에 `cleanup_old_watchlist()` 확장

**코드**:
```python
def cleanup_old_watchlist(self, days_threshold=30):
    """오래된 관심 종목 자동 정리

    Args:
        days_threshold: 삭제 기준 일수 (기본 30일)

    삭제 조건:
    1. 등록 후 30일 이상 경과한 코인
    2. 품질 점수가 임계값 이하로 하락한 코인
    """
    try:
        from datetime import datetime, timedelta

        cutoff_date = (datetime.now() - timedelta(days=days_threshold)).isoformat()

        # 30일 이상 된 관심 코인 조회
        old_coins = self.supabase.table('coin_watch_history')\
            .select('*')\
            .lt('added_date', cutoff_date)\
            .execute()

        if old_coins.data:
            for coin in old_coins.data:
                symbol = coin['코인이름']

                # 삭제
                self.supabase.table('coin_watch_history')\
                    .delete()\
                    .eq('코인이름', symbol)\
                    .execute()

                logger.info(f"🧹 관심 종목 자동 정리: {symbol} (등록 후 {days_threshold}일 경과)")

            logger.info(f"✅ 관심 종목 {len(old_coins.data)}개 자동 정리 완료")

        return True

    except Exception as e:
        logger.error(f"관심 종목 자동 정리 오류: {e}")
        return False
```

**호출 시점**: 매일 CIO 실행 전 또는 AI 자동편입 실행 전

---

### 방안 3: 즉시 수동 삭제 (임시 조치)

**SQL 명령어**:
```sql
-- LA, PROVE를 coin_watch_history에서 삭제
DELETE FROM coin_watch_history WHERE 코인이름 IN ('LA', 'PROVE');

-- holding_status에서 '제외' 상태로 변경
UPDATE holding_status
SET 관리상태 = '제외'
WHERE 코인이름 IN ('LA', 'PROVE');
```

**실행 방법**: Supabase 대시보드 또는 Python 스크립트

---

## 📊 삭제 로직 흐름도

```
┌─────────────────────────────────────────────────────────────┐
│ 관심 코인(coin_watch_history) 삭제 경로                      │
└─────────────────────────────────────────────────────────────┘

경로 1: AI 자동편입 1-2순위 승격
┌──────────────────┐
│ AI 자동편입 실행  │
└────────┬─────────┘
         │
         ↓
┌──────────────────────────────────────┐
│ 1-2순위로 선정된 코인 확인            │
│ (universe.py Lines 681-715)          │
└────────┬─────────────────────────────┘
         │
         ↓
┌──────────────────────────────────────┐
│ holding_status에 '활성' 등록          │
│ (GPT보유비중 = 0, CIO가 결정)         │
└────────┬─────────────────────────────┘
         │
         ↓
┌──────────────────────────────────────┐
│ watchlist_coins 조회                 │
│ if any(w['코인이름'] == symbol):     │
└────────┬─────────────────────────────┘
         │ Yes
         ↓
┌──────────────────────────────────────┐
│ ✅ delete_from_watchlist(symbol)     │
│ 로그: "관심테이블에서 삭제 (1-2순위)" │
└──────────────────────────────────────┘

경로 2: CIO 평가 완료 후 승격 (⚠️ 버그!)
┌──────────────────┐
│ CIO 실행 완료     │
└────────┬─────────┘
         │
         ↓
┌──────────────────────────────────────┐
│ watchlist_coins 조회                 │
│ (cio.py Lines 2549-2572)             │
└────────┬─────────────────────────────┘
         │
         ↓
┌──────────────────────────────────────┐
│ for watch in watchlist_coins:        │
│   symbol = watch['코인이름']          │
└────────┬─────────────────────────────┘
         │
         ↓
┌──────────────────────────────────────┐
│ if symbol in coin_weights_to_db      │
│ and coin_weights_to_db[symbol] > 0:  │ ⚠️ 문제: 0% 비중은 삭제 안 됨!
└────────┬─────────────────────────────┘
         │ Yes (비중 > 0%)
         ↓
┌──────────────────────────────────────┐
│ holding_status에 '활성' + 비중 설정   │
└────────┬─────────────────────────────┘
         │
         ↓
┌──────────────────────────────────────┐
│ ✅ delete_from_watchlist(symbol)     │
│ 로그: "활성으로 승격 (비중 X%)"       │
└──────────────────────────────────────┘

         │ No (비중 = 0%)
         ↓
┌──────────────────────────────────────┐
│ ❌ 삭제 안 됨!                        │
│ 로그: "승격 보류 → 유지"              │
└──────────────────────────────────────┘
```

---

## 🎯 최종 권장 사항

### 즉시 조치 (High Priority)

1. **방안 1 적용**: CIO 삭제 조건 완화
   - 0% 비중 코인도 coin_watch_history에서 삭제
   - holding_status '제외' 상태로 변경

2. **수동 삭제**: LA, PROVE를 coin_watch_history에서 삭제
   - 또는 CIO 재실행하여 자동 삭제 확인

### 중기 개선 (Medium Priority)

3. **방안 2 적용**: 관심 코인 자동 정리 스케줄러
   - 30일 이상 승격되지 않은 코인 자동 삭제
   - 매일 CIO 실행 전 자동 실행

### 장기 개선 (Low Priority)

4. **관심 코인 평가 시스템 개선**
   - 품질 점수 추적 및 하락 시 자동 삭제
   - CIO 평가 이력 저장 (몇 번 0% 받았는지 추적)

---

**분석 완료 일시**: 2025-10-25
**분석자**: Claude (AI Assistant)
**다음 단계**: 방안 1 코드 수정 적용
